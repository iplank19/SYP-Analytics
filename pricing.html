<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SYP Pricing Matrix - Buckeye Pacific</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1117;--panel:#181a22;--panel-alt:#1e2029;--surface:#22242e;--text:#d1d4dc;--muted:#747a8b;--border:#2a2d3a;--accent:#4d8df7;--positive:#26a69a;--negative:#ef5350;--warn:#f2ba31;--info:#4d8df7;--radius:6px;--mono:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-family:'Inter',system-ui,-apple-system,sans-serif;font-size:12px}
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);min-height:100vh}
    .login-container{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
    .login-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:40px;width:100%;max-width:380px;text-align:center}
    .login-card h1{font-size:20px;font-weight:700;color:var(--accent);margin-bottom:4px;letter-spacing:1px}
    .login-card .subtitle{font-size:11px;color:var(--muted);margin-bottom:24px}
    .login-card input{width:100%;padding:10px 14px;font-size:13px;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);outline:none;margin-bottom:12px;font-family:inherit}
    .login-card input:focus{border-color:var(--accent)}
    .login-card button{width:100%;padding:10px;font-size:13px;font-weight:600;color:#fff;background:var(--accent);border:none;border-radius:var(--radius);cursor:pointer;font-family:inherit}
    .login-card button:hover{opacity:0.9}
    .login-card .error{color:var(--negative);font-size:11px;margin-top:8px;display:none}
    .header{background:var(--panel);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:16px;font-weight:700;color:var(--accent);letter-spacing:1px}
    .header .logout{font-size:11px;color:var(--muted);cursor:pointer;text-decoration:underline}
    .header .logout:hover{color:var(--text)}
    .content{padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius)}
    .card-header{padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;border-bottom:1px solid var(--border)}
    .card-title{font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:0.5px}
    .card-body{padding:12px}
    .btn{padding:4px 10px;font-size:10px;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);color:var(--text);cursor:pointer;font-family:inherit}
    .btn:hover{border-color:var(--muted)}
    .btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-default{background:var(--surface);color:var(--text)}
    .btn-sm{padding:3px 8px;font-size:10px}
    .spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:20px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .empty-state{text-align:center;color:var(--muted);padding:40px}
    .mono{font-family:var(--mono);font-size:11px}
    .matrix-ctrl{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px;font-size:11px}
    .matrix-ctrl label{display:flex;gap:4px;align-items:center;font-size:10px;color:var(--muted);cursor:pointer}
    .matrix-ctrl select{padding:4px 8px;font-size:11px;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:var(--radius)}
    table{width:100%;font-size:11px;border-collapse:collapse}
    th,td{padding:4px 6px;border:1px solid var(--border)}
    th{background:var(--panel-alt);font-weight:600;text-align:left;position:sticky;top:0;z-index:1}
    .mill-cell{white-space:nowrap;font-weight:500;font-size:11px;padding:4px 8px;position:sticky;left:0;background:var(--panel);z-index:1}
    .empty-cell{background:var(--bg)}
    .group-start{border-left:2px solid var(--accent)!important}
    .matrix-compact td,.matrix-compact th{padding:2px 4px;font-size:10px}
    .matrix-comfortable td,.matrix-comfortable th{padding:6px 8px;font-size:12px}
    .updated{font-size:10px;color:var(--muted);text-align:right;margin-top:8px}
  </style>
</head>
<body>
  <div id="app">
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
      <div class="login-card">
        <h1>SYP ANALYTICS</h1>
        <div class="subtitle">Mill Pricing Matrix</div>
        <form onsubmit="event.preventDefault();doLogin()">
          <input type="password" id="login-password" placeholder="Enter password" autofocus>
          <button type="submit">View Pricing</button>
        </form>
        <div class="error" id="login-error">Invalid password. Please try again.</div>
      </div>
    </div>

    <!-- Matrix Screen (hidden until auth) -->
    <div id="matrix-screen" style="display:none">
      <div class="header">
        <h1>SYP PRICING MATRIX</h1>
        <div style="display:flex;align-items:center;gap:16px">
          <span id="last-updated" class="updated"></span>
          <button class="btn btn-sm" onclick="loadMatrix()">Refresh</button>
          <span class="logout" onclick="doLogout()">Logout</span>
        </div>
      </div>
      <div class="content">
        <div class="card">
          <div class="card-header">
            <span class="card-title">All Mill Prices</span>
            <div id="matrix-controls" style="display:flex;gap:4px;align-items:center"></div>
          </div>
          <div class="card-body" id="matrix-body">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let _detail = 'length';
    let _product = '';
    let _hideEmpty = true;
    let _hideMills = true;
    let _density = 'compact';

    // Auth
    async function doLogin(){
      const pw = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');
      errEl.style.display = 'none';
      try {
        const res = await fetch('/api/pricing/auth', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({password: pw})
        });
        const data = await res.json();
        if (data.ok) {
          sessionStorage.setItem('pricing_auth', '1');
          showMatrix();
        } else {
          errEl.style.display = 'block';
        }
      } catch(e) {
        errEl.textContent = 'Connection error. Please try again.';
        errEl.style.display = 'block';
      }
    }

    function doLogout(){
      sessionStorage.removeItem('pricing_auth');
      document.getElementById('login-screen').style.display = '';
      document.getElementById('matrix-screen').style.display = 'none';
    }

    function showMatrix(){
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('matrix-screen').style.display = '';
      loadMatrix();
    }

    // Check session on load
    if (sessionStorage.getItem('pricing_auth') === '1') showMatrix();

    // Matrix rendering
    async function loadMatrix(){
      const el = document.getElementById('matrix-body');
      el.innerHTML = '<div class="spinner"></div>';

      try {
        if (_detail === 'length') {
          await renderGranularMatrix(el);
        } else {
          await renderSummaryMatrix(el);
        }
        document.getElementById('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();
      } catch(e) {
        el.innerHTML = '<div class="empty-state">Error loading matrix: ' + e.message + '</div>';
      }
    }

    function renderControls(products, colCount, totalCols, millCount, totalMills){
      const ctrl = document.getElementById('matrix-controls');
      const stats = colCount != null
        ? `<span style="color:var(--muted);font-size:10px">${millCount}${totalMills && millCount!==totalMills?' of '+totalMills:''} mills &middot; ${colCount}${totalCols && colCount!==totalCols?' of '+totalCols:''} cols</span>`
        : '';

      ctrl.innerHTML = `
        <button class="btn btn-sm ${_detail==='length'?'btn-primary':'btn-default'}" onclick="_detail='length';loadMatrix()">By Length</button>
        <button class="btn btn-sm ${_detail==='product'?'btn-primary':'btn-default'}" onclick="_detail='product';_product='';loadMatrix()">By Product</button>
        ${_detail === 'length' ? `
          <select onchange="_product=this.value;loadMatrix()" style="padding:4px 8px;font-size:11px;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:var(--radius)">
            <option value="">All Products</option>
            ${(products||[]).map(p => '<option value="'+p+'"'+(_product===p?' selected':'')+'>'+p+'</option>').join('')}
          </select>
          <label style="font-size:10px;color:var(--muted);display:flex;gap:4px;align-items:center;cursor:pointer"><input type="checkbox" ${_hideEmpty?'checked':''} onchange="_hideEmpty=this.checked;loadMatrix()"> Hide empty cols</label>
          <label style="font-size:10px;color:var(--muted);display:flex;gap:4px;align-items:center;cursor:pointer"><input type="checkbox" ${_hideMills?'checked':''} onchange="_hideMills=this.checked;loadMatrix()"> Hide empty mills</label>
        ` : ''}
        <button class="btn btn-sm ${_density==='compact'?'btn-primary':'btn-default'}" onclick="_density='compact';loadMatrix()">&#9724;</button>
        <button class="btn btn-sm ${_density==='comfortable'?'btn-primary':'btn-default'}" onclick="_density='comfortable';loadMatrix()">&#9723;</button>
        <span style="margin-left:auto;display:flex;gap:12px;align-items:center">
          ${stats}
          <span style="color:var(--muted);font-size:10px">Green&rarr;Red = cheap&rarr;expensive</span>
        </span>`;
    }

    async function renderGranularMatrix(el){
      const params = new URLSearchParams({detail: 'length'});
      if (_product) params.set('product', _product);
      const res = await fetch('/api/mi/quotes/matrix?' + params);
      if (!res.ok) throw new Error('API error: ' + res.status);
      const data = await res.json();
      const { matrix, mills: allMills, columns: allColumns, products, best_by_col } = data;

      if (!allMills.length) {
        el.innerHTML = '<div class="empty-state">No mill quotes available.</div>';
        renderControls(products);
        return;
      }

      let columns = allColumns;
      if (_hideEmpty) columns = allColumns.filter(col => allMills.some(m => matrix[m] && matrix[m][col]));

      let mills = allMills;
      if (_hideMills) mills = allMills.filter(m => columns.some(col => matrix[m] && matrix[m][col]));

      const max_by_col = {};
      columns.forEach(col => {
        let maxP = 0;
        mills.forEach(m => { const d = matrix[m] && matrix[m][col]; if (d && d.price > maxP) maxP = d.price; });
        max_by_col[col] = maxP;
      });

      const colProduct = c => c.replace(/\s+\d+[\-\/\d]*['"]?$/, '').replace(/\s+RL$/, '');

      const colGroups = [];
      let currentProd = null, currentGroup = [];
      columns.forEach(c => {
        const prod = colProduct(c);
        if (prod !== currentProd) {
          if (currentGroup.length) colGroups.push({product: currentProd, cols: currentGroup});
          currentProd = prod;
          currentGroup = [c];
        } else {
          currentGroup.push(c);
        }
      });
      if (currentGroup.length) colGroups.push({product: currentProd, cols: currentGroup});

      const productHeaderCells = colGroups.map((g, gi) =>
        '<th colspan="'+g.cols.length+'" class="'+(gi>0?'group-start':'')+'" style="text-align:center;background:var(--panel-alt);border-bottom:2px solid var(--accent);font-size:11px;padding:6px 4px">'+g.product+'</th>'
      ).join('');

      const lengthHeaderCells = columns.map((c, idx) => {
        const length = c.split(/\s/).pop();
        const prod = colProduct(c);
        const prevProd = idx > 0 ? colProduct(columns[idx - 1]) : null;
        const gs = prod !== prevProd ? ' group-start' : '';
        return '<th class="'+gs+'" style="text-align:center;font-weight:400;color:var(--muted);min-width:48px">'+length+'</th>';
      }).join('');

      const bodyRows = mills.map(m => {
        const cells = columns.map((col, idx) => {
          const d = matrix[m] && matrix[m][col];
          const prod = colProduct(col);
          const prevProd = idx > 0 ? colProduct(columns[idx - 1]) : null;
          const gs = prod !== prevProd ? ' group-start' : '';

          if (!d) return '<td class="empty-cell'+gs+'"></td>';

          const isBest = d.price === best_by_col[col];
          const age = Math.floor((new Date() - new Date(d.date)) / (1000*60*60*24));
          const vol = d.volume ? d.volume + ' MBF' : '';
          const tls = d.tls ? d.tls + ' TL' : '';
          const tip = [vol, tls, d.ship_window, age + 'd ago'].filter(Boolean).join(' &middot; ');

          let heatBg = '';
          const minP = best_by_col[col] || d.price;
          const maxP = max_by_col[col] || d.price;
          if (maxP > minP) {
            const pct = (d.price - minP) / (maxP - minP);
            const hue = 120 - (pct * 120);
            heatBg = 'background:hsla('+hue+',45%,45%,0.12);';
          } else {
            heatBg = 'background:hsla(120,45%,45%,0.12);';
          }

          const fade = age > 3 ? 'opacity:0.5;' : '';
          const bestStyle = isBest ? 'color:var(--positive);font-weight:700;' : '';

          return '<td class="mono'+gs+'" style="text-align:center;'+heatBg+bestStyle+fade+'" title="'+tip+'">$'+d.price+'</td>';
        }).join('');
        return '<tr><td class="mill-cell">'+m+'</td>'+cells+'</tr>';
      }).join('');

      el.innerHTML = '<div style="overflow-x:auto;max-height:80vh;overflow-y:auto"><table class="matrix-'+_density+'" style="border-collapse:collapse"><thead style="position:sticky;top:0;z-index:2"><tr><th rowspan="2" style="position:sticky;left:0;background:var(--panel);z-index:3;padding:4px 8px">Mill</th>'+productHeaderCells+'</tr><tr>'+lengthHeaderCells+'</tr></thead><tbody>'+bodyRows+'</tbody></table></div>';

      renderControls(products, columns.length, allColumns.length, mills.length, allMills.length);
    }

    async function renderSummaryMatrix(el){
      const res = await fetch('/api/mi/quotes/matrix');
      if (!res.ok) throw new Error('API error: ' + res.status);
      const data = await res.json();
      const { matrix, mills, products, best_by_product } = data;

      if (!mills.length) {
        el.innerHTML = '<div class="empty-state">No mill quotes available.</div>';
        renderControls(products);
        return;
      }

      const headerCells = products.map(p =>
        '<th style="writing-mode:vertical-lr;text-align:center;padding:8px 4px;font-size:10px;white-space:nowrap">'+p+'</th>'
      ).join('');

      const bodyRows = mills.map(m => {
        const cells = products.map(p => {
          const d = matrix[m] && matrix[m][p];
          if (!d) return '<td style="text-align:center;color:var(--muted)">-</td>';
          const isBest = d.price === best_by_product[p];
          const age = Math.floor((new Date() - new Date(d.date)) / (1000*60*60*24));
          return '<td class="mono" style="text-align:center;'+(isBest?'color:var(--positive);font-weight:700':'')+(age>3?';opacity:0.5':'')+'" title="'+(d.ship_window||'')+' | '+(age)+'d ago">$'+d.price+'</td>';
        }).join('');
        return '<tr><td style="white-space:nowrap;font-weight:500">'+m+'</td>'+cells+'</tr>';
      }).join('');

      el.innerHTML = '<div style="overflow-x:auto"><table><thead><tr><th>Mill</th>'+headerCells+'</tr></thead><tbody>'+bodyRows+'</tbody></table></div>';
      renderControls(products);
    }

    // Auto-refresh every 5 minutes
    setInterval(() => {
      if (sessionStorage.getItem('pricing_auth') === '1') loadMatrix();
    }, 300000);
  </script>
</body>
</html>
