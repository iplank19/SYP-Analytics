<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SYP Analytics - Buckeye Pacific</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0e17;--panel:#0f1520;--panel-alt:#162231;--border:#1e3a5f;--border-light:#2d4a6f;--accent:#00d4aa;--warn:#f5a623;--negative:#ef4444;--positive:#22c55e;--info:#3b82f6;--text:#e8eaed;--muted:#6b7c93}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    body{font-family:'SF Mono','Consolas',monospace;font-size:12px;background:var(--bg);color:var(--text);overflow:hidden;height:100vh}
    #app{display:flex;height:100vh}
    .sidebar{width:200px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
    .sidebar-header{padding:20px 16px 16px;border-bottom:1px solid var(--border)}
    .logo{background:linear-gradient(135deg,var(--accent),#00a080);padding:10px;font-weight:700;font-size:14px;color:var(--bg);text-align:center}
    .company{color:var(--muted);font-size:10px;text-align:center;margin-top:8px}
    .nav{flex:1;padding:8px;overflow-y:auto}
    .nav-item{width:100%;padding:10px 12px;margin-bottom:2px;background:0;border:0;border-radius:4px;color:var(--muted);cursor:pointer;text-align:left;font-size:11px;font-family:inherit;display:flex;align-items:center;gap:10px}
    .nav-item:hover{background:var(--border);color:var(--text)}
    .nav-item.active{background:var(--border);color:var(--accent)}
    .sidebar-footer{padding:12px;border-top:1px solid var(--border)}
    .mkt-label{color:var(--muted);font-size:10px;margin-bottom:6px}
    .mkt-row{display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px}
    .mkt-row .price{font-weight:600}
    .mkt-row.west .price{color:var(--accent)}
    .mkt-row.central .price{color:var(--warn)}
    .mkt-row.east .price{color:var(--info)}
    .mkt-date{color:var(--muted);font-size:9px;margin-top:4px}
    .main{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .header{padding:12px 20px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .header-left{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
    .header h1{font-size:16px;font-weight:600}
    .filters{display:flex;gap:8px}
    .header-right{display:flex;gap:8px}
    select,input[type="text"],input[type="number"],input[type="date"],input[type="password"],textarea{padding:8px 10px;background:var(--border);border:1px solid var(--border-light);color:var(--text);font-size:11px;font-family:inherit}
    select:focus,input:focus,textarea:focus{outline:1px solid var(--accent)}
    .btn{padding:8px 16px;border:none;font-size:11px;font-weight:600;font-family:inherit;cursor:pointer}
    .btn-default{background:var(--border);color:var(--text);border:1px solid var(--border-light)}
    .btn-primary{background:var(--accent);color:var(--bg)}
    .btn-success{background:var(--positive);color:#fff}
    .btn-danger{background:transparent;color:var(--negative);border:1px solid var(--negative)}
    .btn-warn{background:var(--warn);color:var(--bg)}
    .btn-info{background:var(--info);color:var(--bg)}
    .btn-sm{padding:4px 10px;font-size:10px}
    .btn:hover{filter:brightness(1.1)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .content{flex:1;overflow:auto;padding:20px}
    .card{background:var(--panel);border:1px solid var(--border);margin-bottom:16px}
    .card-header{padding:12px 16px;background:var(--panel-alt);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .card-title{font-weight:600;font-size:11px;color:var(--accent)}
    .card-title.positive{color:var(--positive)}
    .card-title.warn{color:var(--warn)}
    .card-body{padding:16px}
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
    .kpi{background:var(--panel);border:1px solid var(--border);padding:16px}
    .kpi-label{color:var(--muted);font-size:10px;margin-bottom:6px}
    .kpi-value{font-size:20px;font-weight:700}
    .kpi-sub{color:var(--muted);font-size:11px;margin-left:8px}
    .kpi-value.positive{color:var(--positive)}
    .kpi-value.negative{color:var(--negative)}
    table{width:100%;border-collapse:collapse}
    th{padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);color:var(--muted);font-size:10px;background:var(--panel-alt)}
    th.right{text-align:right}
    td{padding:10px 12px;border-bottom:1px solid var(--border)}
    tr:nth-child(even){background:var(--panel)}
    tr:nth-child(odd){background:var(--bg)}
    td.right{text-align:right}
    td.positive{color:var(--positive)}
    td.negative{color:var(--negative)}
    td.accent{color:var(--accent)}
    td.warn{color:var(--warn)}
    td.bold{font-weight:500}
    .badge{display:inline-block;padding:2px 8px;font-size:10px;border-radius:3px}
    .badge-pending{background:rgba(245,166,35,0.2);color:var(--warn)}
    .badge-success{background:rgba(34,197,94,0.2);color:var(--positive)}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:var(--panel);border:1px solid var(--border);width:500px;max-height:90vh;display:flex;flex-direction:column}
    .modal.wide{width:700px}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-weight:600;font-size:14px;color:var(--accent)}
    .modal-title.positive{color:var(--positive)}
    .modal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer}
    .modal-body{padding:20px;overflow-y:auto;flex:1}
    .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-group{display:flex;flex-direction:column;gap:4px}
    .form-group.full{grid-column:span 2}
    .form-label{font-size:10px;color:var(--muted)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
    .grid-2-1{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    .chart-container{height:160px;display:flex;align-items:flex-end;gap:8px;padding:10px 0}
    .chart-bar-group{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
    .chart-bars{display:flex;gap:2px;align-items:flex-end;height:120px}
    .chart-bar{width:10px;border-radius:2px 2px 0 0;min-height:2px}
    .chart-bar.west{background:var(--accent)}
    .chart-bar.central{background:var(--warn)}
    .chart-bar.east{background:var(--info)}
    .chart-label{color:var(--muted);font-size:9px}
    .chart-legend{display:flex;justify-content:center;gap:16px;margin-top:8px}
    .legend-item{display:flex;align-items:center;gap:6px}
    .legend-dot{width:10px;height:10px}
    .legend-dot.west{background:var(--accent)}
    .legend-dot.central{background:var(--warn)}
    .legend-dot.east{background:var(--info)}
    .legend-text{color:var(--muted);font-size:10px}
    .progress-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
    .progress-fill{height:100%;border-radius:3px}
    .progress-fill.accent{background:var(--accent)}
    .progress-fill.warn{background:var(--warn)}
    .progress-fill.info{background:var(--info)}
    .activity-item{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .activity-main{font-weight:500}
    .activity-sub{color:var(--muted);font-size:10px;margin-top:2px}
    .activity-right{text-align:right}
    .activity-value{font-weight:500}
    .activity-value.positive{color:var(--positive)}
    .activity-value.accent{color:var(--accent)}
    .empty-state{padding:40px;text-align:center;color:var(--muted)}
    .action-buttons{display:flex;gap:4px}
    .ai-chat{display:flex;flex-direction:column;height:calc(100vh - 140px)}
    .ai-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .ai-msg{padding:12px 16px;border-radius:8px;max-width:85%;line-height:1.5;white-space:pre-wrap}
    .ai-msg.user{background:var(--accent);color:var(--bg);align-self:flex-end}
    .ai-msg.assistant{background:var(--panel-alt);border:1px solid var(--border);align-self:flex-start}
    .ai-input-area{padding:16px;border-top:1px solid var(--border);display:flex;gap:8px}
    .ai-input-area textarea{flex:1;resize:none;min-height:60px}
    .parsed-preview{background:var(--bg);border:1px solid var(--border);padding:12px;margin-top:12px;max-height:300px;overflow:auto}
    .parsed-row{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border)}
    ::-webkit-scrollbar{width:8px;height:8px}
    ::-webkit-scrollbar-track{background:var(--bg)}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
    /* Quote Engine Styles */
    .quote-grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    .quote-mode-toggle{display:flex;background:var(--panel);border:1px solid var(--border);border-radius:4px;margin-bottom:16px;overflow:hidden}
    .quote-mode-btn{flex:1;padding:12px;text-align:center;cursor:pointer;border:none;background:transparent;color:var(--muted);font-family:inherit}
    .quote-mode-btn:hover{background:var(--panel-alt)}
    .quote-mode-btn.active.known{background:var(--positive);color:#fff}
    .quote-mode-btn.active.ai{background:var(--info);color:#fff}
    .quote-mode-title{font-weight:600;font-size:12px}
    .quote-mode-desc{font-size:9px;opacity:0.8}
    .quote-stats{display:flex;gap:16px;padding:10px 16px;background:var(--panel-alt);border-bottom:1px solid var(--border)}
    .quote-stat{display:flex;align-items:baseline;gap:4px}
    .quote-stat-val{font-size:16px;font-weight:600}
    .quote-stat-lbl{font-size:9px;color:var(--muted);text-transform:uppercase}
    .quote-table{width:100%;border-collapse:collapse;font-size:11px}
    .quote-table th{padding:8px 10px;text-align:left;background:var(--panel-alt);color:var(--muted);font-size:9px;text-transform:uppercase;border-bottom:1px solid var(--border)}
    .quote-table td{padding:6px 10px;border-bottom:1px solid var(--border)}
    .quote-table tr:hover{background:var(--panel-alt)}
    .quote-table input,.quote-table select{padding:4px 6px;font-size:10px;width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text)}
    .quote-table input:focus,.quote-table select:focus{border-color:var(--accent);outline:none}
    .quote-table .col-cb{width:30px}
    .quote-table .col-prod{width:120px}
    .quote-table .col-origin{width:110px}
    .quote-table .col-num{width:55px;text-align:right}
    .quote-table .col-act{width:30px;text-align:center}
    .quote-row-short{background:rgba(59,130,246,0.08)}
    .quote-row-short input,.quote-row-short select{border-color:var(--info);background:rgba(59,130,246,0.1)}
    .short-dot{display:inline-block;width:8px;height:8px;background:var(--info);border-radius:50%;margin-right:4px}
    .quote-del-btn{background:none;border:none;color:var(--negative);cursor:pointer;font-size:14px;padding:2px 6px}
    .quote-del-btn:hover{background:rgba(239,68,68,0.2);border-radius:3px}
    .freight-panel{background:linear-gradient(135deg,rgba(245,166,35,0.1),rgba(245,166,35,0.05));border:1px solid var(--warn);border-radius:4px;padding:14px;margin-bottom:14px}
    .freight-title{font-weight:600;color:var(--warn);font-size:11px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
    .freight-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .freight-group{display:flex;flex-direction:column;gap:3px}
    .freight-lbl{font-size:9px;color:var(--muted);text-transform:uppercase}
    .lane-list{max-height:100px;overflow-y:auto;margin-top:10px;border-top:1px solid var(--border);padding-top:8px}
    .lane-item{display:flex;justify-content:space-between;padding:4px 6px;font-size:10px;cursor:pointer;border-radius:3px}
    .lane-item:hover{background:var(--panel)}
    .lane-miles{color:var(--accent);font-weight:600}
    .ai-panel{border-radius:4px;padding:14px;margin-bottom:14px}
    .ai-panel.known-mode{background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(34,197,94,0.05));border:1px solid var(--positive)}
    .ai-panel.ai-mode{background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:1px solid var(--info)}
    .ai-panel-title{font-weight:600;font-size:11px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .ai-panel-title.known{color:var(--positive)}
    .ai-panel-title.ai{color:var(--info)}
    .ai-strat{display:flex;flex-wrap:wrap;gap:6px}
    .ai-strat-btn{padding:6px 10px;background:var(--panel);border:1px solid var(--border);border-radius:3px;font-size:10px;cursor:pointer}
    .ai-strat-btn:hover{border-color:var(--accent)}
    .ai-strat-btn.active{border-color:var(--info);background:rgba(59,130,246,0.15)}
    .ai-insight{margin-top:10px;padding:10px;background:var(--panel);border-radius:4px;font-size:10px;line-height:1.5}
    .customer-list{max-height:160px;overflow-y:auto}
    .customer-item{display:flex;align-items:center;gap:6px;padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px}
    .customer-item:hover{background:var(--panel-alt)}
    .customer-info{flex:1}
    .customer-name{font-weight:500}
    .customer-dest{font-size:9px;color:var(--warn)}
    .customer-freight{text-align:right;font-size:10px}
    .customer-freight .rate{color:var(--accent);font-weight:600}
    .customer-freight .miles{font-size:9px;color:var(--muted)}
    .output-tabs{display:flex;gap:3px;margin-bottom:8px;overflow-x:auto}
    .output-tab{padding:5px 10px;font-size:10px;background:var(--panel-alt);border:1px solid var(--border);border-radius:3px 3px 0 0;cursor:pointer;white-space:nowrap}
    .output-tab:hover{border-color:var(--accent)}
    .output-tab.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
    .output-preview{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;font-size:9px;max-height:250px;overflow:auto;line-height:1.4}
    .quote-table-output{font-family:inherit}
    .quote-header{margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid var(--accent)}
    .quote-title{font-size:12px;font-weight:700;color:var(--accent);letter-spacing:0.5px}
    .quote-dest{font-size:10px;color:var(--text);margin-top:2px}
    .quote-output-table{width:100%;border-collapse:collapse;font-size:10px}
    .quote-output-table th{text-align:left;padding:4px 8px;background:var(--card);color:var(--muted);font-weight:500;font-size:9px;text-transform:uppercase;border-bottom:1px solid var(--border)}
    .quote-output-table td{padding:6px 8px;border-bottom:1px solid var(--border)}
    .quote-output-table tr:hover{background:var(--card)}
    .quote-output-table .qty{text-align:center;color:var(--muted)}
    .quote-output-table .price{text-align:right;font-weight:600;color:var(--positive)}
    .quote-output-table .ship{text-align:right;color:var(--info);font-size:9px}
    .quote-output-table .msr-row{background:rgba(255,193,7,0.1)}
    .quote-output-table .msr-row td:first-child{color:var(--warn)}
    .quote-footer{margin-top:8px;padding-top:6px;border-top:1px solid var(--border);font-size:9px;color:var(--muted);text-align:center}
    .quote-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;padding:10px;background:var(--panel);border:1px solid var(--border);border-radius:4px;flex-wrap:wrap}
    
    /* Mobile Header (hidden on desktop) */
    .mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:56px;background:var(--panel);border-bottom:1px solid var(--border);z-index:100;padding:0 16px;align-items:center;justify-content:space-between}
    .mobile-header .logo{background:linear-gradient(135deg,var(--accent),#00a080);padding:6px 12px;font-weight:700;font-size:12px;color:var(--bg)}
    .hamburger{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer;padding:8px}
    
    /* Mobile Bottom Nav (hidden on desktop) */
    .mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:64px;background:var(--panel);border-top:1px solid var(--border);z-index:100}
    .mobile-nav-items{display:flex;height:100%}
    .mobile-nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;color:var(--muted);font-size:9px;cursor:pointer;border:none;background:none}
    .mobile-nav-item.active{color:var(--accent)}
    .mobile-nav-item svg,.mobile-nav-item .nav-icon{font-size:20px}
    
    /* Mobile Sidebar Overlay */
    .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:199}
    .sidebar-overlay.open{display:block}
    
    /* Mobile Responsive */
    @media(max-width:768px){
      body{overflow:auto;height:auto;min-height:100vh}
      #app{flex-direction:column;height:auto;min-height:100vh;padding-top:56px;padding-bottom:64px}
      
      /* Show mobile elements */
      .mobile-header{display:flex}
      .mobile-nav{display:block}
      
      /* Hide desktop sidebar, show as slide-out */
      .sidebar{position:fixed;left:-260px;top:0;bottom:0;width:260px;z-index:200;transition:left 0.3s ease}
      .sidebar.open{left:0}
      
      /* Main content */
      .main{width:100%;overflow:visible}
      .header{display:none}
      .content{padding:12px;overflow:visible}
      
      /* Grids stack on mobile */
      .grid-2,.grid-3,.grid-2-1,.form-grid,.quote-grid{grid-template-columns:1fr}
      .form-group.full{grid-column:span 1}
      
      /* KPI cards */
      .kpi-grid{grid-template-columns:1fr 1fr;gap:8px}
      .kpi{padding:12px}
      .kpi-value{font-size:16px}
      
      /* Tables scroll horizontally */
      .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
      table{min-width:600px}
      th,td{padding:8px 10px;font-size:11px}
      
      /* Cards */
      .card{margin-bottom:12px}
      .card-header{padding:10px 12px;flex-wrap:wrap;gap:8px}
      .card-body{padding:12px;overflow-x:auto}
      
      /* Buttons larger for touch */
      .btn{padding:12px 16px;font-size:12px;min-height:44px}
      .btn-sm{padding:8px 12px;min-height:36px}
      select,input[type="text"],input[type="number"],input[type="date"],input[type="password"],textarea{padding:12px;font-size:14px;min-height:44px}
      
      /* Modal full screen on mobile */
      .modal{width:100%;height:100%;max-height:100%;border-radius:0}
      .modal.wide{width:100%}
      .modal-body{padding:16px}
      
      /* Quote engine */
      .quote-grid{display:flex;flex-direction:column}
      .freight-panel{padding:12px}
      .output-preview{max-height:300px}
      
      /* AI Chat */
      .ai-chat{height:calc(100vh - 180px)}
      .ai-input-area{padding:12px}
      .ai-input-area textarea{min-height:50px}
      
      /* Action buttons wrap */
      .action-buttons{flex-wrap:wrap}
      .header-right{flex-wrap:wrap;width:100%;justify-content:flex-start}
    }
    
    /* Small phones */
    @media(max-width:400px){
      .kpi-grid{grid-template-columns:1fr}
      .mobile-nav-item{font-size:8px}
      .content{padding:8px}
    }
  </style>
</head>
<body>
<!-- Mobile Header -->
<div class="mobile-header">
  <button class="hamburger" onclick="toggleMobileSidebar()">‚ò∞</button>
  <div class="logo">SYP ANALYTICS</div>
  <button class="hamburger" onclick="S.view='settings';closeMobileSidebar();render()">‚öôÔ∏è</button>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeMobileSidebar()"></div>

<!-- Mobile Bottom Nav -->
<div class="mobile-nav">
  <div class="mobile-nav-items">
    <button class="mobile-nav-item" onclick="S.view='dashboard';closeMobileSidebar();render()" id="mnav-dashboard">
      <span>üìä</span>
      <span>Dashboard</span>
    </button>
    <button class="mobile-nav-item" onclick="S.view='buys';closeMobileSidebar();render()" id="mnav-buys">
      <span>üì•</span>
      <span>Buys</span>
    </button>
    <button class="mobile-nav-item" onclick="S.view='sells';closeMobileSidebar();render()" id="mnav-sells">
      <span>üì§</span>
      <span>Sells</span>
    </button>
    <button class="mobile-nav-item" onclick="S.view='quotes';closeMobileSidebar();render()" id="mnav-quotes">
      <span>üìã</span>
      <span>Quotes</span>
    </button>
    <button class="mobile-nav-item" onclick="S.view='crm';closeMobileSidebar();render()" id="mnav-crm">
      <span>üë•</span>
      <span>CRM</span>
    </button>
  </div>
</div>

<div id="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">SYP ANALYTICS</div>
      <div class="company">Buckeye Pacific</div>
    </div>
    <nav class="nav" id="nav"></nav>
    <div class="sidebar-footer">
      <div class="mkt-label">MARKET 2x4#2</div>
      <div class="mkt-row west"><span>West</span><span class="price" id="mkt-w">‚Äî</span></div>
      <div class="mkt-row central"><span>Central</span><span class="price" id="mkt-c">‚Äî</span></div>
      <div class="mkt-row east"><span>East</span><span class="price" id="mkt-e">‚Äî</span></div>
      <div class="mkt-date" id="mkt-d"></div>
    </div>
  </aside>
  <main class="main">
    <header class="header">
      <div class="header-left">
        <h1 id="title">üìä Dashboard</h1>
        <div class="filters">
          <select id="f-date"><option value="7d">7 Days</option><option value="14d">14 Days</option><option value="30d" selected>30 Days</option><option value="90d">90 Days</option><option value="all">All Time</option></select>
          <select id="f-prod"><option value="all">All Products</option></select>
          <select id="f-reg"><option value="all">All Regions</option><option value="west">West</option><option value="central">Central</option><option value="east">East</option></select>
        </div>
      </div>
      <div class="header-right">
        <button class="btn btn-success" onclick="showBuyModal()">+ BUY</button>
        <button class="btn btn-primary" onclick="showSellModal()">+ SELL</button>
      </div>
    </header>
    <div class="content" id="content"></div>
  </main>
</div>
<div id="modal"></div>
<script>
const PRODUCTS=['2x4#2','2x6#2','2x8#2','2x10#2','2x12#2','2x4#3','2x6#3','2x8#3'];
const REGIONS=['west','central','east'];
const DESTS=['Atlanta','Charlotte','Dallas','Memphis','Birmingham','Chicago','Houston','Nashville','Jacksonville','New Orleans'];
const MILLS=['Canfor - DeQuincy','Canfor - Urbana','West Fraser - Huttig','West Fraser - Leola','Interfor - Monticello','Interfor - Georgetown','GP - Clarendon','GP - Camden','Rex Lumber - Bristol','Rex Lumber - Graceville','Weyerhaeuser - Dierks','Tolko - Leland'];
const FREIGHT={west:{Atlanta:96,Charlotte:104,Dallas:40,Memphis:60,Birmingham:85,Chicago:110,Houston:55,Nashville:78},central:{Atlanta:83,Charlotte:91,Dallas:70,Memphis:50,Birmingham:60,Chicago:90,Houston:75,Nashville:55},east:{Atlanta:60,Charlotte:55,Dallas:120,Memphis:80,Birmingham:65,Chicago:84,Houston:115,Nashville:65}};
const NAV=[{id:'dashboard',icon:'üìä',label:'Dashboard'},{id:'blotter',icon:'üìã',label:'Trade Blotter'},{id:'benchmark',icon:'üìà',label:'vs Market'},{id:'risk',icon:'‚ö†Ô∏è',label:'Risk'},{id:'quotes',icon:'üí∞',label:'Quote Engine'},{id:'products',icon:'üì¶',label:'By Product'},{id:'crm',icon:'üè¢',label:'CRM'},{id:'rldata',icon:'üì∞',label:'RL Data'},{id:'ai',icon:'ü§ñ',label:'AI Analyst'},{id:'settings',icon:'‚öôÔ∏è',label:'Settings'}];

const LS=(k,d)=>{try{const v=localStorage.getItem('syp_'+k);return v?JSON.parse(v):d}catch{return d}};
const SS=(k,v)=>{try{localStorage.setItem('syp_'+k,JSON.stringify(v))}catch{}};

// IndexedDB for larger local storage
const DB_NAME='SYPAnalytics';
const DB_VERSION=1;
let db=null;

async function initDB(){
  return new Promise((resolve,reject)=>{
    const request=indexedDB.open(DB_NAME,DB_VERSION);
    request.onerror=()=>reject(request.error);
    request.onsuccess=()=>{db=request.result;resolve(db)};
    request.onupgradeneeded=(e)=>{
      const database=e.target.result;
      if(!database.objectStoreNames.contains('data')){
        database.createObjectStore('data',{keyPath:'key'});
      }
    };
  });
}

async function dbGet(key,defaultVal){
  if(!db)await initDB();
  return new Promise((resolve)=>{
    try{
      const tx=db.transaction('data','readonly');
      const store=tx.objectStore('data');
      const request=store.get(key);
      request.onsuccess=()=>resolve(request.result?.value??defaultVal);
      request.onerror=()=>resolve(defaultVal);
    }catch{resolve(defaultVal)}
  });
}

async function dbSet(key,value){
  if(!db)await initDB();
  return new Promise((resolve)=>{
    try{
      const tx=db.transaction('data','readwrite');
      const store=tx.objectStore('data');
      store.put({key,value});
      tx.oncomplete=()=>resolve(true);
      tx.onerror=()=>resolve(false);
    }catch{resolve(false)}
  });
}

// Supabase Cloud Sync
let supabase=null;
const SUPABASE_URL=LS('supabaseUrl','');
const SUPABASE_KEY=LS('supabaseKey','');

function initSupabase(url,key){
  if(url&&key){
    // Using REST API directly instead of SDK to avoid dependencies
    supabase={url,key};
    return true;
  }
  return false;
}

async function cloudSync(action='push'){
  if(!supabase)return{success:false,error:'Supabase not configured'};
  
  const userId=LS('supabaseUserId','')||'default';
  console.log('Cloud sync:',action,'user:',userId,'url:',supabase.url);
  
  try{
    if(action==='push'){
      // Upload local data to cloud
      const data={
        buys:S.buys,
        sells:S.sells,
        rl:S.rl,
        customers:S.customers,
        mills:S.mills,
        nextId:S.nextId,
        flatRate:S.flatRate,
        // Quote engine data
        lanes:S.lanes,
        quoteItems:S.quoteItems,
        quoteProfiles:S.quoteProfiles,
        quoteProfile:S.quoteProfile,
        marketBlurb:S.marketBlurb,
        stateRates:S.stateRates,
        freightBase:S.freightBase,
        shortHaulFloor:S.shortHaulFloor,
        updated_at:new Date().toISOString()
      };
      
      console.log('Checking for existing record...');
      const res=await fetch(`${supabase.url}/rest/v1/syp_data?user_id=eq.${userId}`,{
        method:'GET',
        headers:{
          'apikey':supabase.key,
          'Authorization':`Bearer ${supabase.key}`
        }
      });
      
      if(!res.ok){
        const errText=await res.text();
        console.error('GET failed:',res.status,errText);
        return{success:false,error:`GET failed: ${res.status} ${errText}`};
      }
      
      const existing=await res.json();
      console.log('Existing records:',existing.length);
      
      let saveRes;
      if(existing&&existing.length>0){
        // Update existing record
        console.log('Updating existing record...');
        saveRes=await fetch(`${supabase.url}/rest/v1/syp_data?user_id=eq.${userId}`,{
          method:'PATCH',
          headers:{
            'apikey':supabase.key,
            'Authorization':`Bearer ${supabase.key}`,
            'Content-Type':'application/json',
            'Prefer':'return=minimal'
          },
          body:JSON.stringify({data,updated_at:new Date().toISOString()})
        });
      }else{
        // Insert new record
        console.log('Inserting new record...');
        saveRes=await fetch(`${supabase.url}/rest/v1/syp_data`,{
          method:'POST',
          headers:{
            'apikey':supabase.key,
            'Authorization':`Bearer ${supabase.key}`,
            'Content-Type':'application/json',
            'Prefer':'return=minimal'
          },
          body:JSON.stringify({user_id:userId,data,updated_at:new Date().toISOString()})
        });
      }
      
      if(!saveRes.ok){
        const errText=await saveRes.text();
        console.error('Save failed:',saveRes.status,errText);
        return{success:false,error:`Save failed: ${saveRes.status} ${errText}`};
      }
      
      console.log('Push successful!');
      return{success:true,action:'pushed'};
    }else if(action==='pull'){
      // Download cloud data to local
      const res=await fetch(`${supabase.url}/rest/v1/syp_data?user_id=eq.${userId}&select=data,updated_at`,{
        headers:{
          'apikey':supabase.key,
          'Authorization':`Bearer ${supabase.key}`
        }
      });
      const rows=await res.json();
      if(rows&&rows.length>0&&rows[0].data){
        const d=rows[0].data;
        S.buys=d.buys||[];
        S.sells=d.sells||[];
        S.rl=d.rl||[];
        S.customers=d.customers||[];
        S.mills=d.mills||[];
        S.nextId=d.nextId||1;
        S.flatRate=d.flatRate||3.50;
        // Quote engine data
        S.lanes=d.lanes||[];
        S.quoteItems=d.quoteItems||[];
        S.quoteProfiles=d.quoteProfiles||{default:{name:'Default',customers:[]}};
        S.quoteProfile=d.quoteProfile||'default';
        S.marketBlurb=d.marketBlurb||'';
        S.stateRates=d.stateRates||{AR:2.25,LA:2.25,TX:2.50,MS:2.25,AL:2.50,FL:2.75,GA:2.50,SC:2.50,NC:2.50};
        S.freightBase=d.freightBase||450;
        S.shortHaulFloor=d.shortHaulFloor||0;
        // Save to local storage too
        await saveAllLocal();
        return{success:true,action:'pulled',updated:rows[0].updated_at};
      }
      return{success:false,error:'No cloud data found'};
    }
  }catch(err){
    return{success:false,error:err.message};
  }
}

// Save all data locally (IndexedDB + localStorage backup)
async function saveAllLocal(){
  // IndexedDB (primary)
  await dbSet('buys',S.buys);
  await dbSet('sells',S.sells);
  await dbSet('rl',S.rl);
  await dbSet('customers',S.customers);
  await dbSet('mills',S.mills);
  await dbSet('nextId',S.nextId);
  await dbSet('flatRate',S.flatRate);
  await dbSet('lanes',S.lanes);
  await dbSet('quoteItems',S.quoteItems);
  await dbSet('stateRates',S.stateRates);
  await dbSet('quoteProfiles',S.quoteProfiles);
  await dbSet('quoteProfile',S.quoteProfile);
  await dbSet('marketBlurb',S.marketBlurb);
  await dbSet('freightBase',S.freightBase);
  await dbSet('shortHaulFloor',S.shortHaulFloor);
  // localStorage (backup for small data)
  SS('buys',S.buys);
  SS('sells',S.sells);
  SS('rl',S.rl);
  SS('customers',S.customers);
  SS('mills',S.mills);
  SS('nextId',S.nextId);
  SS('flatRate',S.flatRate);
  SS('lanes',S.lanes);
  SS('quoteItems',S.quoteItems);
  SS('stateRates',S.stateRates);
  SS('quoteProfiles',S.quoteProfiles);
  SS('quoteProfile',S.quoteProfile);
  SS('marketBlurb',S.marketBlurb);
  SS('freightBase',S.freightBase);
  SS('shortHaulFloor',S.shortHaulFloor);
}

// Load from IndexedDB first, fall back to localStorage
async function loadAllLocal(){
  await initDB();
  S.buys=await dbGet('buys',LS('buys',[]));
  S.sells=await dbGet('sells',LS('sells',[]));
  S.rl=await dbGet('rl',LS('rl',[]));
  S.customers=await dbGet('customers',LS('customers',[]));
  S.mills=await dbGet('mills',LS('mills',[]));
  S.nextId=await dbGet('nextId',LS('nextId',1));
  S.flatRate=await dbGet('flatRate',LS('flatRate',3.50));
  S.lanes=await dbGet('lanes',LS('lanes',[]));
  S.quoteItems=await dbGet('quoteItems',LS('quoteItems',[]));
  S.stateRates=await dbGet('stateRates',LS('stateRates',{AR:2.25,LA:2.25,TX:2.50,MS:2.25,AL:2.50,FL:2.75,GA:2.50,SC:2.50,NC:2.50}));
  S.quoteProfiles=await dbGet('quoteProfiles',LS('quoteProfiles',{default:{name:'Default',customers:[]}}));
  S.quoteProfile=await dbGet('quoteProfile',LS('quoteProfile','default'));
  S.marketBlurb=await dbGet('marketBlurb',LS('marketBlurb',''));
  S.shortHaulFloor=await dbGet('shortHaulFloor',LS('shortHaulFloor',0));
  S.freightBase=await dbGet('freightBase',LS('freightBase',450));
  S.apiKey=LS('apiKey','');
  S.aiMsgs=LS('aiMsgs',[]);
}

// Enhanced save function that saves to IndexedDB
async function save(key,value){
  S[key]=value;
  await dbSet(key,value);
  SS(key,value); // backup
  
  // Auto-sync to cloud if configured
  if(supabase&&S.autoSync){
    cloudSync('push').catch(()=>{});
  }
}

let S={
  view:'dashboard',
  filters:{date:'30d',prod:'all',reg:'all'},
  buys:LS('buys',[]),
  sells:LS('sells',[]),
  rl:LS('rl',[]),
  customers:LS('customers',[]),
  mills:LS('mills',[]),
  nextId:LS('nextId',1),
  apiKey:LS('apiKey',''),
  aiMsgs:LS('aiMsgs',[]),
  flatRate:LS('flatRate',3.50),
  autoSync:LS('autoSync',false),
  lanes:LS('lanes',[]),
  quoteItems:LS('quoteItems',[]),
  quoteMode:'known',
  quoteMBFperTL:23,
  quoteMSRFootage:false,
  stateRates:LS('stateRates',{AR:2.25,LA:2.25,TX:2.50,MS:2.25,AL:2.50,FL:2.75,GA:2.50,SC:2.50,NC:2.50}),
  quoteProfiles:LS('quoteProfiles',{default:{name:'Default',customers:[]}}),
  quoteProfile:LS('quoteProfile','default'),
  marketBlurb:LS('marketBlurb',''),
  shortHaulFloor:LS('shortHaulFloor',0),
  freightBase:LS('freightBase',450),
  singleQuoteCustomer:''
};

const fmt=(v,d=0)=>v!=null&&!isNaN(v)?`$${Number(v).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d})}`:'‚Äî';
const fmtPct=v=>v!=null&&!isNaN(v)?`${v>=0?'+':''}${Number(v).toFixed(1)}%`:'‚Äî';
const fmtD=d=>d?new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}):'‚Äî';
const today=()=>new Date().toISOString().split('T')[0];
const genId=()=>{const id=S.nextId++;SS('nextId',S.nextId);return id};

function getRange(){
  const now=new Date(),days={['7d']:7,['14d']:14,['30d']:30,['90d']:90,all:9999}[S.filters.date]||30;
  return{start:new Date(now-days*86400000),end:now};
}

function filtered(){
  const r=getRange(),inR=d=>new Date(d)>=r.start&&new Date(d)<=r.end;
  const mP=p=>S.filters.prod==='all'||p===S.filters.prod;
  const mR=rg=>S.filters.reg==='all'||rg===S.filters.reg;
  return{buys:S.buys.filter(b=>inR(b.date)&&mP(b.product)&&mR(b.region)),sells:S.sells.filter(s=>inR(s.date)&&mP(s.product))};
}

function analytics(){
  const{buys,sells}=filtered();
  const latestRL=S.rl.length?S.rl[S.rl.length-1]:null;
  const bVol=buys.reduce((s,b)=>s+(b.volume||0),0);
  const bVal=buys.reduce((s,b)=>s+(b.price||0)*(b.volume||0),0);
  const avgB=bVol?bVal/bVol:0;
  const sVol=sells.reduce((s,x)=>s+(x.volume||0),0);
  const sVal=sells.reduce((s,x)=>s+(x.price||0)*(x.volume||0),0);
  // freight is $/load, FOB = price - (freight/volume per MBF)
  const sFOB=sells.reduce((s,x)=>{
    const freightPerMBF=x.volume>0?(x.freight||0)/x.volume:0;
    return s+((x.price||0)-freightPerMBF)*(x.volume||0);
  },0);
  const avgS=sVol?sFOB/sVol:0;
  const avgFr=sVol?(sVal-sFOB)/sVol:0;
  
  // Calculate realized profit from MATCHED trades only (same orderNum)
  // Normalize order numbers to strings for matching
  const buyByOrder={};
  S.buys.forEach(b=>{
    const ord=String(b.orderNum||b.po||'').trim();
    if(ord)buyByOrder[ord]=b;
  });
  
  let matchedProfit=0,matchedVol=0,matchedBuyCost=0,matchedSellFOB=0;
  sells.forEach(s=>{
    const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
    const buy=ord?buyByOrder[ord]:null;
    if(buy){
      const buyFrtPerMBF=buy.volume>0?(buy.freight||0)/buy.volume:0;
      const totalBuyCost=((buy.price||0)+buyFrtPerMBF)*(s.volume||0);
      const sellFrtPerMBF=s.volume>0?(s.freight||0)/s.volume:0;
      const sellFOB=((s.price||0)-sellFrtPerMBF)*(s.volume||0);
      matchedProfit+=sellFOB-totalBuyCost;
      matchedVol+=s.volume||0;
      matchedBuyCost+=totalBuyCost;
      matchedSellFOB+=sellFOB;
    }
  });
  const avgMatchedBuy=matchedVol?matchedBuyCost/matchedVol:0;
  const avgMatchedSell=matchedVol?matchedSellFOB/matchedVol:0;
  const margin=avgMatchedSell-avgMatchedBuy;
  const marginPct=avgMatchedBuy?(margin/avgMatchedBuy)*100:0;
  const profit=matchedProfit;
  const inv=bVol-sVol;
  
  // Helper to find RL price for a product/region/length combo
  const findRLPrice=(rl,region,product,length,forMSR=false)=>{
    if(!rl||!region||!product)return null;
    
    // Normalize length: "16'" -> "16", "20'" -> "20"
    let normLen=(length||'').toString().replace(/[^0-9]/g,'');
    
    // For MSR/2400, look up the #1 base price for the same size/length
    let normProd=(product||'').replace(/\s+/g,'');
    if(forMSR){
      // Extract base size (e.g., "2x6MSR" -> "2x6", "2x4 2400f" -> "2x4")
      const baseMatch=normProd.match(/(\d+x\d+)/);
      if(baseMatch){
        const baseSize=baseMatch[1];
        // Try specified lengths first with #1 grade
        if(normLen&&rl.specified_lengths?.[region]?.[baseSize+'#1']?.[normLen]){
          return rl.specified_lengths[region][baseSize+'#1'][normLen];
        }
        // Try composite #1
        if(rl.composite?.[region]?.[baseSize+'#1'])return rl.composite[region][baseSize+'#1'];
        if(rl[region]?.[baseSize+'#1'])return rl[region][baseSize+'#1'];
        // Fall back to #2 if no #1
        if(normLen&&rl.specified_lengths?.[region]?.[baseSize+'#2']?.[normLen]){
          return rl.specified_lengths[region][baseSize+'#2'][normLen];
        }
      }
      return null;
    }
    
    // Standard product lookup
    if(!normProd.includes('#'))normProd+='#2';
    
    // Try specified lengths first if we have a length
    if(normLen&&rl.specified_lengths?.[region]?.[normProd]?.[normLen]){
      return rl.specified_lengths[region][normProd][normLen];
    }
    
    // Try composite prices (region.product)
    if(rl[region]?.[normProd])return rl[region][normProd];
    
    // Try composite without grade suffix for base lookup
    const baseSize=normProd.replace(/#\d/,'');
    if(rl.composite?.[region]?.[baseSize])return rl.composite[region][baseSize];
    if(rl[region]?.[baseSize])return rl[region][baseSize];
    
    // Try specified lengths with base size (no grade)
    if(normLen&&rl.specified_lengths?.[region]?.[baseSize]?.[normLen]){
      return rl.specified_lengths[region][baseSize][normLen];
    }
    
    return null;
  };
  
  // Check if product is MSR/2400
  const isMSRProduct=(prod)=>{
    const p=(prod||'').toUpperCase();
    return p.includes('MSR')||p.includes('2400');
  };
  
  const bench=buys.map(b=>{
    // Find the RL report closest to but not after the buy date
    const rl=S.rl.slice().reverse().find(r=>new Date(r.date)<=new Date(b.date));
    const isMSR=isMSRProduct(b.product);
    // For MSR, prefer stored basePrice, otherwise calculate from RL
    let rlP=null;
    if(isMSR&&b.basePrice){
      rlP=b.basePrice;
    }else{
      rlP=findRLPrice(rl,b.region,b.product,b.length,isMSR);
    }
    return{...b,rlP,diff:rlP&&!isMSR?(b.price-rlP):null,isMSR};
  });
  
  // Only include non-MSR trades in market comparison
  const standardBench=bench.filter(b=>!b.isMSR);
  const totVsRL=standardBench.filter(b=>b.diff!==null).reduce((s,b)=>s+b.diff*b.volume,0);
  const volRL=standardBench.filter(b=>b.diff!==null).reduce((s,b)=>s+b.volume,0);
  const avgVsRL=volRL?totVsRL/volRL:0;
  const byReg={west:{vol:0},central:{vol:0},east:{vol:0}};
  buys.forEach(b=>{if(byReg[b.region])byReg[b.region].vol+=b.volume||0});
  const byProd={};
  buys.forEach(b=>{if(!byProd[b.product])byProd[b.product]={bVol:0,bVal:0,sVol:0,sFOB:0};byProd[b.product].bVol+=b.volume||0;byProd[b.product].bVal+=(b.price||0)*(b.volume||0)});
  sells.forEach(x=>{if(!byProd[x.product])byProd[x.product]={bVol:0,bVal:0,sVol:0,sFOB:0};byProd[x.product].sVol+=x.volume||0;const frMBF=x.volume>0?(x.freight||0)/x.volume:0;byProd[x.product].sFOB+=((x.price||0)-frMBF)*(x.volume||0)});
  const byCust={};
  sells.forEach(x=>{if(!byCust[x.customer])byCust[x.customer]={vol:0,rev:0,fob:0,n:0};byCust[x.customer].vol+=x.volume||0;byCust[x.customer].rev+=(x.price||0)*(x.volume||0);const frMBF=x.volume>0?(x.freight||0)/x.volume:0;byCust[x.customer].fob+=((x.price||0)-frMBF)*(x.volume||0);byCust[x.customer].n++});
  const byDest={};
  sells.forEach(x=>{if(!byDest[x.destination])byDest[x.destination]={vol:0,fr:0,n:0};byDest[x.destination].vol+=x.volume||0;byDest[x.destination].fr+=(x.freight||0);byDest[x.destination].n++});
  return{buys,sells,latestRL,bVol,bVal,avgB,sVol,sVal,avgS,avgFr,margin,marginPct,profit,inv,bench,avgVsRL,totVsRL,byReg,byProd,byCust,byDest,matchedVol};
}

function renderNav(){
  document.getElementById('nav').innerHTML=NAV.map(n=>`<button class="nav-item ${S.view===n.id?'active':''}" onclick="go('${n.id}')"><span>${n.icon}</span><span>${n.label}</span></button>`).join('');
}

function renderMkt(){
  const rl=S.rl.length?S.rl[S.rl.length-1]:null;
  document.getElementById('mkt-w').textContent=rl?.west?.['2x4#2']?fmt(rl.west['2x4#2']):'‚Äî';
  document.getElementById('mkt-c').textContent=rl?.central?.['2x4#2']?fmt(rl.central['2x4#2']):'‚Äî';
  document.getElementById('mkt-e').textContent=rl?.east?.['2x4#2']?fmt(rl.east['2x4#2']):'‚Äî';
  document.getElementById('mkt-d').textContent=rl?.date||'';
}

function go(v){S.view=v;closeMobileSidebar();render()}

function render(){
  renderNav();renderMkt();
  updateMobileNav();
  const a=analytics();
  const nav=NAV.find(n=>n.id===S.view);
  document.getElementById('title').textContent=(nav?.icon||'')+' '+(nav?.label||'');
  const c=document.getElementById('content');

  if(S.view==='dashboard'){
    if(!S.buys.length&&!S.sells.length){
      c.innerHTML=`<div class="empty-state" style="padding:80px"><div style="font-size:48px;margin-bottom:20px">üìä</div><h2 style="margin-bottom:12px;color:var(--text)">Welcome to SYP Analytics</h2><p style="margin-bottom:24px">Start by adding trades or importing Random Lengths data.</p><div style="display:flex;gap:12px;justify-content:center"><button class="btn btn-success" onclick="showBuyModal()">+ Add Buy</button><button class="btn btn-primary" onclick="showSellModal()">+ Add Sell</button><button class="btn btn-warn" onclick="go('rldata')">Import RL Data</button></div></div>`;
      return;
    }
    c.innerHTML=`
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">BUY VOLUME</div><div><span class="kpi-value">${a.bVol} MBF</span><span class="kpi-sub">${fmt(a.bVal)}</span></div></div>
        <div class="kpi"><div class="kpi-label">SELL VOLUME</div><div><span class="kpi-value">${a.sVol} MBF</span><span class="kpi-sub">${fmt(a.sVal)}</span></div></div>
        <div class="kpi"><div class="kpi-label">MATCHED VOL</div><div><span class="kpi-value">${a.matchedVol} MBF</span></div></div>
        <div class="kpi"><div class="kpi-label">OPEN POSITION</div><div><span class="kpi-value ${a.inv>0?'warn':a.inv<0?'negative':''}">${a.inv} MBF</span><span class="kpi-sub">${a.inv>0?'long':a.inv<0?'short':'flat'}</span></div></div>
        <div class="kpi"><div class="kpi-label">MARGIN (MATCHED)</div><div><span class="kpi-value ${a.margin>=0?'positive':'negative'}">${fmt(Math.round(a.margin))}</span><span class="kpi-sub">${fmtPct(a.marginPct)}</span></div></div>
        <div class="kpi"><div class="kpi-label">REALIZED PROFIT</div><div><span class="kpi-value ${a.profit>=0?'positive':'negative'}">${fmt(Math.round(a.profit))}</span></div></div>
      </div>
      <div class="grid-3" style="margin-bottom:20px">
        <div class="card"><div class="card-header"><span class="card-title">POSITION vs RL</span></div><div class="card-body">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="color:var(--muted)">Avg vs Market</span><span style="font-size:18px;font-weight:700;color:${a.avgVsRL<=0?'var(--positive)':'var(--negative)'}">${a.avgVsRL<=0?'‚ñº':'‚ñ≤'} ${fmt(Math.abs(a.avgVsRL))}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Total Impact</span><span style="font-weight:600;color:${a.totVsRL<=0?'var(--positive)':'var(--negative)'}">${fmt(Math.abs(Math.round(a.totVsRL)))} ${a.totVsRL<=0?'saved':'over'}</span></div>
        </div></div>
        <div class="card"><div class="card-header"><span class="card-title">INVENTORY</span></div><div class="card-body">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="color:var(--muted)">Open Volume</span><span style="font-size:18px;font-weight:700;color:${a.inv>0?'var(--warn)':'var(--text)'}">${a.inv} MBF</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Est. Value</span><span style="font-weight:600">${fmt(Math.round(a.inv*a.avgB))}</span></div>
        </div></div>
        <div class="card"><div class="card-header"><span class="card-title warn">FREIGHT</span></div><div class="card-body">
          <div style="display:flex;justify-content:space-between;margin-bottom:12px"><span style="color:var(--muted)">Avg per MBF</span><span style="font-size:18px;font-weight:700;color:var(--warn)">${fmt(Math.round(a.avgFr))}</span></div>
          <div style="display:flex;justify-content:space-between"><span style="color:var(--muted)">Total Cost</span><span style="font-weight:600">${fmt(Math.round(a.avgFr*a.sVol))}</span></div>
        </div></div>
      </div>
      <div class="grid-2-1" style="margin-bottom:20px">
        <div class="card"><div class="card-header"><span class="card-title">PRICE TRENDS ‚Äî 2x4#2</span></div><div class="card-body">
          ${S.rl.length?`<div class="chart-container">${S.rl.slice(-8).map(r=>`<div class="chart-bar-group"><div class="chart-bars"><div class="chart-bar west" style="height:${Math.max(2,(r.west?.['2x4#2']||340)-340)*0.8}px"></div><div class="chart-bar central" style="height:${Math.max(2,(r.central?.['2x4#2']||340)-340)*0.8}px"></div><div class="chart-bar east" style="height:${Math.max(2,(r.east?.['2x4#2']||340)-340)*0.8}px"></div></div><span class="chart-label">${fmtD(r.date)}</span></div>`).join('')}</div><div class="chart-legend"><div class="legend-item"><div class="legend-dot west"></div><span class="legend-text">West</span></div><div class="legend-item"><div class="legend-dot central"></div><span class="legend-text">Central</span></div><div class="legend-item"><div class="legend-dot east"></div><span class="legend-text">East</span></div></div>`:'<div class="empty-state">No RL data yet</div>'}
        </div></div>
        <div class="card"><div class="card-header"><span class="card-title">REGION MIX</span></div><div class="card-body">
          ${a.bVol?REGIONS.map(r=>{const pct=a.bVol?(a.byReg[r].vol/a.bVol*100):0;const col={west:'accent',central:'warn',east:'info'}[r];return`<div style="margin-bottom:16px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="text-transform:uppercase;font-size:10px">${r}</span><span style="color:var(--muted);font-size:10px">${a.byReg[r].vol} MBF (${pct.toFixed(0)}%)</span></div><div class="progress-bar"><div class="progress-fill ${col}" style="width:${pct}%"></div></div></div>`}).join(''):'<div class="empty-state">No buys yet</div>'}
        </div></div>
      </div>
      <div class="grid-2">
        <div class="card"><div class="card-header"><span class="card-title positive">RECENT BUYS</span></div>
          ${a.buys.length?a.buys.slice(0,5).map(b=>`<div class="activity-item"><div><div class="activity-main">${b.product} @ ${fmt(b.price)}</div><div class="activity-sub">${b.mill} ‚Ä¢ ${b.date}</div></div><div class="activity-right"><div class="activity-value positive">${b.volume} MBF</div><span class="badge ${b.shipped?'badge-success':'badge-pending'}">${b.shipped?'Shipped':'Pending'}</span></div></div>`).join(''):'<div class="empty-state">No buys yet</div>'}
        </div>
        <div class="card"><div class="card-header"><span class="card-title">RECENT SELLS</span></div>
          ${a.sells.length?a.sells.slice(0,5).map(x=>`<div class="activity-item"><div><div class="activity-main">${x.product} @ ${fmt(x.price)} DLVD</div><div class="activity-sub">${x.customer} ‚Ä¢ ${x.destination}</div></div><div class="activity-right"><div class="activity-value accent">${x.volume} MBF</div><span class="badge ${x.delivered?'badge-success':'badge-pending'}">${x.delivered?'Delivered':'Pending'}</span></div></div>`).join(''):'<div class="empty-state">No sells yet</div>'}
        </div>
      </div>`;
  }
  else if(S.view==='blotter'){
    // Calculate sold volume per Order# - normalize to strings
    const orderSold={};
    S.sells.forEach(s=>{
      const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
      if(ord)orderSold[ord]=(orderSold[ord]||0)+(s.volume||0);
    });
    
    // Get unique values for filters
    const mills=[...new Set(S.buys.map(b=>b.mill).filter(Boolean))].sort();
    const customers=[...new Set(S.sells.map(s=>s.customer).filter(Boolean))].sort();
    const products=[...new Set([...S.buys.map(b=>b.product),...S.sells.map(s=>s.product)].filter(Boolean))].sort();
    
    // Apply blotter filters
    const bf=S.blotterFilter||{};
    let filteredBuys=a.buys;
    let filteredSells=a.sells;
    if(bf.mill)filteredBuys=filteredBuys.filter(b=>b.mill===bf.mill);
    if(bf.product){filteredBuys=filteredBuys.filter(b=>b.product===bf.product);filteredSells=filteredSells.filter(s=>s.product===bf.product);}
    if(bf.customer)filteredSells=filteredSells.filter(s=>s.customer===bf.customer);
    if(bf.showShorts){
      // Shorts = sells with orderNum that has no matching buy - normalize for comparison
      const buyOrders=new Set(S.buys.map(b=>String(b.orderNum||b.po||'').trim()).filter(Boolean));
      filteredSells=filteredSells.filter(s=>{
        const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
        return !ord||!buyOrders.has(ord);
      });
    }
    if(bf.noOrderNum){
      // Show only orders without an order number
      filteredBuys=filteredBuys.filter(b=>!String(b.orderNum||b.po||'').trim());
      filteredSells=filteredSells.filter(s=>!String(s.orderNum||s.linkedPO||s.oc||'').trim());
    }
    
    // Apply sorting
    const bs=S.blotterSort||{col:'date',dir:'desc'};
    const sortFn=(a,b,col,dir)=>{
      let av=a[col],bv=b[col];
      if(col==='date'){av=new Date(av||0);bv=new Date(bv||0);}
      if(col==='orderNum'){av=a.orderNum||a.po||a.oc||a.linkedPO||'';bv=b.orderNum||b.po||b.oc||b.linkedPO||'';}
      if(typeof av==='string')av=av.toLowerCase();
      if(typeof bv==='string')bv=bv.toLowerCase();
      if(av<bv)return dir==='asc'?-1:1;
      if(av>bv)return dir==='asc'?1:-1;
      return 0;
    };
    filteredBuys=[...filteredBuys].sort((a,b)=>sortFn(a,b,bs.col,bs.dir));
    filteredSells=[...filteredSells].sort((a,b)=>sortFn(a,b,bs.col,bs.dir));
    
    const sortIcon=(col)=>bs.col===col?(bs.dir==='asc'?'‚ñ≤':'‚ñº'):'';
    const sortClick=(col)=>`onclick="toggleSort('${col}')"style="cursor:pointer"`;
    
    // Build order lookup for sells - normalize to strings for matching
    const buyByOrder={};
    S.buys.forEach(b=>{
      const ord=String(b.orderNum||b.po||'').trim();
      if(ord)buyByOrder[ord]=b;
    });
    
    c.innerHTML=`
      <div class="card" style="margin-bottom:16px;padding:12px">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <span style="color:var(--muted);font-size:11px">FILTERS:</span>
          <select onchange="setBlotterFilter('mill',this.value)" style="font-size:11px;padding:4px">
            <option value="">All Mills</option>${mills.map(m=>`<option value="${m}" ${bf.mill===m?'selected':''}>${m}</option>`).join('')}
          </select>
          <select onchange="setBlotterFilter('customer',this.value)" style="font-size:11px;padding:4px">
            <option value="">All Customers</option>${customers.map(c=>`<option value="${c}" ${bf.customer===c?'selected':''}>${c}</option>`).join('')}
          </select>
          <select onchange="setBlotterFilter('product',this.value)" style="font-size:11px;padding:4px">
            <option value="">All Products</option>${products.map(p=>`<option value="${p}" ${bf.product===p?'selected':''}>${p}</option>`).join('')}
          </select>
          <label style="font-size:11px"><input type="checkbox" ${bf.showShorts?'checked':''} onchange="setBlotterFilter('showShorts',this.checked)"> Shorts only</label>
          <label style="font-size:11px;color:var(--warn)"><input type="checkbox" ${bf.noOrderNum?'checked':''} onchange="setBlotterFilter('noOrderNum',this.checked)"> No Order #</label>
          <button class="btn btn-default btn-sm" onclick="clearBlotterFilters()">Clear</button>
        </div>
      </div>
      <div class="card"><div class="card-header"><span class="card-title positive">BUYS</span><span style="color:var(--muted);font-size:10px;margin-left:8px">${filteredBuys.length} trades</span><button class="btn btn-default btn-sm" onclick="expCSV('buys')">Export CSV</button></div>
        <div style="overflow-x:auto"><table><thead><tr><th ${sortClick('orderNum')}>Order # ${sortIcon('orderNum')}</th><th ${sortClick('date')}>Date ${sortIcon('date')}</th><th ${sortClick('mill')}>Mill ${sortIcon('mill')}</th><th>Origin</th><th>Reg</th><th ${sortClick('product')}>Product ${sortIcon('product')}</th><th>Len</th><th class="right" ${sortClick('price')}>Price ${sortIcon('price')}</th><th class="right">Frt</th><th class="right" ${sortClick('volume')}>Vol ${sortIcon('volume')}</th><th class="right">Sold</th><th class="right">Avail</th><th></th></tr></thead><tbody>
          ${filteredBuys.length?filteredBuys.map(b=>{const ord=String(b.orderNum||b.po||'').trim();const sold=orderSold[ord]||0;const avail=(b.volume||0)-sold;const buyFrtMBF=b.volume>0?(b.freight||0)/b.volume:0;return`<tr><td class="bold accent">${ord||'‚Äî'}</td><td>${fmtD(b.date)}</td><td>${b.mill||'‚Äî'}</td><td>${b.origin||'‚Äî'}</td><td style="text-transform:capitalize">${b.region}</td><td class="bold">${b.product}${b.msrPremium?' <span style="color:var(--accent);font-size:9px">+'+b.msrPremium+'</span>':''}</td><td>${b.length||'RL'}${b.tally?' <span style="color:var(--warn);font-size:9px">T</span>':''}</td><td class="right positive">${fmt(b.price)}${b.freight?' <span style="color:var(--muted);font-size:9px">FOB</span>':''}</td><td class="right ${b.freight?'warn':''}">${b.freight?fmt(b.freight):'‚Äî'}</td><td class="right">${b.volume}</td><td class="right ${sold>0?'warn':''}">${sold}</td><td class="right ${avail>0?'positive':''}">${avail}</td><td><div class="action-buttons"><button class="btn btn-default btn-sm" onclick="editBuy(${b.id})">Edit</button><button class="btn btn-default btn-sm" onclick="dupBuy(${b.id})">‚ßâ</button><button class="btn btn-danger btn-sm" onclick="delBuy(${b.id})">√ó</button></div></td></tr>`}).join(''):'<tr><td colspan="13" class="empty-state">No buys</td></tr>'}
        </tbody></table></div></div>
      <div class="card"><div class="card-header"><span class="card-title">SELLS</span><span style="color:var(--muted);font-size:10px;margin-left:8px">${filteredSells.length} trades</span><button class="btn btn-default btn-sm" onclick="expCSV('sells')">Export CSV</button></div>
        <div style="overflow-x:auto"><table><thead><tr><th ${sortClick('orderNum')}>Order # ${sortIcon('orderNum')}</th><th ${sortClick('date')}>Date ${sortIcon('date')}</th><th ${sortClick('customer')}>Customer ${sortIcon('customer')}</th><th>Dest</th><th ${sortClick('product')}>Product ${sortIcon('product')}</th><th>Len</th><th class="right" ${sortClick('price')}>DLVD ${sortIcon('price')}</th><th class="right">Frt</th><th class="right">Frt/MBF</th><th class="right">Margin</th><th class="right" ${sortClick('volume')}>Vol ${sortIcon('volume')}</th><th class="right">Profit</th><th></th></tr></thead><tbody>
          ${filteredSells.length?filteredSells.map(x=>{
            const ord=String(x.orderNum||x.linkedPO||x.oc||'').trim();
            const buy=ord?buyByOrder[ord]:null;
            const buyCost=buy?.price||0;
            const buyFrtPerMBF=buy?.volume>0?(buy?.freight||0)/buy.volume:0;
            const sellFrtPerMBF=x.volume>0?(x.freight||0)/x.volume:0;
            const fob=(x.price||0)-sellFrtPerMBF;
            const totalCost=buyCost+buyFrtPerMBF; // Include buy freight in cost
            const margin=buy?fob-totalCost:null;
            const profit=margin!==null?margin*(x.volume||0):null;
            const isShort=!buy;
            return`<tr><td class="bold ${isShort?'negative':'accent'}">${ord||'‚Äî'}${isShort?' <span style="font-size:9px">(SHORT)</span>':''}</td><td>${fmtD(x.date)}</td><td>${x.customer||'‚Äî'}</td><td>${x.destination||'‚Äî'}</td><td class="bold">${x.product}${x.msrPremium?' <span style="color:var(--accent);font-size:9px">+'+x.msrPremium+'</span>':''}</td><td>${x.length||'RL'}${x.tally?' <span style="color:var(--warn);font-size:9px">T</span>':''}</td><td class="right accent">${fmt(x.price)}</td><td class="right warn">${fmt(x.freight)}</td><td class="right" style="color:var(--muted)">${fmt(Math.round(sellFrtPerMBF))}</td><td class="right ${margin===null?'':margin>=0?'positive':'negative'} bold">${margin!==null?fmt(Math.round(margin)):'‚Äî'}</td><td class="right">${x.volume}</td><td class="right ${profit===null?'':profit>=0?'positive':'negative'} bold">${profit!==null?fmt(Math.round(profit)):'‚Äî'}</td><td><div class="action-buttons"><button class="btn btn-default btn-sm" onclick="editSell(${x.id})">Edit</button><button class="btn btn-default btn-sm" onclick="dupSell(${x.id})">‚ßâ</button><button class="btn btn-danger btn-sm" onclick="delSell(${x.id})">√ó</button></div></td></tr>`}).join(''):'<tr><td colspan="13" class="empty-state">No sells</td></tr>'}
        </tbody></table></div></div>`;
  }
  else if(S.view==='benchmark'){
    // Filter out MSR/2400 from market comparison (they're premiums)
    const standardBench=a.bench.filter(b=>!b.isMSR);
    const msrBench=a.bench.filter(b=>b.isMSR);
    
    c.innerHTML=`
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">AVG vs MARKET</div><div><span class="kpi-value ${a.avgVsRL<=0?'positive':'negative'}">${a.avgVsRL<=0?'‚ñº':'‚ñ≤'} ${fmt(Math.abs(a.avgVsRL))}</span><span class="kpi-sub">/MBF</span></div></div>
        <div class="kpi"><div class="kpi-label">TRADES ANALYZED</div><div><span class="kpi-value">${standardBench.filter(b=>b.rlP).length}/${standardBench.length}</span></div></div>
        <div class="kpi"><div class="kpi-label">MSR/2400 TRADES</div><div><span class="kpi-value accent">${msrBench.length}</span></div></div>
      </div>
      <div class="card"><div class="card-header"><span class="card-title">STANDARD GRADES vs RANDOM LENGTHS</span><span style="color:var(--muted);font-size:10px">Latest RL: ${a.latestRL?.date||'None'}</span></div>
        <div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Mill</th><th>Product</th><th>Len</th><th>Region</th><th class="right">Your Price</th><th class="right">RL #1</th><th class="right">Diff</th><th class="right">Volume</th></tr></thead><tbody>
          ${standardBench.length?standardBench.map(b=>`<tr><td>${fmtD(b.date)}</td><td>${b.mill||'‚Äî'}</td><td class="bold">${b.product}</td><td>${b.length||'RL'}</td><td style="text-transform:capitalize">${b.region}</td><td class="right">${fmt(b.price)}</td><td class="right" style="color:var(--muted)">${b.rlP?fmt(b.rlP):'<span style="color:var(--negative)">No match</span>'}</td><td class="right ${b.diff==null?'':b.diff<=0?'positive':'negative'} bold">${b.diff!=null?`${b.diff<=0?'':'+'}${fmt(b.diff)}`:'‚Äî'}</td><td class="right">${b.volume} MBF</td></tr>`).join(''):'<tr><td colspan="9" class="empty-state">No standard grade buys to analyze</td></tr>'}
        </tbody></table></div>
        ${standardBench.some(b=>!b.rlP)?`<div style="padding:12px;color:var(--muted);font-size:10px;border-top:1px solid var(--border)">üí° "No match" means the product/length/region combo wasn't found in RL data.</div>`:''}
      </div>
      ${msrBench.length?`<div class="card"><div class="card-header"><span class="card-title accent">MSR / 2400f TRADES (Premium over #1)</span></div>
        <div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Mill</th><th>Product</th><th>Len</th><th>Region</th><th class="right">Your Price</th><th class="right">Base #1</th><th class="right">Premium</th><th class="right">Volume</th></tr></thead><tbody>
          ${msrBench.map(b=>`<tr><td>${fmtD(b.date)}</td><td>${b.mill||'‚Äî'}</td><td class="bold accent">${b.product}</td><td>${b.length||'RL'}</td><td style="text-transform:capitalize">${b.region}</td><td class="right">${fmt(b.price)}</td><td class="right" style="color:var(--muted)">${b.basePrice?fmt(b.basePrice):(b.rlP?fmt(b.rlP):'‚Äî')}</td><td class="right accent bold">${b.msrPremium?'+'+fmt(b.msrPremium):(b.rlP?'+'+fmt(b.price-b.rlP):'‚Äî')}</td><td class="right">${b.volume} MBF</td></tr>`).join('')}
        </tbody></table></div>
        <div style="padding:12px;color:var(--muted);font-size:10px;border-top:1px solid var(--border)">MSR/2400 prices shown as premium over #1 base price. These do not affect market comparison metrics.</div>
      </div>`:''}`
  }
  else if(S.view==='risk'){
    // Calculate positions by product (bought vs sold)
    // Normalize lengths by removing apostrophes for consistent matching
    const normLen=l=>String(l||'RL').replace(/'/g,'');
    const positions={};
    S.buys.forEach(b=>{
      const len=normLen(b.length);
      const key=`${b.product}|${len}`;
      if(!positions[key])positions[key]={product:b.product,length:len,bought:0,sold:0,boughtVal:0,soldVal:0};
      positions[key].bought+=b.volume||0;
      positions[key].boughtVal+=(b.price||0)*(b.volume||0);
    });
    S.sells.forEach(s=>{
      const len=normLen(s.length);
      const key=`${s.product}|${len}`;
      if(!positions[key])positions[key]={product:s.product,length:len,bought:0,sold:0,boughtVal:0,soldVal:0};
      positions[key].sold+=s.volume||0;
      // freight is $/load, so FOB = sell price - (freight/volume)
      const freightPerMBF=s.volume>0?(s.freight||0)/s.volume:0;
      positions[key].soldVal+=((s.price||0)-freightPerMBF)*(s.volume||0);
    });
    
    // Split into long (bought > sold) and short (sold > bought)
    const longPos=Object.values(positions).filter(p=>p.bought>p.sold).map(p=>({...p,net:p.bought-p.sold,avgCost:p.bought?p.boughtVal/p.bought:0}));
    const shortPos=Object.values(positions).filter(p=>p.sold>p.bought).map(p=>({...p,net:p.sold-p.bought,avgSell:p.sold?p.soldVal/p.sold:0}));
    
    // Calculate matched profit (orders with matching buy)
    // Build lookup of buys by orderNum - normalize to strings for matching
    const buyByOrder={};
    S.buys.forEach(b=>{
      const ord=String(b.orderNum||b.po||'').trim();
      if(ord)buyByOrder[ord]=b;
    });
    
    const matchedTrades=S.sells.map(s=>{
      const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
      const buy=ord?buyByOrder[ord]:null;
      if(!buy)return null;
      const buyCost=buy.price||0;
      const buyFrtPerMBF=buy.volume>0?(buy.freight||0)/buy.volume:0;
      const totalCost=buyCost+buyFrtPerMBF; // Include buy freight in cost
      const sellFrtPerMBF=s.volume>0?(s.freight||0)/s.volume:0;
      const fob=(s.price||0)-sellFrtPerMBF;
      const margin=fob-totalCost;
      const profit=margin*(s.volume||0);
      return{sell:s,buy,ord,buyCost,buyFrtPerMBF,totalCost,fob,sellFrtPerMBF,margin,profit};
    }).filter(Boolean);
    
    const totalMatchedProfit=matchedTrades.reduce((sum,t)=>sum+t.profit,0);
    const totalMatchedVol=matchedTrades.reduce((sum,t)=>sum+t.sell.volume,0);
    const avgMatchedMargin=totalMatchedVol?totalMatchedProfit/totalMatchedVol:0;
    
    const totalLong=longPos.reduce((s,p)=>s+p.net,0);
    const totalShort=shortPos.reduce((s,p)=>s+p.net,0);
    
    c.innerHTML=`
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-label">LONG EXPOSURE</div><div><span class="kpi-value ${totalLong>0?'warn':''}">${totalLong} MBF</span></div></div>
        <div class="kpi"><div class="kpi-label">SHORT EXPOSURE</div><div><span class="kpi-value ${totalShort>0?'negative':''}">${totalShort} MBF</span></div></div>
        <div class="kpi"><div class="kpi-label">MATCHED PROFIT</div><div><span class="kpi-value ${totalMatchedProfit>=0?'positive':'negative'}">${fmt(Math.round(totalMatchedProfit))}</span></div></div>
        <div class="kpi"><div class="kpi-label">AVG MARGIN (MATCHED)</div><div><span class="kpi-value ${avgMatchedMargin>=0?'positive':'negative'}">${fmt(Math.round(avgMatchedMargin))}</span><span class="kpi-sub">/MBF</span></div></div>
      </div>
      <div class="grid-2">
        <div class="card"><div class="card-header"><span class="card-title warn">LONG POSITIONS</span><span style="color:var(--muted);font-size:10px">Bought more than sold</span></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Product</th><th>Length</th><th class="right">Bought</th><th class="right">Sold</th><th class="right">Net Long</th><th class="right">Avg Cost</th><th class="right">Exposure</th><th></th></tr></thead><tbody>
            ${longPos.length?longPos.sort((a,b)=>b.net-a.net).map(p=>{const prodEsc=(p.product||'').replace(/'/g,"\\'");const lenEsc=(p.length||'').replace(/'/g,"\\'");return`<tr><td class="bold">${p.product}</td><td>${p.length}</td><td class="right">${p.bought} MBF</td><td class="right">${p.sold} MBF</td><td class="right warn bold">${p.net} MBF</td><td class="right">${fmt(Math.round(p.avgCost))}</td><td class="right">${fmt(Math.round(p.net*p.avgCost))}</td><td><button class="btn btn-primary btn-sm" onclick="sellPosition('${prodEsc}','${lenEsc}',${p.net})">Sell</button></td></tr>`}).join(''):'<tr><td colspan="8" class="empty-state">No long positions</td></tr>'}
          </tbody></table></div></div>
        <div class="card"><div class="card-header"><span class="card-title negative">SHORT POSITIONS</span><span style="color:var(--muted);font-size:10px">Sold more than bought</span></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Product</th><th>Length</th><th class="right">Bought</th><th class="right">Sold</th><th class="right">Net Short</th><th class="right">Avg Sell</th><th class="right">Exposure</th><th></th></tr></thead><tbody>
            ${shortPos.length?shortPos.sort((a,b)=>b.net-a.net).map(p=>{const prodEsc=(p.product||'').replace(/'/g,"\\'");const lenEsc=(p.length||'').replace(/'/g,"\\'");return`<tr><td class="bold">${p.product}</td><td>${p.length}</td><td class="right">${p.bought} MBF</td><td class="right">${p.sold} MBF</td><td class="right negative bold">${p.net} MBF</td><td class="right">${fmt(Math.round(p.avgSell))}</td><td class="right">${fmt(Math.round(p.net*p.avgSell))}</td><td><button class="btn btn-success btn-sm" onclick="coverPosition('${prodEsc}','${lenEsc}',${p.net})">Cover</button></td></tr>`}).join(''):'<tr><td colspan="8" class="empty-state">No short positions</td></tr>'}
          </tbody></table></div></div>
      </div>
      <div class="card" style="margin-top:16px"><div class="card-header"><span class="card-title positive">MATCHED TRADES (REALIZED P&L)</span></div>
        <div style="overflow-x:auto"><table><thead><tr><th>Order #</th><th>Product</th><th>Customer</th><th class="right">Buy FOB</th><th class="right">Buy Frt</th><th class="right">Total Cost</th><th class="right">Sell FOB</th><th class="right">Margin</th><th class="right">Vol</th><th class="right">Profit</th></tr></thead><tbody>
          ${matchedTrades.length?matchedTrades.map(t=>`<tr><td class="bold accent">${t.ord}</td><td>${t.sell.product}</td><td>${t.sell.customer||'‚Äî'}</td><td class="right">${fmt(t.buyCost)}</td><td class="right ${t.buyFrtPerMBF?'warn':''}">${t.buyFrtPerMBF?fmt(Math.round(t.buyFrtPerMBF)):'‚Äî'}</td><td class="right">${fmt(Math.round(t.totalCost))}</td><td class="right">${fmt(Math.round(t.fob))}${t.sellFrtPerMBF?' <span style="color:var(--warn);font-size:9px">-'+Math.round(t.sellFrtPerMBF)+'</span>':''}</td><td class="right ${t.margin>=0?'positive':'negative'} bold">${fmt(Math.round(t.margin))}</td><td class="right">${t.sell.volume} MBF</td><td class="right ${t.profit>=0?'positive':'negative'} bold">${fmt(Math.round(t.profit))}</td></tr>`).join(''):'<tr><td colspan="10" class="empty-state">No matched trades. Use same Order # on buy and sell.</td></tr>'}
        </tbody></table></div></div>`;
  }
  else if(S.view==='quotes'){
    // Quote Engine View
    const latestRL=S.rl.length?S.rl[S.rl.length-1]:null;
    const mills=S.mills.length?S.mills:MILLS.map(m=>({name:m,location:m.includes('DeQuincy')||m.includes('Urbana')?'DeQuincy, LA':m.includes('Huttig')?'Huttig, AR':m.includes('Leola')?'Leola, AR':m.includes('Monticello')?'Monticello, AR':m.includes('Georgetown')?'Georgetown, SC':m.includes('Clarendon')?'Clarendon, NC':m.includes('Camden')?'Camden, AR':m.includes('Bristol')?'Bristol, FL':m.includes('Graceville')?'Graceville, FL':m.includes('Dierks')?'Dierks, AR':m.includes('Leland')?'Leland, MS':'Warren, AR'}));
    const defaultOrigins=['Warren, AR','Gurdon, AR','Camden, AR','Monticello, AR','Clarendon, NC','Huttig, AR','DeQuincy, LA'];
    const origins=[...new Set([...defaultOrigins,...mills.map(m=>m.location||m.city||'').filter(Boolean)])];
    
    // Get customers for current profile
    const currentProfile=S.quoteProfile||'default';
    const profiles=S.quoteProfiles||{default:{name:'Default',customers:[]}};
    const profileCustomerIds=profiles[currentProfile]?.customers||[];
    const customers=S.customers.filter(c=>c.type!=='mill');
    
    // Calculate stats
    const items=S.quoteItems||[];
    const selectedItems=items.filter(i=>i.selected!==false);
    const knownItems=selectedItems.filter(i=>!i.isShort);
    const shortItems=selectedItems.filter(i=>i.isShort);
    const totalTLs=selectedItems.reduce((s,i)=>s+(i.tls||0),0);
    const avgMargin=selectedItems.length?selectedItems.reduce((s,i)=>s+((i.fob||0)-(i.cost||0)),0)/selectedItems.length:0;
    
    c.innerHTML=`
      <!-- Profile Selector -->
      <div class="card" style="margin-bottom:12px;padding:10px">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <span style="font-weight:600;color:var(--accent)">üìÅ Profile:</span>
          <select id="quote-profile-select" onchange="switchQuoteProfile(this.value)" style="padding:6px 10px;min-width:150px">
            ${Object.entries(profiles).map(([id,p])=>`<option value="${id}" ${id===currentProfile?'selected':''}>${p.name}</option>`).join('')}
          </select>
          <button class="btn btn-default btn-sm" onclick="showNewProfileModal()">+ New Profile</button>
          <button class="btn btn-default btn-sm" onclick="editCurrentProfile()">‚úèÔ∏è Edit</button>
          ${currentProfile!=='default'?'<button class="btn btn-default btn-sm" onclick="deleteCurrentProfile()" style="color:var(--negative)">üóëÔ∏è</button>':''}
          <div style="flex:1"></div>
          <span style="font-size:10px;color:var(--muted)">${profiles[currentProfile]?.items?.length||items.length} products ‚Ä¢ ${profileCustomerIds.length||customers.filter(c=>c.quoteSelected).length} customers</span>
        </div>
      </div>
      
      <div class="quote-grid">
        <div>
          <div class="quote-toolbar">
            <span style="font-weight:600;color:var(--accent)">üìã Quote Builder</span>
            <div style="flex:1"></div>
            <button class="btn btn-success btn-sm" onclick="addQuoteItem(false)">+ Add</button>
            <button class="btn btn-info btn-sm" onclick="addQuoteItem(true)" title="Add short/spec position">+ Short</button>
            <button class="btn btn-default btn-sm" onclick="loadFromInventory()">üì¶ Inventory</button>
            <button class="btn btn-warn btn-sm" onclick="aiPriceSelected()" title="AI suggest prices based on RL">ü§ñ AI Price</button>
            <button class="btn btn-default btn-sm" onclick="clearQuoteItems()">Clear</button>
          </div>
          
          <div class="card">
            <div class="quote-stats">
              <div class="quote-stat"><span class="quote-stat-val">${selectedItems.length}</span><span class="quote-stat-lbl">Items</span></div>
              <div class="quote-stat"><span class="quote-stat-val" style="color:var(--info)">${shortItems.length}</span><span class="quote-stat-lbl">Shorts</span></div>
              <div class="quote-stat"><span class="quote-stat-val">${totalTLs}</span><span class="quote-stat-lbl">TLs</span></div>
              <div class="quote-stat"><span class="quote-stat-val">${S.lanes.length}</span><span class="quote-stat-lbl">Lanes</span></div>
            </div>
            <div style="overflow-x:auto;max-height:400px;overflow-y:auto">
              <table class="quote-table">
                <thead><tr>
                  <th class="col-cb"><input type="checkbox" ${selectedItems.length===items.length?'checked':''} onchange="toggleAllQuoteItems(this.checked)"></th>
                  <th class="col-prod">Product</th>
                  <th class="col-origin">Origin</th>
                  <th style="width:55px">Ship Wk</th>
                  <th style="width:45px">TLs</th>
                  <th style="width:70px">RL Mkt</th>
                  <th style="width:70px">Sell</th>
                  <th class="col-act"></th>
                </tr></thead>
                <tbody id="quote-items-body">
                  ${items.length?items.map((item,idx)=>{
                    const parsed=parseProductString(item.product);
                    const originRegion=getRegionFromOrigin(item.origin);
                    const rlPrice=latestRL?getRLPrice(latestRL,parsed.base,parsed.length,originRegion):null;
                    const regionLabel={west:'W',central:'C',east:'E'}[originRegion]||'?';
                    return`<tr class="${item.isShort?'quote-row-short':''}" data-idx="${idx}">
                      <td><input type="checkbox" ${item.selected!==false?'checked':''} onchange="toggleQuoteItem(${idx},this.checked)"></td>
                      <td>${item.isShort?'<span class="short-dot" title="Short position"></span>':''}<input type="text" value="${item.product||''}" onchange="updateQuoteItem(${idx},'product',this.value)" placeholder="2x4 #2 16'"></td>
                      <td><input type="text" value="${item.origin||''}" onchange="updateQuoteItem(${idx},'origin',this.value)" placeholder="City, ST" list="origin-list"></td>
                      <td><input type="text" value="${item.shipWeek||''}" onchange="updateQuoteItem(${idx},'shipWeek',this.value)" placeholder="W1" style="width:45px;text-align:center"></td>
                      <td><input type="number" value="${item.tls||1}" onchange="updateQuoteItem(${idx},'tls',+this.value)" min="1" style="width:40px;text-align:center"></td>
                      <td style="text-align:right;font-size:10px"><span style="color:var(--muted)">${regionLabel}:</span> <span style="color:var(--accent)">${rlPrice?'$'+rlPrice:'‚Äî'}</span></td>
                      <td><input type="number" value="${item.fob||''}" onchange="updateQuoteItem(${idx},'fob',+this.value)" placeholder="$" style="width:60px"></td>
                      <td><button class="quote-del-btn" onclick="removeQuoteItem(${idx})">√ó</button></td>
                    </tr>`;
                  }).join(''):'<tr><td colspan="8" class="empty-state">No items yet. Click "+ Add Item" to start.</td></tr>'}
                </tbody>
              </table>
              <datalist id="origin-list">
                ${origins.map(o=>`<option value="${o}">`).join('')}
                ${S.lanes.map(l=>`<option value="${l.origin}">`).join('')}
              </datalist>
          </div>
        </div>
        
        <div>
          <!-- Freight Panel with Base + State Rate Model -->
          <div class="freight-panel">
            <div class="freight-title">üöö Freight Calculator</div>
            
            <!-- Base and Floor -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
              <div>
                <label style="font-size:9px;color:var(--muted);display:block;margin-bottom:2px">Base $/Load</label>
                <input type="number" value="${S.freightBase||450}" step="25" style="width:100%;padding:4px;font-size:11px" onchange="S.freightBase=+this.value;save('freightBase',S.freightBase);render()">
              </div>
              <div>
                <label style="font-size:9px;color:var(--muted);display:block;margin-bottom:2px">Floor $/MBF</label>
                <input type="number" value="${S.shortHaulFloor||0}" step="5" style="width:100%;padding:4px;font-size:11px" onchange="S.shortHaulFloor=+this.value;save('shortHaulFloor',S.shortHaulFloor);render()">
              </div>
            </div>
            
            <!-- State Rates ($/mi by origin) -->
            <div style="margin-bottom:10px">
              <label style="font-size:9px;color:var(--muted);display:block;margin-bottom:4px">State $/mi Rates (by origin)</label>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
                ${['AR','LA','TX','MS','AL','FL','GA','SC','NC'].map(st=>`<div style="display:flex;align-items:center;gap:4px">
                  <span style="font-size:10px;color:var(--muted);width:22px">${st}</span>
                  <input type="number" value="${S.stateRates?.[st]||''}" step="0.05" placeholder="0" style="width:50px;padding:4px;font-size:10px" onchange="updateStateRate('${st}',+this.value||0)">
                </div>`).join('')}
              </div>
            </div>
            
            <div style="font-size:9px;color:var(--muted);margin-bottom:8px;padding:6px;background:var(--bg);border-radius:4px">
              <strong>Formula:</strong> (Base + Miles √ó StateRate) √∑ MBF/TL<br>
              <span style="color:var(--accent)">AR 150mi:</span> ($${S.freightBase||450} + 150 √ó $${S.stateRates?.AR||0}) √∑ ${S.quoteMBFperTL||23} = <strong>$${Math.round(((S.freightBase||450) + 150*(S.stateRates?.AR||0))/(S.quoteMBFperTL||23))}/MBF</strong>
              &nbsp;|&nbsp;
              <span style="color:var(--warn)">AR 400mi:</span> <strong>$${Math.round(((S.freightBase||450) + 400*(S.stateRates?.AR||0))/(S.quoteMBFperTL||23))}/MBF</strong>
            </div>
            
            <div style="display:flex;gap:12px;align-items:center;padding-top:8px;border-top:1px solid var(--border);flex-wrap:wrap">
              <div style="display:flex;align-items:center;gap:6px">
                <label class="freight-lbl" style="margin:0">Std MBF/TL:</label>
                <input type="number" value="${S.quoteMBFperTL||23}" style="width:45px;padding:4px;font-size:10px" onchange="S.quoteMBFperTL=+this.value;render()">
              </div>
              <div style="display:flex;align-items:center;gap:6px">
                <label class="freight-lbl" style="margin:0;color:var(--warn)">MSR:</label>
                <span style="font-size:10px;color:var(--warn)">20 MBF/TL</span>
              </div>
            </div>
          </div>
          
          <!-- RL Reference -->
          ${latestRL?`<div style="padding:10px;background:var(--card);border:1px solid var(--border);border-radius:6px;margin-bottom:12px">
            <div style="font-size:10px;color:var(--muted);margin-bottom:6px">üì∞ RL ${latestRL.date}</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;font-size:10px">
              <div><span style="color:var(--accent)">W:</span> $${latestRL.west?.['2x4#2']||'‚Äî'}</div>
              <div><span style="color:var(--warn)">C:</span> $${latestRL.central?.['2x4#2']||'‚Äî'}</div>
              <div><span style="color:var(--info)">E:</span> $${latestRL.east?.['2x4#2']||'‚Äî'}</div>
            </div>
          </div>`:''}
          
          <!-- Specific City Quote -->
          <div class="card" style="margin-bottom:14px">
            <div class="card-header"><span class="card-title">üìç Quote to City</span></div>
            <div style="padding:10px">
              <div style="display:flex;gap:8px;margin-bottom:8px">
                <input type="text" id="specific-city" placeholder="City, ST" style="flex:1;padding:8px;font-size:12px" value="${S.specificCity||''}">
                <button class="btn btn-primary btn-sm" onclick="generateSpecificCityQuote()">Generate</button>
              </div>
              <div style="font-size:9px;color:var(--muted)">Enter any city to get a one-off quote</div>
            </div>
          </div>
          
          <!-- Recipients (Bulk) -->
          <div class="card" style="margin-bottom:14px">
            <div class="card-header"><span class="card-title">üìã Bulk Quote</span><span style="font-size:9px;color:var(--accent)">${customers.filter(c=>c.quoteSelected).length} selected</span></div>
            <div style="padding:0">
              <div class="customer-list">
                ${customers.length?customers.map((cust,i)=>{
                  const locs=cust.locations||[cust.destination].filter(Boolean);
                  const locCount=locs.length;
                  const locsDisplay=locs.slice(0,2).map(l=>{
                    const lane=S.lanes.find(ln=>ln.dest.toLowerCase().includes(l.split(',')[0].toLowerCase()));
                    return`<span style="display:inline-flex;align-items:center;gap:4px">üìç ${l}${lane?' <span style="color:var(--muted);font-size:9px">('+lane.miles+' mi)</span>':''}</span>`;
                  }).join('<br>');
                  const moreCount=locCount>2?locCount-2:0;
                  return`<div class="customer-item" style="align-items:flex-start">
                    <input type="checkbox" ${cust.quoteSelected?'checked':''} onchange="toggleQuoteCustomer(${i},this.checked)" style="margin-top:4px">
                    <div class="customer-info" style="flex:1">
                      <div class="customer-name">${cust.name}${locCount>1?' <span style="background:var(--info);color:var(--bg);padding:1px 5px;border-radius:8px;font-size:8px;margin-left:4px">'+locCount+' locs</span>':''}</div>
                      <div class="customer-dest" style="font-size:10px;line-height:1.5">${locsDisplay}${moreCount?' <span style="color:var(--muted)">+'+moreCount+' more</span>':''}</div>
                    </div>
                  </div>`;
                }).join(''):'<div class="empty-state">No customers in CRM</div>'}
              </div>
            </div>
            <div style="padding:8px 10px;border-top:1px solid var(--border);display:flex;gap:8px">
              <button class="btn btn-default btn-sm" onclick="uncheckAllQuoteCustomers()">Uncheck All</button>
              <button class="btn btn-default btn-sm" onclick="checkAllQuoteCustomers()">Check All</button>
            </div>
          </div>
          
          <!-- Market Blurb -->
          <div class="card" style="margin-bottom:12px">
            <div class="card-header"><span class="card-title">üìù Market Blurb</span><span style="font-size:9px;color:var(--muted)">Optional message above quote</span></div>
            <div style="padding:10px">
              <textarea id="market-blurb" placeholder="Add market commentary, notes, or greeting here..." style="width:100%;height:60px;padding:8px;font-size:11px;resize:vertical;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)" onchange="saveMarketBlurb()">${S.marketBlurb||''}</textarea>
            </div>
          </div>
          
          <!-- Generate Actions -->
          <div class="card" style="margin-bottom:12px">
            <div style="padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button class="btn btn-success" onclick="generateAllQuotes()" style="flex:1">üìã Copy All (${customers.filter(c=>c.quoteSelected).reduce((sum,c)=>{const locs=c.locations||[c.destination].filter(Boolean);return sum+(locs.length||1)},0)} quotes)</button>
            </div>
          </div>
          
          <!-- Single Quote Preview -->
          <div class="card">
            <div class="card-header"><span class="card-title">Single Quote</span>
              <div style="display:flex;gap:6px">
                <button class="btn btn-default btn-sm" onclick="copyQuoteOutput()">üìã Copy</button>
                <button class="btn btn-primary btn-sm" onclick="createSingleDraft()">‚úâÔ∏è Draft</button>
              </div>
            </div>
            <div style="padding:10px;border-bottom:1px solid var(--border)">
              <select id="single-quote-customer" onchange="S.singleQuoteCustomer=this.value;render()" style="width:100%;padding:8px;font-size:12px">
                <option value="">Select customer...</option>
                ${customers.map(c=>{
                  const locs=c.locations||[c.destination].filter(Boolean);
                  return`<option value="${c.name}" ${S.singleQuoteCustomer===c.name?'selected':''}>${c.name}${locs.length?' - '+locs[0]:''}</option>`;
                }).join('')}
              </select>
            </div>
            <div id="quote-status" style="padding:4px 10px;font-size:10px;color:var(--warn);min-height:16px"></div>
            <div style="padding:10px;padding-top:0">
              <div class="output-preview" id="quote-output">${generateQuotePreview(selectedItems,S.singleQuoteCustomer?customers.find(c=>c.name===S.singleQuoteCustomer):customers[0])}</div>
            </div>
          </div>
        </div>
      </div>`;
  }
  else if(S.view==='products'){
    // Calculate margin by product using matched trades (same orderNum)
    const buyByOrder={};
    S.buys.forEach(b=>{
      const ord=String(b.orderNum||b.po||'').trim();
      if(ord)buyByOrder[ord]=b;
    });
    
    const prodMargins={};
    S.sells.forEach(s=>{
      const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
      const buy=ord?buyByOrder[ord]:null;
      const buyCost=buy?.price||0;
      const buyFrtPerMBF=buy?.volume>0?(buy?.freight||0)/buy.volume:0;
      const totalCost=buyCost+buyFrtPerMBF;
      const sellFrtPerMBF=s.volume>0?(s.freight||0)/s.volume:0;
      const fob=(s.price||0)-sellFrtPerMBF;
      const margin=buy?(fob-totalCost):null;
      
      const prod=s.product||'Unknown';
      if(!prodMargins[prod])prodMargins[prod]={bVol:0,sVol:0,marginVol:0,marginVal:0};
      prodMargins[prod].sVol+=s.volume||0;
      if(margin!==null){
        prodMargins[prod].marginVol+=s.volume||0;
        prodMargins[prod].marginVal+=margin*(s.volume||0);
      }
    });
    // Add buy volumes
    S.buys.forEach(b=>{
      const prod=b.product||'Unknown';
      if(!prodMargins[prod])prodMargins[prod]={bVol:0,sVol:0,marginVol:0,marginVal:0};
      prodMargins[prod].bVol+=b.volume||0;
    });
    
    c.innerHTML=`<div class="card"><div class="card-header"><span class="card-title">PERFORMANCE BY PRODUCT (Avg Margin/MBF Net Freight)</span></div>
      <div style="overflow-x:auto"><table><thead><tr><th>Product</th><th class="right">Buy Vol</th><th class="right">Sell Vol</th><th class="right">Matched Vol</th><th class="right">Avg Margin/MBF</th></tr></thead><tbody>
        ${Object.keys(prodMargins).length?Object.entries(prodMargins).sort((a,b)=>(b[1].marginVal/b[1].marginVol||0)-(a[1].marginVal/a[1].marginVol||0)).map(([p,d])=>{
          const avgMargin=d.marginVol>0?d.marginVal/d.marginVol:null;
          return`<tr><td class="bold">${p}</td><td class="right">${d.bVol} MBF</td><td class="right">${d.sVol} MBF</td><td class="right">${d.marginVol} MBF</td><td class="right ${avgMargin===null?'':(avgMargin>=0?'positive':'negative')} bold">${avgMargin!==null?fmt(Math.round(avgMargin)):'‚Äî'}</td></tr>`;
        }).join(''):'<tr><td colspan="5" class="empty-state">No data</td></tr>'}
      </tbody></table></div></div>`;
  }
  else if(S.view==='crm'){
    // Calculate margin by customer (need to match sells to buys by orderNum)
    const buyByOrder={};
    S.buys.forEach(b=>{
      const ord=String(b.orderNum||b.po||'').trim();
      if(ord)buyByOrder[ord]=b;
    });
    
    const custMargins={};
    S.sells.forEach(s=>{
      const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
      const buy=ord?buyByOrder[ord]:null;
      const buyCost=buy?.price||0;
      const buyFrtPerMBF=buy?.volume>0?(buy?.freight||0)/buy.volume:0;
      const totalCost=buyCost+buyFrtPerMBF;
      const sellFrtPerMBF=s.volume>0?(s.freight||0)/s.volume:0;
      const fob=(s.price||0)-sellFrtPerMBF;
      const margin=buy?(fob-totalCost):null;
      
      if(!custMargins[s.customer])custMargins[s.customer]={vol:0,marginVal:0,n:0};
      custMargins[s.customer].n++;
      custMargins[s.customer].vol+=s.volume||0;
      if(margin!==null)custMargins[s.customer].marginVal+=margin*(s.volume||0);
    });
    
    c.innerHTML=`
      <div class="grid-2">
        <div class="card"><div class="card-header"><span class="card-title positive">MILLS</span><button class="btn btn-default btn-sm" onclick="showMillModal()">+ Add</button></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Mill</th><th>Locations</th><th>Trades</th><th>Volume</th><th></th></tr></thead><tbody>
            ${S.mills.length?S.mills.map(m=>{
              const locs=m.locations||[m.origin].filter(Boolean);
              const trades=S.buys.filter(b=>b.mill===m.name);
              const vol=trades.reduce((s,b)=>s+(b.volume||0),0);
              return`<tr><td class="bold">${m.name}</td><td style="font-size:10px">${locs.length?locs.join(', '):'‚Äî'}</td><td class="right">${trades.length}</td><td class="right">${vol} MBF</td><td style="white-space:nowrap"><button class="btn btn-default btn-sm" onclick="editMill('${m.name}')">Edit</button> <button class="btn btn-default btn-sm" onclick="deleteMill('${m.name}')" style="color:var(--negative)">√ó</button></td></tr>`;
            }).join(''):'<tr><td colspan="5" class="empty-state">No mills saved. Add mills when creating buys.</td></tr>'}
          </tbody></table></div></div>
        <div class="card"><div class="card-header"><span class="card-title">CUSTOMERS</span><button class="btn btn-default btn-sm" onclick="showCustModal()">+ Add</button></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Customer</th><th>Locations</th><th>Trades</th><th>Volume</th><th></th></tr></thead><tbody>
            ${S.customers.length?S.customers.map(c=>{
              const locs=c.locations||[c.destination].filter(Boolean);
              const trades=S.sells.filter(s=>s.customer===c.name);
              const vol=trades.reduce((s,x)=>s+(x.volume||0),0);
              return`<tr><td class="bold">${c.name}</td><td style="font-size:10px">${locs.length?locs.join(', '):'‚Äî'}</td><td class="right">${trades.length}</td><td class="right">${vol} MBF</td><td style="white-space:nowrap"><button class="btn btn-default btn-sm" onclick="editCust('${c.name}')">Edit</button> <button class="btn btn-default btn-sm" onclick="deleteCust('${c.name}')" style="color:var(--negative)">√ó</button></td></tr>`;
            }).join(''):'<tr><td colspan="5" class="empty-state">No customers saved. Add customers when creating sells.</td></tr>'}
          </tbody></table></div></div>
      </div>
      <div class="card"><div class="card-header"><span class="card-title warn">CUSTOMER PROFITABILITY (Avg Margin/MBF Net Freight)</span></div>
        <div style="overflow-x:auto"><table><thead><tr><th>Customer</th><th class="right">Trades</th><th class="right">Volume</th><th class="right">Avg Margin/MBF</th></tr></thead><tbody>
          ${Object.keys(custMargins).length?Object.entries(custMargins).filter(([c,d])=>d.vol>0).sort((x,y)=>(y[1].marginVal/y[1].vol)-(x[1].marginVal/x[1].vol)).map(([c,d])=>{
            const avgMargin=d.vol>0?d.marginVal/d.vol:0;
            return`<tr><td class="bold">${c}</td><td class="right">${d.n}</td><td class="right">${d.vol} MBF</td><td class="right ${avgMargin>=0?'positive':'negative'} bold">${fmt(Math.round(avgMargin))}</td></tr>`;
          }).join(''):'<tr><td colspan="4" class="empty-state">No linked sales to calculate margin</td></tr>'}
        </tbody></table></div></div>`;
  }
  else if(S.view==='rldata'){
    // RL Analytics
    const latestRL=S.rl.length?S.rl[S.rl.length-1]:null;
    const prevRL=S.rl.length>1?S.rl[S.rl.length-2]:null;
    
    // Calculate spreads if we have data
    let spreadsHTML='';
    if(latestRL){
      const region=S.filters.reg!=='all'?S.filters.reg:'west';
      const sl=latestRL.specified_lengths?.[region]||{};
      
      // Length spreads (16' as base)
      const lengthSpreads=[];
      Object.entries(sl).forEach(([prod,lengths])=>{
        if(lengths['16']){
          const base=lengths['16'];
          ['8','10','12','14','18','20'].forEach(len=>{
            if(lengths[len]){
              lengthSpreads.push({prod,len,base,price:lengths[len],spread:lengths[len]-base});
            }
          });
        }
      });
      
      // Dimension spreads (2x4 as base for each length)
      const dimSpreads=[];
      ['8','10','12','14','16','18','20'].forEach(len=>{
        const base2x4=sl['2x4#2']?.[len]||sl['2x4#1']?.[len];
        if(base2x4){
          ['2x6','2x8','2x10','2x12'].forEach(dim=>{
            const price=sl[dim+'#2']?.[len]||sl[dim+'#1']?.[len];
            if(price)dimSpreads.push({len,dim,base:base2x4,price,spread:price-base2x4});
          });
        }
      });
      
      // Grade spreads (#1 vs #2)
      const gradeSpreads=[];
      ['2x4','2x6','2x8','2x10','2x12'].forEach(dim=>{
        ['8','10','12','14','16','18','20'].forEach(len=>{
          const p1=sl[dim+'#1']?.[len];
          const p2=sl[dim+'#2']?.[len];
          if(p1&&p2)gradeSpreads.push({dim,len,p1,p2,spread:p1-p2});
        });
      });
      
      // Week-over-week changes
      let wowHTML='';
      if(prevRL){
        const changes=[];
        ['west','central','east'].forEach(reg=>{
          ['2x4#2','2x6#2','2x8#2','2x10#2','2x12#2'].forEach(prod=>{
            const curr=latestRL[reg]?.[prod];
            const prev=prevRL[reg]?.[prod];
            if(curr&&prev&&curr!==prev){
              changes.push({reg,prod,curr,prev,chg:curr-prev});
            }
          });
        });
        if(changes.length){
          wowHTML=`<div class="card"><div class="card-header"><span class="card-title">WEEK-OVER-WEEK CHANGES</span><span style="color:var(--muted);font-size:10px">${prevRL.date} ‚Üí ${latestRL.date}</span></div>
            <div style="overflow-x:auto"><table><thead><tr><th>Region</th><th>Product</th><th class="right">Prev</th><th class="right">Curr</th><th class="right">Change</th></tr></thead><tbody>
            ${changes.map(c=>`<tr><td style="text-transform:capitalize">${c.reg}</td><td class="bold">${c.prod}</td><td class="right">${fmt(c.prev)}</td><td class="right">${fmt(c.curr)}</td><td class="right ${c.chg>0?'positive':'negative'} bold">${c.chg>0?'+':''}${fmt(c.chg)}</td></tr>`).join('')}
            </tbody></table></div></div>`;
        }
      }
      
      spreadsHTML=`
        ${wowHTML}
        <div class="grid-2">
          <div class="card"><div class="card-header"><span class="card-title accent">LENGTH SPREADS (vs 16')</span><span style="color:var(--muted);font-size:10px">${region}</span></div>
            <div style="overflow-x:auto;max-height:300px"><table><thead><tr><th>Product</th><th>Length</th><th class="right">16' Base</th><th class="right">Price</th><th class="right">Spread</th></tr></thead><tbody>
            ${lengthSpreads.length?lengthSpreads.slice(0,20).map(s=>`<tr><td>${s.prod}</td><td>${s.len}'</td><td class="right" style="color:var(--muted)">${fmt(s.base)}</td><td class="right">${fmt(s.price)}</td><td class="right ${s.spread>=0?'positive':'negative'} bold">${s.spread>=0?'+':''}${fmt(s.spread)}</td></tr>`).join(''):'<tr><td colspan="5" class="empty-state">No data</td></tr>'}
            </tbody></table></div></div>
          <div class="card"><div class="card-header"><span class="card-title warn">DIMENSION SPREADS (vs 2x4)</span><span style="color:var(--muted);font-size:10px">${region}</span></div>
            <div style="overflow-x:auto;max-height:300px"><table><thead><tr><th>Length</th><th>Dim</th><th class="right">2x4 Base</th><th class="right">Price</th><th class="right">Spread</th></tr></thead><tbody>
            ${dimSpreads.length?dimSpreads.slice(0,20).map(s=>`<tr><td>${s.len}'</td><td class="bold">${s.dim}</td><td class="right" style="color:var(--muted)">${fmt(s.base)}</td><td class="right">${fmt(s.price)}</td><td class="right ${s.spread>=0?'positive':'negative'} bold">+${fmt(s.spread)}</td></tr>`).join(''):'<tr><td colspan="5" class="empty-state">No data</td></tr>'}
            </tbody></table></div></div>
        </div>
        <div class="card"><div class="card-header"><span class="card-title">GRADE SPREADS (#1 vs #2)</span><span style="color:var(--muted);font-size:10px">${region}</span></div>
          <div style="overflow-x:auto"><table><thead><tr><th>Dim</th><th>Len</th><th class="right">#1</th><th class="right">#2</th><th class="right">#1 Premium</th></tr></thead><tbody>
          ${gradeSpreads.length?gradeSpreads.slice(0,15).map(s=>`<tr><td class="bold">${s.dim}</td><td>${s.len}'</td><td class="right accent">${fmt(s.p1)}</td><td class="right">${fmt(s.p2)}</td><td class="right positive bold">+${fmt(s.spread)}</td></tr>`).join(''):'<tr><td colspan="5" class="empty-state">No data</td></tr>'}
          </tbody></table></div></div>`;
    }
    
    // Build product list for comparison
    const allProducts=new Set();
    S.rl.forEach(r=>{
      ['west','central','east'].forEach(reg=>{
        if(r[reg])Object.keys(r[reg]).forEach(p=>allProducts.add(p));
        if(r.specified_lengths?.[reg])Object.keys(r.specified_lengths[reg]).forEach(p=>allProducts.add(p));
      });
    });
    const productList=[...allProducts].sort();
    
    // Historical comparison view
    let compareHTML='';
    if(S.rl.length>0){
      const region=S.filters.reg!=='all'?S.filters.reg:'west';
      const prod1=S.compareProd1||'2x4#2';
      const prod2=S.compareProd2||'2x6#2';
      const len=S.compareLen||'16';
      
      // Build history for selected products
      const history=S.rl.map(r=>{
        let p1=null,p2=null;
        // Try specified lengths first
        if(r.specified_lengths?.[region]?.[prod1]?.[len]){
          p1=r.specified_lengths[region][prod1][len];
        }else if(r[region]?.[prod1]){
          p1=r[region][prod1];
        }
        if(r.specified_lengths?.[region]?.[prod2]?.[len]){
          p2=r.specified_lengths[region][prod2][len];
        }else if(r[region]?.[prod2]){
          p2=r[region][prod2];
        }
        return{date:r.date,p1,p2,spread:p1&&p2?p2-p1:null};
      }).filter(h=>h.p1||h.p2);
      
      compareHTML=`
        <div class="card"><div class="card-header"><span class="card-title info">HISTORICAL SPREAD COMPARISON</span></div>
          <div class="card-body">
            <div class="form-grid" style="margin-bottom:16px">
              <div class="form-group">
                <label class="form-label">Product 1 (Base)</label>
                <select id="compare-prod1" onchange="S.compareProd1=this.value;render()" style="width:100%">
                  ${productList.map(p=>`<option value="${p}" ${p===prod1?'selected':''}>${p}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Product 2</label>
                <select id="compare-prod2" onchange="S.compareProd2=this.value;render()" style="width:100%">
                  ${productList.map(p=>`<option value="${p}" ${p===prod2?'selected':''}>${p}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Length</label>
                <select id="compare-len" onchange="S.compareLen=this.value;render()" style="width:100%">
                  <option value="8" ${len==='8'?'selected':''}>8'</option>
                  <option value="10" ${len==='10'?'selected':''}>10'</option>
                  <option value="12" ${len==='12'?'selected':''}>12'</option>
                  <option value="14" ${len==='14'?'selected':''}>14'</option>
                  <option value="16" ${len==='16'?'selected':''}>16'</option>
                  <option value="18" ${len==='18'?'selected':''}>18'</option>
                  <option value="20" ${len==='20'?'selected':''}>20'</option>
                  <option value="composite" ${len==='composite'?'selected':''}>Composite</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Region</label>
                <select onchange="S.filters.reg=this.value;render()" style="width:100%">
                  <option value="west" ${region==='west'?'selected':''}>West</option>
                  <option value="central" ${region==='central'?'selected':''}>Central</option>
                  <option value="east" ${region==='east'?'selected':''}>East</option>
                </select>
              </div>
            </div>
            <div style="overflow-x:auto"><table><thead><tr><th>Date</th><th class="right">${prod1}</th><th class="right">${prod2}</th><th class="right">Spread (${prod2} - ${prod1})</th></tr></thead><tbody>
              ${history.length?history.slice().reverse().map(h=>`<tr><td>${h.date}</td><td class="right">${h.p1?fmt(h.p1):'‚Äî'}</td><td class="right">${h.p2?fmt(h.p2):'‚Äî'}</td><td class="right ${h.spread===null?'':(h.spread>=0?'positive':'negative')} bold">${h.spread!==null?(h.spread>=0?'+':'')+fmt(h.spread):'‚Äî'}</td></tr>`).join(''):'<tr><td colspan="4" class="empty-state">No data for selected products</td></tr>'}
            </tbody></table></div>
            ${history.length>1?`
              <div style="margin-top:16px;padding:12px;background:var(--bg);border:1px solid var(--border)">
                <div style="display:flex;gap:24px;flex-wrap:wrap">
                  <div><span style="color:var(--muted)">Avg Spread:</span> <span class="bold ${(history.reduce((s,h)=>s+(h.spread||0),0)/history.filter(h=>h.spread!==null).length)>=0?'positive':'negative'}">${fmt(Math.round(history.reduce((s,h)=>s+(h.spread||0),0)/history.filter(h=>h.spread!==null).length))}</span></div>
                  <div><span style="color:var(--muted)">Min:</span> <span class="bold">${fmt(Math.min(...history.filter(h=>h.spread!==null).map(h=>h.spread)))}</span></div>
                  <div><span style="color:var(--muted)">Max:</span> <span class="bold">${fmt(Math.max(...history.filter(h=>h.spread!==null).map(h=>h.spread)))}</span></div>
                  <div><span style="color:var(--muted)">Current:</span> <span class="bold accent">${history.length&&history[history.length-1].spread!==null?fmt(history[history.length-1].spread):'‚Äî'}</span></div>
                </div>
              </div>
            `:''}
          </div>
        </div>`;
    }
    
    // Date selector tabs
    const dateTabs=S.rl.slice().reverse().map(r=>`<button class="btn ${S.rlViewDate===r.date?'btn-primary':'btn-default'} btn-sm" onclick="S.rlViewDate='${r.date}';render()" style="margin-right:4px">${r.date}</button>`).join('');
    
    // Get selected RL report
    const selectedRL=S.rlViewDate?S.rl.find(r=>r.date===S.rlViewDate):latestRL;
    
    let detailHTML='';
    if(selectedRL){
      detailHTML=`<div class="card"><div class="card-header"><span class="card-title">${selectedRL.date} DETAILS</span><button class="btn btn-danger btn-sm" onclick="delRL('${selectedRL.date}')">Delete</button></div><div class="card-body">`;
      
      // Composite prices
      if(selectedRL.west||selectedRL.central||selectedRL.east){
        detailHTML+=`<div style="font-weight:600;color:var(--accent);margin-bottom:8px">COMPOSITE PRICES</div>
          <table style="width:100%;font-size:10px;margin-bottom:16px">
          <tr><th>Product</th><th class="right" style="color:var(--accent)">West</th><th class="right" style="color:var(--warn)">Central</th><th class="right" style="color:var(--info)">East</th></tr>
          ${['2x4#1','2x4#2','2x6#1','2x6#2','2x8#2','2x10#2','2x12#2'].map(p=>`<tr><td>${p}</td><td class="right">${selectedRL.west?.[p]?'$'+selectedRL.west[p]:'‚Äî'}</td><td class="right">${selectedRL.central?.[p]?'$'+selectedRL.central[p]:'‚Äî'}</td><td class="right">${selectedRL.east?.[p]?'$'+selectedRL.east[p]:'‚Äî'}</td></tr>`).join('')}
          </table>`;
      }
      
      // Specified lengths
      if(selectedRL.specified_lengths){
        ['west','central','east'].forEach(region=>{
          if(selectedRL.specified_lengths[region]&&Object.keys(selectedRL.specified_lengths[region]).length>0){
            const regionColor={west:'var(--accent)',central:'var(--warn)',east:'var(--info)'}[region];
            detailHTML+=`<div style="font-weight:600;color:${regionColor};margin:12px 0 8px;text-transform:uppercase">${region} - SPECIFIED LENGTHS</div>
              <div style="overflow-x:auto"><table style="width:100%;font-size:10px;margin-bottom:12px">
              <tr><th>Product</th><th class="right">8'</th><th class="right">10'</th><th class="right">12'</th><th class="right">14'</th><th class="right">16'</th><th class="right">18'</th><th class="right">20'</th></tr>`;
            Object.entries(selectedRL.specified_lengths[region]).forEach(([prod,lengths])=>{
              detailHTML+=`<tr><td>${prod}</td>`;
              ['8','10','12','14','16','18','20'].forEach(len=>{
                detailHTML+=`<td class="right">${lengths[len]?'$'+lengths[len]:'‚Äî'}</td>`;
              });
              detailHTML+=`</tr>`;
            });
            detailHTML+=`</table></div>`;
          }
        });
      }
      detailHTML+=`</div></div>`;
    }
    
    c.innerHTML=`
      <div style="margin-bottom:16px;display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center">
          <span style="color:var(--muted);font-size:11px">DATES:</span>
          <div style="display:flex;flex-wrap:wrap;gap:4px">${dateTabs||'<span style="color:var(--muted)">No data</span>'}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-warn" onclick="showParseModal()">üìÑ Import PDF</button>
          <button class="btn btn-primary" onclick="showRLModal()">+ Manual Entry</button>
        </div>
      </div>
      ${S.rl.length===0?`<div class="card"><div class="card-body"><div class="empty-state">No RL data yet. Import a Random Lengths PDF to get started.</div></div></div>`:`
        <div style="margin-bottom:16px">
          <div style="display:flex;gap:8px;margin-bottom:12px">
            <button class="btn ${!S.rlTab||S.rlTab==='analytics'?'btn-primary':'btn-default'} btn-sm" onclick="S.rlTab='analytics';render()">üìä Analytics</button>
            <button class="btn ${S.rlTab==='compare'?'btn-primary':'btn-default'} btn-sm" onclick="S.rlTab='compare';render()">üìà Compare</button>
            <button class="btn ${S.rlTab==='details'?'btn-primary':'btn-default'} btn-sm" onclick="S.rlTab='details';render()">üìã Details</button>
          </div>
        </div>
        ${!S.rlTab||S.rlTab==='analytics'?spreadsHTML:(S.rlTab==='compare'?compareHTML:detailHTML)}
      `}`;
  }
  else if(S.view==='ai'){
    c.innerHTML=`<div class="ai-chat">
      <div class="ai-messages" id="ai-msgs">
        ${S.apiKey?S.aiMsgs.length?S.aiMsgs.map(m=>`<div class="ai-msg ${m.role}">${m.content}</div>`).join(''):'<div class="empty-state">Ask me anything about your trading data.<br><br>Examples:<br>‚Ä¢ "How am I doing vs market?"<br>‚Ä¢ "Which customers are most profitable?"<br>‚Ä¢ "What\'s my margin by product?"</div>':'<div class="empty-state">‚ö†Ô∏è Add your Claude API key in Settings first.</div>'}
      </div>
      <div class="ai-input-area">
        <textarea id="ai-in" placeholder="Ask about your trading data..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAI()}"></textarea>
        <button class="btn btn-primary" onclick="sendAI()" style="align-self:flex-end">Send</button>
      </div>
    </div>`;
    const msgs=document.getElementById('ai-msgs');if(msgs)msgs.scrollTop=msgs.scrollHeight;
  }
  else if(S.view==='settings'){
    const sbUrl=LS('supabaseUrl','');
    const sbKey=LS('supabaseKey','');
    const sbUser=LS('supabaseUserId','');
    const isConnected=sbUrl&&sbKey;
    
    c.innerHTML=`
      <div class="card"><div class="card-header"><span class="card-title">AI SETTINGS</span></div><div class="card-body">
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Claude API Key</label>
          <input type="password" id="api-key" value="${S.apiKey}" placeholder="sk-ant-..." style="width:100%;max-width:500px">
          <div style="color:var(--muted);font-size:10px;margin-top:4px">Get your key at console.anthropic.com</div>
        </div>
        <button class="btn btn-primary" onclick="saveKey()">Save API Key</button>
      </div></div>
      
      <div class="card"><div class="card-header"><span class="card-title warn">üîí PASSWORD PROTECTION</span></div><div class="card-body">
        <div style="margin-bottom:12px;font-size:11px;color:var(--muted)">
          ${LS('appPassword','')?'‚úì Password is set. App requires login.':'‚úó No password set. Anyone with link can access.'}
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Set/Change Password</label>
          <input type="password" id="new-app-password" placeholder="Enter new password" style="width:200px">
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-warn" onclick="setAppPassword(document.getElementById('new-app-password').value)">Set Password</button>
          <button class="btn btn-danger" onclick="if(confirm('Remove password protection?'))setAppPassword('')">Remove Password</button>
        </div>
      </div></div>
      
      <div class="card"><div class="card-header"><span class="card-title info">‚òÅÔ∏è CLOUD SYNC (Supabase)</span></div><div class="card-body">
        <div style="margin-bottom:16px;padding:12px;background:${isConnected?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};border:1px solid ${isConnected?'var(--positive)':'var(--negative)'};border-radius:4px">
          <span style="color:${isConnected?'var(--positive)':'var(--negative)'}">${isConnected?'‚úì Connected to Supabase':'‚úó Not connected'}</span>
          ${isConnected?`<span style="color:var(--muted);margin-left:12px">User: ${sbUser||'default'}</span>`:''}
        </div>
        <div class="form-grid" style="margin-bottom:16px">
          <div class="form-group">
            <label class="form-label">Supabase URL</label>
            <input type="text" id="sb-url" value="${sbUrl}" placeholder="https://xxxxx.supabase.co" style="width:100%">
          </div>
          <div class="form-group">
            <label class="form-label">Supabase Anon Key</label>
            <input type="password" id="sb-key" value="${sbKey}" placeholder="eyJ..." style="width:100%">
          </div>
          <div class="form-group">
            <label class="form-label">User ID (for multi-user)</label>
            <input type="text" id="sb-user" value="${sbUser}" placeholder="your-name or email" style="width:100%">
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
          <button class="btn btn-primary" onclick="saveSupabaseConfig()">Save Config</button>
          <button class="btn btn-success" onclick="doCloudSync('push')" ${!isConnected?'disabled':''}>‚¨ÜÔ∏è Push to Cloud</button>
          <button class="btn btn-warn" onclick="doCloudSync('pull')" ${!isConnected?'disabled':''}>‚¨áÔ∏è Pull from Cloud</button>
        </div>
        <div style="margin-top:12px">
          <label><input type="checkbox" id="auto-sync" ${S.autoSync?'checked':''} onchange="toggleAutoSync()"> Auto-sync on changes</label>
        </div>
        <div id="sync-status" style="margin-top:12px;font-size:11px;color:var(--muted)"></div>
        <div style="margin-top:16px;padding:12px;background:var(--bg);border:1px solid var(--border);font-size:10px;color:var(--muted)">
          <strong>Setup Instructions:</strong><br>
          1. Create free account at <a href="https://supabase.com" target="_blank" style="color:var(--accent)">supabase.com</a><br>
          2. Create new project ‚Üí Go to Settings ‚Üí API<br>
          3. Copy Project URL and anon/public key<br>
          4. Run this SQL in SQL Editor:<br>
          <code style="display:block;margin-top:8px;padding:8px;background:var(--panel);font-size:9px">
CREATE TABLE syp_data (<br>
&nbsp;&nbsp;id SERIAL PRIMARY KEY,<br>
&nbsp;&nbsp;user_id TEXT UNIQUE NOT NULL,<br>
&nbsp;&nbsp;data JSONB,<br>
&nbsp;&nbsp;updated_at TIMESTAMPTZ DEFAULT NOW()<br>
);<br>
ALTER TABLE syp_data ENABLE ROW LEVEL SECURITY;<br>
CREATE POLICY "Allow all" ON syp_data FOR ALL USING (true);
          </code>
        </div>
      </div></div>
      
      <div class="card"><div class="card-header"><span class="card-title warn">FREIGHT SETTINGS</span></div><div class="card-body">
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Flat Rate ($/mile)</label>
          <input type="number" id="flat-rate" value="${S.flatRate||3.50}" step="0.01" style="width:150px">
          <div style="color:var(--muted);font-size:10px;margin-top:4px">Used to auto-calculate freight from mileage</div>
        </div>
        <button class="btn btn-warn" onclick="saveFlatRate()">Save Flat Rate</button>
      </div></div>
      
      <div class="card"><div class="card-header"><span class="card-title">DATA MANAGEMENT</span></div><div class="card-body">
        <div style="margin-bottom:12px;font-size:11px;color:var(--muted)">
          Storage: IndexedDB (primary, ~50MB+) + localStorage (backup)
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
          <button class="btn btn-default" onclick="expAll()">üì§ Export All (JSON)</button>
          <button class="btn btn-default" onclick="document.getElementById('imp-file').click()">üì• Import (JSON)</button>
          <input type="file" id="imp-file" accept=".json" style="display:none" onchange="impData(event)">
        </div>
        <div style="border-top:1px solid var(--border);padding-top:16px">
          <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All Data</button>
        </div>
      </div></div>`;
  }
}

// MODALS
function closeModal(){document.getElementById('modal').innerHTML=''}

function showBuyModal(b=null){
  // Build product list from RL data + defaults
  const rlProducts=new Set(PRODUCTS);
  S.rl.forEach(r=>{
    ['west','central','east'].forEach(reg=>{
      if(r[reg])Object.keys(r[reg]).forEach(p=>rlProducts.add(p));
      if(r.specified_lengths?.[reg])Object.keys(r.specified_lengths[reg]).forEach(p=>rlProducts.add(p));
      if(r.timbers?.[reg])Object.keys(r.timbers[reg]).forEach(p=>rlProducts.add(p));
    });
  });
  ['2x4#1','2x4#2','2x4#3','2x6#1','2x6#2','2x6#3','2x8#2','2x8#3','2x10#2','2x10#3','2x12#2','2x12#3','4x4#2','4x6','6x6','2x4 MSR','2x6 MSR','2x8 MSR','2x10 MSR','2x12 MSR','2x4 2400f','2x6 2400f','2x8 2400f','2x10 2400f'].forEach(p=>rlProducts.add(p));
  const prodList=[...rlProducts].sort();
  
  // Build mill list from CRM + defaults
  const millList=[...new Set([...MILLS,...S.mills.map(m=>m.name),...S.buys.map(x=>x.mill).filter(Boolean)])].sort();
  
  // Build origin location list from CRM and previous buys
  const origins=[...new Set([...S.mills.filter(m=>m.origin).map(m=>m.origin),...S.buys.map(x=>x.origin).filter(Boolean)])].sort();
  
  // Check if editing MSR or RL product
  const isMSR=b?.product?.toUpperCase().includes('MSR')||b?.product?.toUpperCase().includes('2400');
  const isRL=b?.length==='RL'||b?.tally;
  
  // Get sells without matching buys (shorts that need covering) - normalize order numbers
  const buyOrders=new Set(S.buys.map(x=>String(x.orderNum||x.po||'').trim()).filter(Boolean));
  const uncoveredSells=S.sells.filter(s=>{
    const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
    return ord && !buyOrders.has(ord);
  });
  
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title positive">${b?'EDIT':'NEW'} BUY</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Order #</label>
          <input type="text" id="m-orderNum" value="${b?.orderNum||b?.po||''}" placeholder="e.g. 70123" list="order-list-buy" onchange="onBuyOrderChange()">
          <datalist id="order-list-buy">${uncoveredSells.map(s=>{const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();return`<option value="${ord}">${ord} - ${s.product} ${s.length||'RL'} to ${s.customer} (SHORT)</option>`}).join('')}</datalist>
        </div>
        <div class="form-group"><label class="form-label">Date</label><input type="date" id="m-date" value="${b?.date||today()}"></div>
        <div class="form-group"><label class="form-label">Mill</label><input type="text" id="m-mill" value="${b?.mill||''}" list="mill-list" placeholder="Type or select..." onchange="autoFillOrigin()"><datalist id="mill-list">${millList.map(m=>`<option value="${m}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">Origin (City, ST)</label><input type="text" id="m-origin" value="${b?.origin||''}" list="origin-list" placeholder="e.g. Warren, AR"><datalist id="origin-list">${origins.map(o=>`<option value="${o}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">Region</label><select id="m-region" onchange="toggleBuyOptions()">${REGIONS.map(r=>`<option value="${r}" ${b?.region===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}</select></div>
        <div class="form-group"><label class="form-label">Product</label><input type="text" id="m-product" value="${b?.product||''}" list="prod-list" placeholder="e.g. 2x4#2, 2x6 MSR" onchange="toggleBuyOptions()"><datalist id="prod-list">${prodList.map(p=>`<option value="${p}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">Length</label><select id="m-length" onchange="toggleBuyOptions()"><option value="">Select...</option><option value="8" ${b?.length==='8'?'selected':''}>8'</option><option value="10" ${b?.length==='10'?'selected':''}>10'</option><option value="12" ${b?.length==='12'?'selected':''}>12'</option><option value="14" ${b?.length==='14'?'selected':''}>14'</option><option value="16" ${b?.length==='16'?'selected':''}>16'</option><option value="18" ${b?.length==='18'?'selected':''}>18'</option><option value="20" ${b?.length==='20'?'selected':''}>20'</option><option value="RL" ${b?.length==='RL'?'selected':''}>RL (Random)</option></select></div>
        <div class="form-group"><label class="form-label">Volume (MBF)</label><input type="number" id="m-volume" value="${b?.volume||''}"></div>
      </div>
      
      <div id="msr-section" style="margin-top:16px;padding:16px;background:var(--panel-alt);border:1px solid var(--accent);display:${isMSR&&!isRL?'block':'none'}">
        <div style="font-weight:600;color:var(--accent);margin-bottom:12px">MSR/2400 PRICING (Premium over #1)</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Base #1 (from RL)</label><input type="number" id="m-basePrice" value="${b?.basePrice||''}" readonly style="opacity:0.7"></div>
          <div class="form-group"><label class="form-label">Your Price</label><input type="number" id="m-price" value="${b?.price||''}" placeholder="$/MBF" onchange="calcMSRPremium()" onkeyup="calcMSRPremium()"></div>
          <div class="form-group"><label class="form-label">= Premium</label><input type="number" id="m-msrPremium" value="${b?.msrPremium||''}" readonly style="font-weight:bold;color:var(--accent)"></div>
        </div>
        <div id="msr-source" style="font-size:10px;color:var(--muted);margin-top:8px"></div>
      </div>
      
      <div id="standard-price" style="margin-top:16px;display:${isMSR||isRL?'none':'block'}">
        <div class="form-group"><label class="form-label">Price ($/MBF FOB)</label><input type="number" id="m-price-std" value="${b?.price||''}"></div>
      </div>
      
      <div id="rl-tally-section" style="margin-top:16px;padding:16px;background:var(--panel-alt);border:1px solid var(--warn);display:${isRL?'block':'none'}">
        <div style="font-weight:600;color:var(--warn);margin-bottom:12px">${isMSR?'MSR/2400 RL TALLY (Per-Length with #1 Base)':'RL TALLY (Per-Length Pricing)'}</div>
        <div style="margin-bottom:8px"><label><input type="checkbox" id="m-useTally" ${b?.tally?'checked':''} onchange="toggleTally()"> Use per-length tally</label></div>
        <div id="tally-grid" style="display:${b?.tally?'block':'none'}">
          <table style="width:100%;font-size:11px"><thead><tr><th>Length</th><th>MBF</th><th id="tally-price-header">${isMSR?'Your $/MBF':'$/MBF'}</th><th id="tally-base-header" style="display:${isMSR?'table-cell':'none'}">Base #1</th><th id="tally-prem-header" style="display:${isMSR?'table-cell':'none'}">Premium</th><th>Value</th></tr></thead><tbody>
            ${['8','10','12','14','16','18','20'].map(len=>`<tr>
              <td>${len}'</td>
              <td><input type="number" id="tally-vol-${len}" value="${b?.tally?.[len]?.vol||''}" style="width:60px" onchange="calcTallyTotal()"></td>
              <td><input type="number" id="tally-price-${len}" value="${b?.tally?.[len]?.price||''}" style="width:70px" onchange="calcTallyTotal()"></td>
              <td id="tally-base-${len}" class="right" style="display:${isMSR?'table-cell':'none'};color:var(--muted)">‚Äî</td>
              <td id="tally-prem-${len}" class="right" style="display:${isMSR?'table-cell':'none'};color:var(--accent)">‚Äî</td>
              <td id="tally-val-${len}" class="right">‚Äî</td>
            </tr>`).join('')}
          </tbody><tfoot><tr style="font-weight:bold;border-top:2px solid var(--border)"><td>Total</td><td id="tally-total-vol">‚Äî</td><td id="tally-avg-price">‚Äî</td><td id="tally-avg-base" style="display:${isMSR?'table-cell':'none'}">‚Äî</td><td id="tally-avg-prem" style="display:${isMSR?'table-cell':'none'}">‚Äî</td><td id="tally-total-val">‚Äî</td></tr></tfoot></table>
        </div>
      </div>
      
      <div style="margin-top:16px;padding:16px;background:var(--panel-alt);border:1px solid var(--border)">
        <div style="font-weight:600;color:var(--warn);margin-bottom:12px">FREIGHT (Optional - for DLVD buys)</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Miles</label><div style="display:flex;gap:4px"><input type="number" id="m-miles" value="${b?.miles||''}" style="flex:1" onchange="calcBuyFreight()"><button class="btn btn-default btn-sm" onclick="calcBuyMileage()">üîç</button></div></div>
          <div class="form-group"><label class="form-label">Rate ($/mile)</label><input type="number" id="m-rate" value="${b?.rate||S.flatRate||3.50}" step="0.01" onchange="calcBuyFreight()"></div>
          <div class="form-group"><label class="form-label">Freight ($/load)</label><input type="number" id="m-freight" value="${b?.freight||''}"></div>
          <div class="form-group"><label class="form-label">$/MBF</label><input type="text" id="m-freightMBF" value="" readonly style="opacity:0.7"></div>
        </div>
        <div id="buy-mileage-status" style="font-size:10px;color:var(--muted);margin-top:8px"></div>
      </div>
      
      <div class="form-group" style="margin-top:12px"><label class="form-label">Notes</label><textarea id="m-notes">${b?.notes||''}</textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-default" onclick="closeModal()">Cancel</button><button class="btn btn-success" onclick="saveBuy(${b?.id||'null'})">Save</button></div>
  </div></div>`;
  
  toggleBuyOptions();
  if(b?.tally)calcTallyTotal();
  calcBuyFreight();
}

function autoFillOrigin(){
  const mill=document.getElementById('m-mill')?.value;
  const originInput=document.getElementById('m-origin');
  const originList=document.getElementById('origin-list');
  
  if(mill){
    const crmMill=S.mills.find(m=>m.name===mill);
    if(crmMill){
      // Get mill's locations
      const locs=crmMill.locations||[crmMill.origin].filter(Boolean);
      
      // Update datalist with mill locations first  
      if(originList&&locs.length){
        const allOrigins=[...new Set([...locs,...S.mills.filter(m=>m.origin).map(m=>m.origin),...S.buys.map(x=>x.origin).filter(Boolean)])].sort();
        originList.innerHTML=allOrigins.map(o=>`<option value="${o}">`).join('');
      }
      
      // Auto-fill first location if origin is empty
      if(locs.length&&!originInput.value){
        originInput.value=locs[0];
      }
      
      // Also set region if available
      if(crmMill.region&&!document.getElementById('m-region').value){
        document.getElementById('m-region').value=crmMill.region;
      }
    }
  }
}

function autoFillDest(){
  const cust=document.getElementById('m-cust')?.value;
  const destInput=document.getElementById('m-dest');
  const destList=document.getElementById('dest-list');
  
  if(cust){
    const crmCust=S.customers.find(c=>c.name===cust);
    if(crmCust){
      // Get customer's locations
      const locs=crmCust.locations||[crmCust.destination].filter(Boolean);
      
      // Update datalist with customer locations first
      if(destList&&locs.length){
        const allDests=[...new Set([...locs,...S.customers.filter(c=>c.destination).map(c=>c.destination),...S.sells.map(x=>x.destination).filter(Boolean)])].sort();
        destList.innerHTML=allDests.map(d=>`<option value="${d}">`).join('');
      }
      
      // Auto-fill first location if dest is empty
      if(locs.length&&!destInput.value){
        destInput.value=locs[0];
      }
    }
  }
}

// When selecting an order # in buy modal (covering a short)
function onBuyOrderChange(){
  const orderNum=document.getElementById('m-orderNum')?.value;
  if(!orderNum)return;
  
  // Find matching sell (short to cover) - normalize to string
  const orderNumStr=String(orderNum).trim();
  const sell=S.sells.find(s=>String(s.orderNum||s.linkedPO||s.oc||'').trim()===orderNumStr);
  if(sell){
    // Auto-fill product, length, volume, region from the sell
    if(sell.product&&!document.getElementById('m-product').value){
      document.getElementById('m-product').value=sell.product;
    }
    if(sell.length){
      document.getElementById('m-length').value=sell.length;
    }
    if(sell.volume&&!document.getElementById('m-volume').value){
      document.getElementById('m-volume').value=sell.volume;
    }
    if(sell.region){
      document.getElementById('m-region').value=sell.region;
    }
    toggleBuyOptions();
  }
}

// When selecting an order # in sell modal (selling against a long)
function onSellOrderChange(){
  const orderNum=document.getElementById('m-orderNum')?.value;
  if(!orderNum)return;
  
  // Find matching buy (long to sell against) - normalize to string
  const orderNumStr=String(orderNum).trim();
  const buy=S.buys.find(b=>String(b.orderNum||b.po||'').trim()===orderNumStr);
  if(buy){
    // Auto-fill product, length, region from the buy
    if(buy.product&&!document.getElementById('m-product').value){
      document.getElementById('m-product').value=buy.product;
    }
    if(buy.length){
      document.getElementById('m-length').value=buy.length;
    }
    if(buy.region){
      document.getElementById('m-region').value=buy.region;
    }
    // Calculate available volume
    const orderSold={};
    S.sells.forEach(s=>{
      const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
      if(ord)orderSold[ord]=(orderSold[ord]||0)+(s.volume||0);
    });
    const avail=(buy.volume||0)-(orderSold[orderNumStr]||0);
    if(avail>0&&!document.getElementById('m-volume').value){
      document.getElementById('m-volume').value=avail;
    }
    toggleSellOptions();
  }
}

// Sell against a long position from Risk view
function sellPosition(product, length, volume){
  // Find ALL buys with this product/length that have available volume
  const orderSold={};
  S.sells.forEach(s=>{
    const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
    if(ord)orderSold[ord]=(orderSold[ord]||0)+(s.volume||0);
  });
  
  // Normalize product for matching (remove spaces, lowercase)
  const normProd=p=>(p||'').toLowerCase().replace(/\s+/g,'');
  const targetProd=normProd(product);
  const targetLen=String(length||'RL').replace(/'/g,'');
  
  // Find all buys for this product/length with available volume
  const matchingBuys=S.buys.filter(b=>{
    if(normProd(b.product)!==targetProd)return false;
    const buyLen=String(b.length||'RL').replace(/'/g,'');
    if(targetLen && buyLen!==targetLen)return false;
    const ord=String(b.orderNum||b.po||'').trim();
    if(!ord)return false;
    const sold=orderSold[ord]||0;
    return (b.volume||0)-sold>0;
  });
  
  // Use first matching buy
  const matchingBuy=matchingBuys[0];
  const orderNum=matchingBuy?String(matchingBuy.orderNum||matchingBuy.po||'').trim():'';
  
  // Show modal with pre-filled data
  showSellModal({
    orderNum:orderNum,
    linkedPO:orderNum,
    product:product,
    length:length==='RL'?'RL':String(length).replace(/'/g,''),
    volume:matchingBuy?(matchingBuy.volume-(orderSold[orderNum]||0)):volume,
    region:matchingBuy?.region||'west'
  });
  
  // Alert if no matching buys found or multiple options
  if(matchingBuys.length===0){
    setTimeout(()=>alert(`No orders with available volume found for ${product} ${length}. Make sure your buys have Order #s assigned.`),100);
  }else if(matchingBuys.length>1){
    setTimeout(()=>alert(`Multiple orders found for ${product} ${length}. Please verify the correct Order # from the dropdown.`),100);
  }
}

// Cover a short position from Risk view  
function coverPosition(product, length, volume){
  // Find a sell (short) with this product/length that needs covering
  const buyOrders=new Set(S.buys.map(b=>String(b.orderNum||b.po||'').trim()).filter(Boolean));
  
  // Normalize product for matching
  const normProd=p=>(p||'').toLowerCase().replace(/\s+/g,'');
  const targetProd=normProd(product);
  const targetLen=String(length||'RL').replace(/'/g,'');
  
  const matchingSell=S.sells.find(s=>{
    if(normProd(s.product)!==targetProd)return false;
    const sellLen=String(s.length||'RL').replace(/'/g,'');
    if(targetLen && sellLen!==targetLen)return false;
    const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
    return ord && !buyOrders.has(ord);
  });
  
  const orderNum=matchingSell?String(matchingSell.orderNum||matchingSell.linkedPO||matchingSell.oc||'').trim():'';
  
  showBuyModal({
    orderNum:orderNum,
    po:orderNum,
    product:product,
    length:length==='RL'?'RL':length,
    volume:volume,
    region:matchingSell?.region||'west'
  });
  
  if(!matchingSell){
    setTimeout(()=>{
      alert(`No uncovered short orders found for ${product} ${length}. Make sure your sells have Order #s assigned, or select from the dropdown.`);
    },100);
  }
}

// ===== QUOTE ENGINE FUNCTIONS =====
function setQuoteMode(mode){
  S.quoteMode=mode;
  render();
}

function addQuoteItem(isShort=null){
  if(isShort===null)isShort=S.quoteMode==='ai';
  S.quoteItems.push({
    id:genId(),
    product:'',
    origin:'',
    tls:1,
    cost:isShort?null:0,
    fob:0,
    isShort:isShort,
    selected:true
  });
  save('quoteItems',S.quoteItems);
  saveCurrentProfileSelections();
  render();
}

function removeQuoteItem(idx){
  S.quoteItems.splice(idx,1);
  save('quoteItems',S.quoteItems);
  saveCurrentProfileSelections();
  render();
}

function updateQuoteItem(idx,field,value){
  if(S.quoteItems[idx]){
    S.quoteItems[idx][field]=value;
    save('quoteItems',S.quoteItems);
    saveCurrentProfileSelections();
    // Only re-render stats if needed
    if(field==='cost'||field==='fob'||field==='tls'||field==='selected'){
      render();
    }
  }
}

function toggleQuoteItem(idx,checked){
  if(S.quoteItems[idx]){
    S.quoteItems[idx].selected=checked;
    save('quoteItems',S.quoteItems);
    saveCurrentProfileSelections();
    render();
  }
}

function toggleAllQuoteItems(checked){
  S.quoteItems.forEach(i=>i.selected=checked);
  save('quoteItems',S.quoteItems);
  saveCurrentProfileSelections();
  render();
}

function clearQuoteItems(){
  if(confirm('Clear all quote items?')){
    S.quoteItems=[];
    save('quoteItems',S.quoteItems);
    saveCurrentProfileSelections();
    render();
  }
}

function loadFromInventory(){
  // Load long positions from Risk view into quote items
  const positions={};
  const normLen=l=>String(l||'RL').replace(/'/g,'');
  S.buys.forEach(b=>{
    const len=normLen(b.length);
    const key=`${b.product}|${len}`;
    if(!positions[key])positions[key]={product:b.product,length:len,bought:0,sold:0,cost:0,costVol:0,mill:b.mill};
    positions[key].bought+=b.volume||0;
    positions[key].cost+=(b.price||0)*(b.volume||0);
    positions[key].costVol+=b.volume||0;
  });
  S.sells.forEach(s=>{
    const len=normLen(s.length);
    const key=`${s.product}|${len}`;
    if(positions[key])positions[key].sold+=s.volume||0;
  });
  
  const longPos=Object.values(positions).filter(p=>p.bought>p.sold);
  if(!longPos.length){
    alert('No long positions to load. Add some buys first.');
    return;
  }
  
  // Convert to quote items
  const mbfPerTL=S.quoteMBFperTL||23;
  longPos.forEach(p=>{
    const netVol=p.bought-p.sold;
    const avgCost=p.costVol>0?Math.round(p.cost/p.costVol):0;
    const tls=Math.ceil(netVol/mbfPerTL);
    // Try to find mill location
    let origin='';
    if(p.mill){
      const mill=S.mills.find(m=>m.name===p.mill);
      if(mill&&mill.location)origin=mill.location;
      else if(mill&&mill.city)origin=mill.city;
    }
    S.quoteItems.push({
      id:genId(),
      product:`${p.product} ${p.length!=='RL'?p.length+"'":'RL'}`,
      origin:origin,
      tls:tls,
      cost:avgCost,
      fob:avgCost+30,
      isShort:false,
      selected:true
    });
  });
  
  save('quoteItems',S.quoteItems);
  saveCurrentProfileSelections();
  render();
}

function addLane(){
  const origin=document.getElementById('lane-origin')?.value?.trim();
  const dest=document.getElementById('lane-dest')?.value?.trim();
  const miles=+document.getElementById('lane-miles')?.value||0;
  
  if(!origin||!dest||!miles){
    alert('Please fill in origin, destination, and miles');
    return;
  }
  
  // Check if lane exists
  const existing=S.lanes.findIndex(l=>
    l.origin.toLowerCase()===origin.toLowerCase()&&
    l.dest.toLowerCase()===dest.toLowerCase()
  );
  
  if(existing>=0){
    S.lanes[existing].miles=miles;
  }else{
    S.lanes.push({origin,dest,miles,added:new Date().toISOString()});
  }
  
  save('lanes',S.lanes);
  document.getElementById('lane-origin').value='';
  document.getElementById('lane-dest').value='';
  document.getElementById('lane-miles').value='';
  render();
}

// Extract state abbreviation from location string
function extractState(location){
  if(!location)return null;
  const str=location.toUpperCase();
  // Look for common state abbreviations
  const states=['AL','MS','FL','GA','SC','AR','NC','TX','TN','LA','OK','MO','KY','VA','OH','IN','IL'];
  // Try to find at end after comma
  const match=str.match(/,\s*([A-Z]{2})\s*$/);
  if(match&&states.includes(match[1]))return match[1];
  // Try to find anywhere
  for(const st of states){
    if(str.includes(st))return st;
  }
  return null;
}

// Get RL region from origin location
// West: LA, AR, TX
// Central: MS, AL  
// East: NC, SC, FL, GA
function getRegionFromOrigin(origin){
  const state=extractState(origin);
  if(!state)return 'west'; // default
  
  const westStates=['LA','AR','TX'];
  const centralStates=['MS','AL'];
  const eastStates=['NC','SC','FL','GA'];
  
  if(westStates.includes(state))return 'west';
  if(centralStates.includes(state))return 'central';
  if(eastStates.includes(state))return 'east';
  
  return 'west'; // default for unknown states
}

// Update state freight rate
function updateStateRate(state,rate){
  if(!S.stateRates)S.stateRates={};
  S.stateRates[state]=rate||0;
  save('stateRates',S.stateRates);
  render();
}

// Calculate freight for a destination using state-based rates (legacy)
function calcFreightForDest(dest,miles){
  const state=extractState(dest);
  const stateRate=state&&S.stateRates?S.stateRates[state]||0:0;
  const mbfPerTL=S.quoteMSRFootage?20:(S.quoteMBFperTL||23);
  const base=S.freightBase||0;
  return Math.round((base+(miles*stateRate))/mbfPerTL);
}

// Get rate for a state (for display only)
function getStateRate(state){
  if(!S.stateRates)S.stateRates={};
  return S.stateRates[state]||null;
}

function getLaneMiles(origin,dest){
  if(!origin||!dest)return null;
  
  const normOrigin=origin.toLowerCase().trim();
  const normDest=dest.toLowerCase().trim();
  
  // Try exact match first
  let lane=S.lanes.find(l=>
    l.origin.toLowerCase().trim()===normOrigin&&
    l.dest.toLowerCase().trim()===normDest
  );
  
  // Try partial match on city names
  if(!lane){
    const originCity=normOrigin.split(',')[0].trim();
    const destCity=normDest.split(',')[0].trim();
    lane=S.lanes.find(l=>
      l.origin.toLowerCase().includes(originCity)&&
      l.dest.toLowerCase().includes(destCity)
    );
  }
  
  return lane?.miles||null;
}

// Calculate freight per MBF using Base + State Rate model
// Formula: (Base + Miles √ó StateRate) / MBF per TL
function calcFreightPerMBF(miles,origin,isMSR=false){
  if(!miles)return 0;
  
  const mbfPerTL=isMSR?20:(S.quoteMBFperTL||23);
  const originState=extractState(origin);
  
  // Get state rate (required)
  const stateRate=originState&&S.stateRates?S.stateRates[originState]||0:0;
  
  // Base + (Miles √ó StateRate)
  const base=S.freightBase||0;
  const freightTotal=base+(miles*stateRate);
  
  const freightPerMBF=Math.round(freightTotal/mbfPerTL);
  
  // Apply floor
  const floor=S.shortHaulFloor||0;
  return Math.max(floor,freightPerMBF);
}

function toggleQuoteCustomer(idx,checked){
  const customers=S.customers.filter(c=>c.type!=='mill');
  if(customers[idx]){
    // Find actual customer in S.customers and update
    const custName=customers[idx].name;
    const realIdx=S.customers.findIndex(c=>c.name===custName);
    if(realIdx>=0){
      S.customers[realIdx].quoteSelected=checked;
      save('customers',S.customers);
      
      // Also save to current profile
      saveCurrentProfileSelections();
      
      render();
    }
  }
}

function generateQuotePreview(items,customer,destOverride=null){
  if(!items.length)return '<div style="color:var(--muted)">No items selected</div>';
  
  // Get customer destination from CRM locations or use override
  const dest=destOverride||(customer?.locations||[customer?.destination].filter(Boolean))[0]||'TBD';
  
  // Build table rows
  const rows=items.map(item=>{
    const isMSR=item.product?.toUpperCase().includes('MSR')||item.product?.toUpperCase().includes('2400');
    const miles=getLaneMiles(item.origin,dest);
    const frt=calcFreightPerMBF(miles,item.origin,isMSR);
    const dlvd=(item.fob||0)+frt;
    
    return{
      product:item.product||'',
      tls:item.tls||1,
      price:dlvd,
      ship:item.shipWeek||'Prompt',
      isMSR
    };
  });
  
  // HTML table output
  let html=`
    <div class="quote-table-output">
      <div class="quote-header">
        <div class="quote-title">SYP AVAILABILITY</div>
        <div class="quote-dest">DLVD ${dest}</div>
      </div>
      <table class="quote-output-table">
        <thead>
          <tr><th>Product</th><th>Qty</th><th>Price</th><th>Ship</th></tr>
        </thead>
        <tbody>
          ${rows.map(r=>`<tr class="${r.isMSR?'msr-row':''}">
            <td>${r.product}</td>
            <td class="qty">${r.tls} TL</td>
            <td class="price">$${r.price}</td>
            <td class="ship">${r.ship}</td>
          </tr>`).join('')}
        </tbody>
      </table>
      <div class="quote-footer">Subject to prior sale ‚Ä¢ Ian @ Buckeye</div>
    </div>`;
  
  return html;
}

// Generate plain text version for clipboard
// Generate quote for a specific city (one-off)
function generateSpecificCityQuote(){
  const cityInput=document.getElementById('specific-city');
  const city=cityInput?.value?.trim();
  
  if(!city){
    alert('Enter a city (e.g. "Cincinnati, OH")');
    return;
  }
  
  S.specificCity=city;
  
  const items=S.quoteItems.filter(i=>i.selected!==false);
  if(!items.length){
    alert('No items selected');
    return;
  }
  
  // Check for missing lanes
  const neededLanes=[];
  items.forEach(item=>{
    if(!item.origin)return;
    const existing=S.lanes.find(l=>
      l.origin.toLowerCase().trim()===item.origin.toLowerCase().trim()&&
      l.dest.toLowerCase().trim()===city.toLowerCase().trim()
    );
    if(!existing){
      const key=`${item.origin}|${city}`;
      if(!neededLanes.find(n=>n.key===key)){
        neededLanes.push({key,origin:item.origin,dest:city});
      }
    }
  });
  
  if(neededLanes.length>0){
    // Need to lookup mileage first
    lookupMileageWithAPI(neededLanes).then(failedLanes=>{
      if(failedLanes.length>0){
        showMileageModal(failedLanes,()=>{
          finishSpecificCityQuote(items,city);
        });
      }else{
        finishSpecificCityQuote(items,city);
      }
    });
  }else{
    finishSpecificCityQuote(items,city);
  }
}

function finishSpecificCityQuote(items,city){
  // Save market blurb
  S.marketBlurb=document.getElementById('market-blurb')?.value||'';
  save('marketBlurb',S.marketBlurb);
  
  // Build HTML with blurb
  const html=generateQuoteHTML(items,city,true);
  const text=generateQuoteText(items,null,city,true);
  
  // Copy HTML to clipboard
  const htmlBlob=new Blob([html],{type:'text/html'});
  const textBlob=new Blob([text],{type:'text/plain'});
  
  navigator.clipboard.write([
    new ClipboardItem({
      'text/html':htmlBlob,
      'text/plain':textBlob
    })
  ]).then(()=>{
    alert(`Quote for ${city} copied to clipboard! Paste into Outlook for formatted table.`);
    render();
  }).catch(e=>{
    navigator.clipboard.writeText(text).then(()=>{
      alert(`Quote for ${city} copied as text`);
      render();
    });
  });
}

function copyQuoteOutput(){
  const items=S.quoteItems.filter(i=>i.selected!==false);
  
  // Use single quote customer dropdown
  const custName=S.singleQuoteCustomer||document.getElementById('single-quote-customer')?.value;
  const customer=custName?S.customers.find(c=>c.name===custName):S.customers.filter(c=>c.type!=='mill')[0];
  
  if(!items.length){
    alert('No items selected');
    return;
  }
  
  if(!customer){
    alert('Select a customer');
    return;
  }
  
  // Save market blurb
  S.marketBlurb=document.getElementById('market-blurb')?.value||'';
  save('marketBlurb',S.marketBlurb);
  
  const dest=(customer?.locations||[customer?.destination].filter(Boolean))[0]||'TBD';
  
  // Build HTML table for Outlook (with blurb)
  const html=generateQuoteHTML(items,dest,true);
  
  // Also build plain text fallback (with blurb)
  const text=generateQuoteText(items,customer,null,true);
  
  // Copy HTML to clipboard (works in Outlook, Word, etc)
  const blob=new Blob([html],{type:'text/html'});
  const textBlob=new Blob([text],{type:'text/plain'});
  
  navigator.clipboard.write([
    new ClipboardItem({
      'text/html':blob,
      'text/plain':textBlob
    })
  ]).then(()=>{
    alert('Copied to clipboard! Paste into Outlook for formatted table.');
  }).catch(e=>{
    // Fallback to plain text
    navigator.clipboard.writeText(text).then(()=>{
      alert('Copied as text (HTML copy not supported in this browser)');
    });
  });
}

// Generate HTML table for clipboard (Outlook-friendly)
function generateQuoteHTML(items,dest,includeBlurb=false){
  const blurb=includeBlurb?(S.marketBlurb||''):'';
  const rows=items.map(item=>{
    const isMSR=item.product?.toUpperCase().includes('MSR')||item.product?.toUpperCase().includes('2400');
    const miles=getLaneMiles(item.origin,dest);
    const frt=calcFreightPerMBF(miles,item.origin,isMSR);
    const dlvd=(item.fob||0)+frt;
    
    return{product:item.product||'',tls:item.tls||1,price:dlvd,ship:item.shipWeek||'Prompt'};
  });
  
  return`<html><body style="font-family:Calibri,Arial,sans-serif;">
${blurb?`<p style="margin-bottom:16px;">${blurb.replace(/\n/g,'<br>')}</p>`:''}
<table style="border-collapse:collapse;font-family:Calibri,Arial,sans-serif;font-size:11pt;">
  <thead>
    <tr style="background:#1a5f7a;color:white;">
      <th style="padding:8px 12px;text-align:left;border:1px solid #ccc;">Product</th>
      <th style="padding:8px 12px;text-align:center;border:1px solid #ccc;">Qty</th>
      <th style="padding:8px 12px;text-align:right;border:1px solid #ccc;">Price</th>
      <th style="padding:8px 12px;text-align:right;border:1px solid #ccc;">Ship</th>
    </tr>
  </thead>
  <tbody>
    ${rows.map((r,i)=>`<tr style="background:${i%2?'#f5f5f5':'white'};">
      <td style="padding:6px 12px;border:1px solid #ddd;">${r.product}</td>
      <td style="padding:6px 12px;text-align:center;border:1px solid #ddd;">${r.tls} TL</td>
      <td style="padding:6px 12px;text-align:right;border:1px solid #ddd;font-weight:bold;color:#2e7d32;">$${r.price}</td>
      <td style="padding:6px 12px;text-align:right;border:1px solid #ddd;color:#666;">${r.ship}</td>
    </tr>`).join('')}
  </tbody>
</table>
<p style="font-family:Calibri,Arial,sans-serif;font-size:10pt;color:#666;margin-top:8px;">
  <strong>DLVD ${dest}</strong><br>
  Subject to prior sale ‚Ä¢ Ian @ Buckeye
</p>
</body></html>`;
}

// Generate plain text version for clipboard (with optional blurb)
function generateQuoteText(items,customer,destOverride=null,includeBlurb=false){
  if(!items.length)return '';
  
  const dest=destOverride||(customer?.locations||[customer?.destination].filter(Boolean))[0]||'TBD';
  const blurb=includeBlurb?(S.marketBlurb||''):'';
  
  let txt=blurb?blurb+'\n\n':'';
  txt+=`SYP AVAILABILITY\nDLVD ${dest}\n${'‚îÄ'.repeat(36)}\n`;
  txt+=`${'Product'.padEnd(16)}${'Qty'.padStart(6)}${'Price'.padStart(8)}${'Ship'.padStart(8)}\n`;
  txt+=`${'‚îÄ'.repeat(36)}\n`;
  
  items.forEach(item=>{
    const isMSR=item.product?.toUpperCase().includes('MSR')||item.product?.toUpperCase().includes('2400');
    const miles=getLaneMiles(item.origin,dest);
    const frt=calcFreightPerMBF(miles,item.origin,isMSR);
    const dlvd=(item.fob||0)+frt;
    
    const prod=(item.product||'').substring(0,15).padEnd(16);
    const qty=`${item.tls||1} TL`.padStart(6);
    const price=`$${dlvd}`.padStart(8);
    const ship=(item.shipWeek||'Prompt').padStart(8);
    
    txt+=`${prod}${qty}${price}${ship}\n`;
  });
  
  txt+=`${'‚îÄ'.repeat(36)}\nSubject to prior sale\nIan @ Buckeye`;
  
  return txt;
}

function generateAllQuotes(){
  const items=S.quoteItems.filter(i=>i.selected!==false);
  const customers=S.customers.filter(c=>c.type!=='mill'&&c.quoteSelected);
  
  if(!items.length){
    alert('No items selected');
    return;
  }
  if(!customers.length){
    alert('No customers selected');
    return;
  }
  
  // Find all unique origin‚Üídest pairs needed (check ALL locations per customer)
  const neededLanes=[];
  items.forEach(item=>{
    if(!item.origin)return;
    customers.forEach(cust=>{
      // Get ALL locations for multi-location customers
      const locs=cust.locations||[cust.destination].filter(Boolean);
      
      locs.forEach(dest=>{
        if(!dest)return;
        
        // Check if lane exists
        const existing=S.lanes.find(l=>
          l.origin.toLowerCase().trim()===item.origin.toLowerCase().trim()&&
          l.dest.toLowerCase().trim()===dest.toLowerCase().trim()
        );
        
        if(!existing){
          const key=`${item.origin}|${dest}`;
          if(!neededLanes.find(n=>n.key===key)){
            neededLanes.push({key,origin:item.origin,dest});
          }
        }
      });
    });
  });
  
  // If missing lanes, try API lookup first, then modal for failures
  if(neededLanes.length>0){
    lookupMileageWithAPI(neededLanes).then(failedLanes=>{
      if(failedLanes.length>0){
        // Show modal for lanes that couldn't be looked up
        showMileageModal(failedLanes,()=>{
          doGenerateQuotes(items,customers);
        });
      }else{
        doGenerateQuotes(items,customers);
      }
    });
  }else{
    doGenerateQuotes(items,customers);
  }
}

// Try to lookup mileage via API, return array of lanes that failed
async function lookupMileageWithAPI(lanes){
  const failedLanes=[];
  const statusEl=document.getElementById('quote-status');
  
  if(statusEl)statusEl.textContent=`Looking up ${lanes.length} lane(s)...`;
  
  // Try server API first, fall back to direct API calls
  try{
    const res=await fetch('/api/mileage/bulk',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({lanes})
    });
    
    if(res.ok){
      const data=await res.json();
      if(data.results){
        data.results.forEach(r=>{
          if(r.miles){
            S.lanes.push({origin:r.origin,dest:r.dest,miles:r.miles,added:new Date().toISOString()});
            console.log(`‚úì ${r.origin} ‚Üí ${r.dest}: ${r.miles} mi`);
          }else{
            failedLanes.push({origin:r.origin,dest:r.dest});
          }
        });
        save('lanes',S.lanes);
        if(statusEl)statusEl.textContent='';
        return failedLanes;
      }
    }
  }catch(e){
    console.log('Server API not available, trying direct lookup...');
  }
  
  // Fallback: Direct API calls from browser
  for(const lane of lanes){
    if(statusEl)statusEl.textContent=`Looking up ${lane.origin} ‚Üí ${lane.dest}...`;
    const miles=await getDirectMileage(lane.origin,lane.dest);
    if(miles){
      S.lanes.push({origin:lane.origin,dest:lane.dest,miles,added:new Date().toISOString()});
      console.log(`‚úì ${lane.origin} ‚Üí ${lane.dest}: ${miles} mi`);
    }else{
      failedLanes.push(lane);
    }
    await sleep(600); // Rate limit
  }
  save('lanes',S.lanes);
  
  if(statusEl)statusEl.textContent='';
  return failedLanes;
}

// Direct mileage lookup via free APIs (no backend needed)
async function getDirectMileage(origin,dest){
  try{
    // Step 1: Geocode origin
    const originCoords=await geocodeLocation(origin);
    if(!originCoords)return null;
    
    await sleep(500);
    
    // Step 2: Geocode destination
    const destCoords=await geocodeLocation(dest);
    if(!destCoords)return null;
    
    await sleep(300);
    
    // Step 3: Get driving distance via OSRM
    const coordsStr=`${originCoords.lon},${originCoords.lat};${destCoords.lon},${destCoords.lat}`;
    const routeRes=await fetch(`https://router.project-osrm.org/route/v1/driving/${coordsStr}?overview=false`);
    const routeData=await routeRes.json();
    
    if(routeData.code==='Ok'&&routeData.routes?.length){
      const meters=routeData.routes[0].distance;
      return Math.round(meters/1609.34);
    }
    return null;
  }catch(e){
    console.error('Direct mileage error:',e);
    return null;
  }
}

// Geocode cache
const geoCache={};

async function geocodeLocation(location){
  if(!location)return null;
  
  const key=location.toLowerCase().trim();
  if(geoCache[key])return geoCache[key];
  
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1&countrycodes=us`,{
      headers:{'User-Agent':'SYP-Analytics/1.0'}
    });
    const data=await res.json();
    
    if(data?.length){
      const coords={lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon)};
      geoCache[key]=coords;
      return coords;
    }
    return null;
  }catch(e){
    console.error('Geocode error:',e);
    return null;
  }
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms))}

// Single mileage lookup via server API (with fallback)
async function getMileageFromAPI(origin,dest){
  // Try server first
  try{
    const res=await fetch('/api/mileage',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({origin,dest})
    });
    
    if(res.ok){
      const data=await res.json();
      if(data.miles)return data.miles;
    }
  }catch(e){}
  
  // Fallback to direct
  return await getDirectMileage(origin,dest);
}

// Show modal for entering missing mileages (fallback)
function showMileageModal(lanes,callback){
  const html=`
    <div class="modal-overlay" onclick="if(event.target===this)closeMileageModal()">
      <div class="modal" style="width:450px">
        <div class="modal-header">
          <span class="modal-title" style="color:var(--warn)">üöö Enter Mileage</span>
          <button class="modal-close" onclick="closeMileageModal()">√ó</button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom:16px;color:var(--muted);font-size:11px">Auto-lookup failed for these lanes. Enter miles manually:</p>
          <div style="max-height:300px;overflow-y:auto">
            ${lanes.map((l,i)=>`
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:8px;background:var(--bg);border-radius:4px">
                <div style="flex:1;font-size:11px">
                  <div style="color:var(--text)">${l.origin}</div>
                  <div style="color:var(--muted)">‚Üí ${l.dest}</div>
                </div>
                <input type="number" id="lane-mi-${i}" placeholder="miles" style="width:70px;padding:6px;font-size:12px;text-align:right">
                <span style="color:var(--muted);font-size:10px">mi</span>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeMileageModal()">Cancel</button>
          <button class="btn btn-warn" onclick="saveMileagesAndGenerate()">Save & Generate</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('modal').innerHTML=html;
  
  window._mileageLanes=lanes;
  window._mileageCallback=callback;
  
  setTimeout(()=>{
    const first=document.getElementById('lane-mi-0');
    if(first)first.focus();
  },100);
}

function closeMileageModal(){
  document.getElementById('modal').innerHTML='';
  window._mileageLanes=null;
  window._mileageCallback=null;
}

function saveMileagesAndGenerate(){
  const lanes=window._mileageLanes||[];
  const callback=window._mileageCallback;
  
  lanes.forEach((l,i)=>{
    const input=document.getElementById(`lane-mi-${i}`);
    const miles=input?parseInt(input.value):0;
    if(miles>0){
      S.lanes.push({origin:l.origin,dest:l.dest,miles,added:new Date().toISOString()});
    }
  });
  
  save('lanes',S.lanes);
  closeMileageModal();
  
  if(callback)callback();
}

// Actually generate the quotes after mileage is collected
function doGenerateQuotes(items,customers){
  const statusEl=document.getElementById('quote-status');
  if(statusEl)statusEl.textContent='';
  
  // Save market blurb
  S.marketBlurb=document.getElementById('market-blurb')?.value||'';
  save('marketBlurb',S.marketBlurb);
  
  let allHTML='<html><body style="font-family:Calibri,Arial,sans-serif;">';
  let allText='';
  
  // Add market blurb if present
  if(S.marketBlurb){
    allText+=S.marketBlurb+'\n\n';
    allHTML+=`<p style="margin-bottom:16px;">${S.marketBlurb.replace(/\n/g,'<br>')}</p>`;
  }
  
  let quoteCount=0;
  
  customers.forEach((cust,i)=>{
    // Get all locations for this customer
    const locs=cust.locations||[cust.destination].filter(Boolean);
    
    if(locs.length===0)return;
    
    // Generate quote for each location
    locs.forEach((loc,j)=>{
      if(quoteCount>0){
        allText+='\n\n'+'‚ïê'.repeat(40)+'\n\n';
        allHTML+='<hr style="border:none;border-top:2px solid #ccc;margin:20px 0;">';
      }
      
      // Add customer name header if multi-location
      if(locs.length>1){
        allText+=`${cust.name} - ${loc}\n${'‚îÄ'.repeat(30)}\n`;
        allHTML+=`<p style="font-weight:bold;color:#1a5f7a;margin-bottom:4px;">${cust.name} - ${loc}</p>`;
      }
      
      allText+=generateQuoteText(items,cust,loc);
      allHTML+=generateQuoteHTML(items,loc);
      quoteCount++;
    });
  });
  
  allHTML+='</body></html>';
  
  // Copy HTML to clipboard for Outlook
  const htmlBlob=new Blob([allHTML],{type:'text/html'});
  const textBlob=new Blob([allText],{type:'text/plain'});
  
  navigator.clipboard.write([
    new ClipboardItem({
      'text/html':htmlBlob,
      'text/plain':textBlob
    })
  ]).then(()=>{
    alert(`Generated ${quoteCount} quotes for ${customers.length} customers!\nPaste into Outlook for formatted tables.`);
    render();
  }).catch(e=>{
    // Fallback to plain text
    navigator.clipboard.writeText(allText).then(()=>{
      alert(`Generated ${quoteCount} quotes (copied as text)`);
      render();
    });
  });
}

// Create single Outlook draft for first selected customer
function createSingleDraft(){
  const items=S.quoteItems.filter(i=>i.selected!==false);
  
  // Use single quote customer dropdown
  const custName=S.singleQuoteCustomer||document.getElementById('single-quote-customer')?.value;
  const customer=custName?S.customers.find(c=>c.name===custName):null;
  
  if(!items.length){
    alert('No items selected');
    return;
  }
  
  if(!customer){
    alert('Select a customer from the dropdown');
    return;
  }
  
  // Save market blurb
  S.marketBlurb=document.getElementById('market-blurb')?.value||'';
  save('marketBlurb',S.marketBlurb);
  
  const locs=customer?.locations||[customer?.destination].filter(Boolean);
  const dest=locs[0]||'TBD';
  const email=customer?.email||'';
  const customerName=customer?.name||'Customer';
  
  // Check for missing lanes first
  const neededLanes=[];
  items.forEach(item=>{
    if(!item.origin)return;
    const existing=S.lanes.find(l=>
      l.origin.toLowerCase().trim()===item.origin.toLowerCase().trim()&&
      l.dest.toLowerCase().trim()===dest.toLowerCase().trim()
    );
    if(!existing){
      const key=`${item.origin}|${dest}`;
      if(!neededLanes.find(n=>n.key===key)){
        neededLanes.push({key,origin:item.origin,dest});
      }
    }
  });
  
  if(neededLanes.length>0){
    lookupMileageWithAPI(neededLanes).then(failedLanes=>{
      if(failedLanes.length>0){
        showMileageModal(failedLanes,()=>doCreateSingleDraft(items,customer,dest,email,customerName));
      }else{
        doCreateSingleDraft(items,customer,dest,email,customerName);
      }
    });
  }else{
    doCreateSingleDraft(items,customer,dest,email,customerName);
  }
}

function doCreateSingleDraft(items,customer,dest,email,custName){
  // Build HTML for clipboard (for pasting into draft)
  const html=generateQuoteHTML(items,dest,true);
  const text=generateQuoteText(items,customer,dest,true);
  
  // Copy HTML to clipboard first
  const htmlBlob=new Blob([html],{type:'text/html'});
  const textBlob=new Blob([text],{type:'text/plain'});
  
  navigator.clipboard.write([
    new ClipboardItem({
      'text/html':htmlBlob,
      'text/plain':textBlob
    })
  ]).then(()=>{
    // Show alert first so user knows clipboard is ready
    alert('Quote copied to clipboard!\n\nOutlook will open - paste (Ctrl+V) into the email body.');
    
    // Now open mailto link
    const subject=encodeURIComponent(`SYP Availability - ${custName}`);
    const mailto=`mailto:${email}?subject=${subject}`;
    window.location.href=mailto;
  }).catch(e=>{
    console.error('Clipboard error:',e);
    // Fallback - just open mailto with text body (mailto has text limit so might truncate)
    alert('Could not copy formatted table. Opening email with plain text...');
    const subject=encodeURIComponent(`SYP Availability - ${custName}`);
    const encodedBody=encodeURIComponent(text);
    const mailto=`mailto:${email}?subject=${subject}&body=${encodedBody}`;
    window.location.href=mailto;
  });
}

// Check/Uncheck all quote customers
function uncheckAllQuoteCustomers(){
  S.customers.filter(c=>c.type!=='mill').forEach(c=>c.quoteSelected=false);
  save('customers',S.customers);
  saveCurrentProfileSelections();
  render();
}

function checkAllQuoteCustomers(){
  S.customers.filter(c=>c.type!=='mill').forEach(c=>c.quoteSelected=true);
  save('customers',S.customers);
  saveCurrentProfileSelections();
  render();
}

// Save market blurb on change
function saveMarketBlurb(){
  S.marketBlurb=document.getElementById('market-blurb')?.value||'';
  save('marketBlurb',S.marketBlurb);
}

// Quote Profile Management
function switchQuoteProfile(profileId){
  // Save current profile first before switching
  saveCurrentProfileSelections();
  
  S.quoteProfile=profileId;
  save('quoteProfile',profileId);
  
  // Update customer selections and items based on profile
  const profiles=S.quoteProfiles||{default:{name:'Default',customers:[],items:[]}};
  const profile=profiles[profileId];
  
  if(profile){
    // Load customers
    if(profile.customers){
      S.customers.forEach(c=>c.quoteSelected=false);
      profile.customers.forEach(custName=>{
        const cust=S.customers.find(c=>c.name===custName);
        if(cust)cust.quoteSelected=true;
      });
      save('customers',S.customers);
    }
    
    // Load items
    if(profile.items){
      S.quoteItems=JSON.parse(JSON.stringify(profile.items)); // Deep copy
      save('quoteItems',S.quoteItems);
    }
  }
  
  render();
}

function showNewProfileModal(){
  document.getElementById('modal').innerHTML=`
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="width:400px">
        <div class="modal-header">
          <span class="modal-title">New Quote Profile</span>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Profile Name</label>
            <input type="text" id="new-profile-name" placeholder="e.g. Truss Plants, Ohio Customers" style="width:100%;padding:8px">
          </div>
          <p style="font-size:11px;color:var(--muted);margin-top:12px">This will save the current products and customer selections to the new profile. You can modify them later.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeModal()">Cancel</button>
          <button class="btn btn-success" onclick="createNewProfile()">Create Profile</button>
        </div>
      </div>
    </div>`;
  setTimeout(()=>document.getElementById('new-profile-name')?.focus(),100);
}

function createNewProfile(){
  const name=document.getElementById('new-profile-name')?.value?.trim();
  if(!name){
    alert('Enter a profile name');
    return;
  }
  
  const id=name.toLowerCase().replace(/[^a-z0-9]/g,'-');
  
  if(!S.quoteProfiles)S.quoteProfiles={default:{name:'Default',customers:[],items:[]}};
  
  if(S.quoteProfiles[id]){
    alert('Profile already exists');
    return;
  }
  
  // Save current profile selections first
  saveCurrentProfileSelections();
  
  // Create new profile with current customers and items
  const selectedCustomers=S.customers.filter(c=>c.quoteSelected).map(c=>c.name);
  const currentItems=JSON.parse(JSON.stringify(S.quoteItems||[])); // Deep copy
  S.quoteProfiles[id]={name,customers:selectedCustomers,items:currentItems};
  save('quoteProfiles',S.quoteProfiles);
  
  // Switch to new profile
  S.quoteProfile=id;
  save('quoteProfile',id);
  
  closeModal();
  render();
}

function editCurrentProfile(){
  const profileId=S.quoteProfile||'default';
  const profiles=S.quoteProfiles||{default:{name:'Default',customers:[],items:[]}};
  const profile=profiles[profileId];
  
  document.getElementById('modal').innerHTML=`
    <div class="modal-overlay" onclick="closeModal()">
      <div class="modal" onclick="event.stopPropagation()" style="width:500px">
        <div class="modal-header">
          <span class="modal-title">Edit Profile: ${profile.name}</span>
          <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Profile Name</label>
            <input type="text" id="edit-profile-name" value="${profile.name}" style="width:100%;padding:8px" ${profileId==='default'?'disabled':''}>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <div>
              <label class="form-label">Customers (${profile.customers?.length||0})</label>
              <div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;padding:8px">
                ${profile.customers?.length?profile.customers.map(c=>`<div style="padding:2px 0;font-size:11px">${c}</div>`).join(''):'<div style="color:var(--muted);font-size:11px">No customers</div>'}
              </div>
            </div>
            <div>
              <label class="form-label">Products (${profile.items?.length||0})</label>
              <div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;padding:8px">
                ${profile.items?.length?profile.items.map(i=>`<div style="padding:2px 0;font-size:11px">${i.product||'‚Äî'} from ${i.origin||'‚Äî'}</div>`).join(''):'<div style="color:var(--muted);font-size:11px">No products</div>'}
              </div>
            </div>
          </div>
          <p style="font-size:11px;color:var(--muted);margin-top:12px">Products and customers are auto-saved when you modify the quote table or recipient selections.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeModal()">Cancel</button>
          <button class="btn btn-success" onclick="saveProfileEdit('${profileId}')">Save</button>
        </div>
      </div>
    </div>`;
}

function saveProfileEdit(profileId){
  const name=document.getElementById('edit-profile-name')?.value?.trim();
  if(!name){
    alert('Enter a profile name');
    return;
  }
  
  if(!S.quoteProfiles)S.quoteProfiles={default:{name:'Default',customers:[]}};
  if(S.quoteProfiles[profileId]){
    S.quoteProfiles[profileId].name=name;
    save('quoteProfiles',S.quoteProfiles);
  }
  
  closeModal();
  render();
}

function deleteCurrentProfile(){
  const profileId=S.quoteProfile||'default';
  if(profileId==='default'){
    alert('Cannot delete default profile');
    return;
  }
  
  if(!confirm(`Delete profile "${S.quoteProfiles[profileId]?.name}"?`))return;
  
  delete S.quoteProfiles[profileId];
  save('quoteProfiles',S.quoteProfiles);
  
  S.quoteProfile='default';
  save('quoteProfile','default');
  
  switchQuoteProfile('default');
}

function saveCurrentProfileSelections(){
  const profileId=S.quoteProfile||'default';
  if(!S.quoteProfiles)S.quoteProfiles={default:{name:'Default',customers:[],items:[]}};
  if(!S.quoteProfiles[profileId])S.quoteProfiles[profileId]={name:'Default',customers:[],items:[]};
  
  const selectedCustomers=S.customers.filter(c=>c.quoteSelected).map(c=>c.name);
  const currentItems=JSON.parse(JSON.stringify(S.quoteItems||[])); // Deep copy
  
  S.quoteProfiles[profileId].customers=selectedCustomers;
  S.quoteProfiles[profileId].items=currentItems;
  save('quoteProfiles',S.quoteProfiles);
}

// Override toggleQuoteCustomer to save profile selections
const originalToggleQuoteCustomer=typeof toggleQuoteCustomer==='function'?toggleQuoteCustomer:null;

// AI price selected items using Claude API for smart suggestions
async function aiPriceSelected(){
  const rl=S.rl.length?S.rl[S.rl.length-1]:null;
  if(!rl){
    alert('No RL data available. Import Random Lengths data first for AI pricing.');
    return;
  }
  
  // Prompt for API key if not set
  if(!S.apiKey){
    const key=prompt('Enter your Claude API key for smart pricing:\n\n(Get one at console.anthropic.com/settings/keys)\n\nThis will be saved for future use.');
    if(!key){
      alert('API key required for AI pricing.');
      return;
    }
    S.apiKey=key;
    save('apiKey',S.apiKey);
  }
  
  const selected=S.quoteItems.filter(i=>i.selected!==false&&i.product);
  if(!selected.length){
    alert('No items selected');
    return;
  }
  
  // Build context for Claude
  const itemsList=selected.map(item=>{
    const parsed=parseProductString(item.product);
    const region=getRegionFromOrigin(item.origin);
    const rlPrice=getRLPrice(rl,parsed.base,parsed.length,region);
    return`- ${item.product} from ${item.origin} (${region} region), ${item.tls} TL, RL Print: $${rlPrice||'N/A'}, Current Sell: $${item.fob||'not set'}, Is Short: ${item.isShort?'Yes':'No'}`;
  }).join('\n');
  
  const prompt=`You are a lumber pricing assistant for a Southern Yellow Pine trader. Help me set FOB sell prices for these quote items.

Current Random Lengths prices (${rl.date}):
- West (LA, AR, TX): 2x4#2=$${rl.west?.['2x4#2']||'N/A'}, 2x6#2=$${rl.west?.['2x6#2']||'N/A'}
- Central (MS, AL): 2x4#2=$${rl.central?.['2x4#2']||'N/A'}, 2x6#2=$${rl.central?.['2x6#2']||'N/A'}
- East (NC, SC, FL, GA): 2x4#2=$${rl.east?.['2x4#2']||'N/A'}, 2x6#2=$${rl.east?.['2x6#2']||'N/A'}

Items to price:
${itemsList}

For each item, suggest a competitive FOB sell price considering:
1. The RL print price for that region
2. Typical market dynamics (shorts command 10-20 below print, 8s at print, 10s slight premium, 12+ progressively higher)
3. Length premiums: 8' at/below composite, 10' at composite, 12' +$5-10, 14' +$15-25, 16' +$20-35, 18'+ even higher
4. For short/spec positions, price more aggressively (closer to or at RL)
5. Market is currently ${rl.west?.['2x4#2']>420?'strong - can price higher':'soft - stay competitive'}

Respond with ONLY a JSON array, no explanation:
[{"product":"exact product name","suggestedFOB":000,"reasoning":"brief 5-word max note"}]`;

  try{
    document.body.style.cursor='wait';
    const statusEl=document.getElementById('quote-status');
    if(statusEl)statusEl.textContent='ü§ñ AI analyzing prices...';
    
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':S.apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:2000,
        messages:[{role:'user',content:prompt}]
      })
    });
    
    const data=await res.json();
    document.body.style.cursor='default';
    if(statusEl)statusEl.textContent='';
    
    if(data.error){
      alert('API Error: '+data.error.message);
      return;
    }
    
    const text=data.content?.[0]?.text||'';
    // Extract JSON from response
    const jsonMatch=text.match(/\[[\s\S]*\]/);
    if(jsonMatch){
      const results=JSON.parse(jsonMatch[0]);
      let updated=0;
      
      results.forEach(r=>{
        // Find matching item
        const item=S.quoteItems.find(i=>
          i.product&&i.product.toLowerCase().includes(r.product.toLowerCase().substring(0,8))
        );
        if(item&&r.suggestedFOB){
          item.fob=Math.round(r.suggestedFOB);
          updated++;
        }
      });
      
      save('quoteItems',S.quoteItems);
      saveCurrentProfileSelections();
      render();
      alert(`AI priced ${updated} items. Review and adjust as needed.`);
    }else{
      alert('Could not parse AI response. Try again.');
    }
  }catch(e){
    document.body.style.cursor='default';
    console.error('Claude API error:',e);
    alert('API error: '+e.message);
  }
}

function aiPriceAll(){
  // Get latest RL data for pricing reference
  const rl=S.rl.length?S.rl[S.rl.length-1]:null;
  if(!rl){
    alert('No RL data available. Import Random Lengths data first for AI pricing.');
    return;
  }
  
  S.quoteItems.forEach(item=>{
    if(!item.product)return;
    
    // Parse product string to extract base product and length
    const parsed=parseProductString(item.product);
    const region=getRegionFromOrigin(item.origin);
    const rlPrice=getRLPrice(rl,parsed.base,parsed.length,region);
    
    if(item.isShort){
      // AI Short: estimate cost from RL - typical spread
      const spread=getHistoricalSpread(parsed.base)||(-8);
      const estCost=rlPrice?(rlPrice+spread):item.cost||380;
      const targetMargin=35;
      item.cost=Math.round(estCost);
      item.fob=Math.round(estCost+targetMargin);
      item.rlRef=rlPrice;
    }else{
      // Known cost: suggest FOB based on target margin
      if(item.cost){
        const targetMargin=30;
        item.fob=Math.round(item.cost+targetMargin);
      }else if(rlPrice){
        // No cost entered, use RL as reference
        const spread=getHistoricalSpread(parsed.base)||(-10);
        item.cost=Math.round(rlPrice+spread);
        item.fob=Math.round(item.cost+30);
      }
      item.rlRef=rlPrice;
    }
  });
  
  save('quoteItems',S.quoteItems);
  saveCurrentProfileSelections();
  render();
}

// Parse product string like "2x4 8' #2" or "2x4 #2 16'" into components
function parseProductString(str){
  const s=(str||'').toLowerCase().replace(/['''`]/g,"'");
  let base='2x4#2',length=null,region='west';
  
  // Extract size (2x4, 2x6, etc)
  const sizeMatch=s.match(/(2x4|2x6|2x8|2x10|2x12|4x4|4x6)/);
  const size=sizeMatch?sizeMatch[1]:'2x4';
  
  // Extract grade (#1, #2, #3, MSR, 2400f)
  let grade='#2';
  if(s.includes('#1')||s.includes('no.1')||s.includes('no 1'))grade='#1';
  else if(s.includes('#3')||s.includes('no.3')||s.includes('no 3'))grade='#3';
  else if(s.includes('msr')||s.includes('2400'))grade='MSR';
  
  base=size+grade;
  
  // Extract length - handle multiple formats: "8'", "16'", "8 ft", etc.
  // First try to find a number followed by ' or before #
  const lenMatch=s.match(/(\d{1,2})[']/)||s.match(/\s(\d{1,2})\s*#/)||s.match(/(\d{1,2})\s*ft/)||s.match(/(\d{1,2})\s*foot/);
  if(lenMatch){
    length=lenMatch[1];
  }else if(s.includes('rl')||s.includes('random')||!s.match(/\d{1,2}/)){
    length='RL';
  }else{
    // Try to find standalone number that looks like a length (8,10,12,14,16,18,20)
    const numMatch=s.match(/\b(8|10|12|14|16|18|20)\b/);
    if(numMatch)length=numMatch[1];
  }
  
  return{base,length,region,size,grade};
}

// Get RL price for product, checking specific length first (matches findRLPrice logic)
function getRLPrice(rl,base,length,region){
  if(!rl)return null;
  
  // Normalize length: "16'" -> "16", handle null/RL
  let normLen=(length||'').toString().replace(/[^0-9]/g,'');
  if(!normLen||length==='RL')normLen=null;
  
  // Normalize product: "2x4#2", "2x4 #2" -> "2x4#2"
  let normProd=(base||'').replace(/\s+/g,'');
  if(!normProd.includes('#')&&!normProd.toLowerCase().includes('msr'))normProd+='#2';
  
  // Handle MSR products
  const isMSR=normProd.toLowerCase().includes('msr')||normProd.toLowerCase().includes('2400');
  if(isMSR){
    const baseMatch=normProd.match(/(\d+x\d+)/i);
    if(baseMatch){
      const baseSize=baseMatch[1].toLowerCase();
      // Try #1 grade for MSR base
      if(normLen&&rl.specified_lengths?.[region]?.[baseSize+'#1']?.[normLen]){
        return rl.specified_lengths[region][baseSize+'#1'][normLen];
      }
      if(rl[region]?.[baseSize+'#1'])return rl[region][baseSize+'#1'];
      // Fallback to #2
      if(normLen&&rl.specified_lengths?.[region]?.[baseSize+'#2']?.[normLen]){
        return rl.specified_lengths[region][baseSize+'#2'][normLen];
      }
      if(rl[region]?.[baseSize+'#2'])return rl[region][baseSize+'#2'];
    }
    return null;
  }
  
  // Standard product: try specified lengths first
  if(normLen&&rl.specified_lengths?.[region]?.[normProd]?.[normLen]){
    return rl.specified_lengths[region][normProd][normLen];
  }
  
  // Try with different product key formats
  const prodVariants=[normProd,normProd.toLowerCase(),normProd.toUpperCase()];
  for(const pv of prodVariants){
    if(normLen&&rl.specified_lengths?.[region]?.[pv]?.[normLen]){
      return rl.specified_lengths[region][pv][normLen];
    }
  }
  
  // Fall back to composite price
  if(rl[region]?.[normProd])return rl[region][normProd];
  
  // Try other regions
  for(const r of['west','central','east']){
    if(rl[r]?.[normProd])return rl[r][normProd];
  }
  
  return null;
}

// Get historical spread for a product (how much below RL we typically buy)
function getHistoricalSpread(baseProduct){
  if(!S.buys.length||!S.rl.length)return -8;
  
  const normBase=baseProduct.replace(/\s+/g,'').toLowerCase();
  let totalSpread=0,count=0;
  
  S.buys.forEach(buy=>{
    const buyProd=(buy.product||'').replace(/\s+/g,'').toLowerCase();
    if(!buyProd.includes(normBase.replace('#','')))return;
    
    // Find RL report for this buy date
    const rl=S.rl.slice().reverse().find(r=>new Date(r.date)<=new Date(buy.date));
    if(!rl)return;
    
    const rlPrice=getRLPrice(rl,baseProduct,buy.length,buy.region||'west');
    if(rlPrice&&buy.price){
      totalSpread+=buy.price-rlPrice;
      count++;
    }
  });
  
  return count>0?Math.round(totalSpread/count):-8;
}

// Claude API pricing - smart FOB suggestions
async function aiPriceWithClaude(){
  if(!S.apiKey){
    alert('Please set your Claude API key in Settings first.');
    return;
  }
  
  const items=S.quoteItems.filter(i=>i.selected!==false);
  if(!items.length){
    alert('No items selected for AI pricing.');
    return;
  }
  
  // Get latest RL data
  const rl=S.rl.length?S.rl[S.rl.length-1]:null;
  
  // Build context for Claude
  const rlContext=rl?`Current Random Lengths prices (${rl.date}):
West: 2x4#2=$${rl.west?.['2x4#2']||'N/A'}, 2x6#2=$${rl.west?.['2x6#2']||'N/A'}, 2x8#2=$${rl.west?.['2x8#2']||'N/A'}
Central: 2x4#2=$${rl.central?.['2x4#2']||'N/A'}, 2x6#2=$${rl.central?.['2x6#2']||'N/A'}
East: 2x4#2=$${rl.east?.['2x4#2']||'N/A'}, 2x6#2=$${rl.east?.['2x6#2']||'N/A'}`:'No RL data available.';

  // Get historical margins
  const avgMargin=calcAvgHistoricalMargin();
  
  const itemsList=items.map(i=>`- ${i.product} from ${i.origin}, ${i.tls} TL, Cost: $${i.cost||'unknown'}, Current FOB: $${i.fob||'not set'}, Is Short: ${i.isShort?'Yes':'No'}`).join('\n');
  
  const prompt=`You are a lumber pricing assistant for a Southern Yellow Pine trader. Help me set FOB prices for these quote items.

${rlContext}

Historical average margin: $${avgMargin}/MBF

Items to price:
${itemsList}

For each item, suggest an FOB price that:
1. For known-cost items: targets a healthy margin ($25-40/MBF depending on product)
2. For short/spec items: estimates cost from RL print minus typical spread ($5-15 below), then adds margin
3. Considers that specific lengths command premiums (16', 20' are premium vs RL composite)
4. MSR/2400f products typically have $40-80 premium over standard

Respond with JSON only, no explanation:
{"prices": [{"product": "...", "suggestedFOB": 000, "estimatedCost": 000, "reasoning": "brief note"}]}`;

  try{
    document.body.style.cursor='wait';
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':S.apiKey,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:2000,
        messages:[{role:'user',content:prompt}]
      })
    });
    
    const data=await res.json();
    document.body.style.cursor='default';
    
    if(data.error){
      alert('API Error: '+data.error.message);
      return;
    }
    
    const text=data.content?.[0]?.text||'';
    // Extract JSON from response
    const jsonMatch=text.match(/\{[\s\S]*\}/);
    if(jsonMatch){
      const result=JSON.parse(jsonMatch[0]);
      if(result.prices){
        // Apply suggested prices
        result.prices.forEach(p=>{
          const item=S.quoteItems.find(i=>i.product===p.product||(i.product||'').toLowerCase().includes((p.product||'').toLowerCase().substring(0,8)));
          if(item){
            if(p.suggestedFOB)item.fob=Math.round(p.suggestedFOB);
            if(p.estimatedCost&&item.isShort)item.cost=Math.round(p.estimatedCost);
          }
        });
        save('quoteItems',S.quoteItems);
        saveCurrentProfileSelections();
        render();
        alert('AI pricing applied! Review and adjust as needed.');
      }
    }else{
      alert('Could not parse AI response. Using standard pricing instead.');
      aiPriceAll();
    }
  }catch(e){
    document.body.style.cursor='default';
    console.error('Claude API error:',e);
    alert('API error: '+e.message+'. Using standard pricing instead.');
    aiPriceAll();
  }
}

function calcAvgHistoricalMargin(){
  const buyByOrder={};
  S.buys.forEach(b=>{
    const ord=String(b.orderNum||b.po||'').trim();
    if(ord)buyByOrder[ord]=b;
  });
  
  let totalMargin=0,count=0;
  S.sells.forEach(s=>{
    const ord=String(s.orderNum||s.linkedPO||s.oc||'').trim();
    const buy=ord?buyByOrder[ord]:null;
    if(buy){
      const fob=(s.price||0)-(s.volume>0?(s.freight||0)/s.volume:0);
      const cost=(buy.price||0)+(buy.volume>0?(buy.freight||0)/buy.volume:0);
      totalMargin+=fob-cost;
      count++;
    }
  });
  
  return count>0?Math.round(totalMargin/count):30;
}

function toggleBuyOptions(){
  const product=document.getElementById('m-product')?.value||'';
  const length=document.getElementById('m-length')?.value||'';
  const region=document.getElementById('m-region')?.value||'west';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const isRL=length==='RL';
  
  // Show/hide sections based on product type and length
  document.getElementById('msr-section').style.display=(isMSR&&!isRL)?'block':'none';
  document.getElementById('standard-price').style.display=(isMSR||isRL)?'none':'block';
  document.getElementById('rl-tally-section').style.display=isRL?'block':'none';
  
  // Update tally header for MSR
  if(isRL){
    const priceHeader=document.getElementById('tally-price-header');
    const baseHeader=document.getElementById('tally-base-header');
    const premHeader=document.getElementById('tally-prem-header');
    const avgBase=document.getElementById('tally-avg-base');
    const avgPrem=document.getElementById('tally-avg-prem');
    
    if(priceHeader)priceHeader.textContent=isMSR?'Your $/MBF':'$/MBF';
    ['8','10','12','14','16','18','20'].forEach(len=>{
      const baseEl=document.getElementById(`tally-base-${len}`);
      const premEl=document.getElementById(`tally-prem-${len}`);
      if(baseEl)baseEl.style.display=isMSR?'table-cell':'none';
      if(premEl)premEl.style.display=isMSR?'table-cell':'none';
    });
    if(baseHeader)baseHeader.style.display=isMSR?'table-cell':'none';
    if(premHeader)premHeader.style.display=isMSR?'table-cell':'none';
    if(avgBase)avgBase.style.display=isMSR?'table-cell':'none';
    if(avgPrem)avgPrem.style.display=isMSR?'table-cell':'none';
    
    // Recalculate tally to show base prices
    if(isMSR)calcTallyTotal();
  }
  
  // Auto-fill #1 base price for single-length MSR products
  if(isMSR&&!isRL&&S.rl.length>0){
    const latestRL=S.rl[S.rl.length-1];
    const baseMatch=product.match(/(\d+x\d+)/i);
    if(baseMatch){
      const baseSize=baseMatch[1].toLowerCase();
      const normLen=length.replace(/[^0-9]/g,'');
      let basePrice=null;
      let source='';
      
      // Try specified lengths first with #1
      if(normLen&&latestRL.specified_lengths?.[region]?.[baseSize+'#1']?.[normLen]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#1'][normLen];
        source=`${baseSize}#1 @ ${normLen}'`;
      }
      // Try specified lengths with #2 as fallback
      else if(normLen&&latestRL.specified_lengths?.[region]?.[baseSize+'#2']?.[normLen]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#2'][normLen];
        source=`${baseSize}#2 @ ${normLen}'`;
      }
      // Try composite #1
      else if(latestRL[region]?.[baseSize+'#1']){
        basePrice=latestRL[region][baseSize+'#1'];
        source=`${baseSize}#1 composite`;
      }
      // Try composite #2
      else if(latestRL[region]?.[baseSize+'#2']){
        basePrice=latestRL[region][baseSize+'#2'];
        source=`${baseSize}#2 composite`;
      }
      
      if(basePrice){
        document.getElementById('m-basePrice').value=basePrice;
        calcMSRPremium();
        const srcInfo=document.getElementById('msr-source');
        if(srcInfo)srcInfo.textContent=`RL ${latestRL.date} | ${region} | ${source} = $${basePrice}`;
      }
    }
  }
}

function calcMSRPremium(){
  const base=parseFloat(document.getElementById('m-basePrice')?.value)||0;
  const price=parseFloat(document.getElementById('m-price')?.value)||0;
  const premium=price-base;
  document.getElementById('m-msrPremium').value=premium>0?premium:0;
}

function toggleTally(){
  const useTally=document.getElementById('m-useTally')?.checked;
  document.getElementById('tally-grid').style.display=useTally?'block':'none';
}

function calcTallyTotal(){
  const product=document.getElementById('m-product')?.value||'';
  const region=document.getElementById('m-region')?.value||'west';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const baseMatch=product.match(/(\d+x\d+)/i);
  const baseSize=baseMatch?baseMatch[1].toLowerCase():'2x4';
  
  // Get latest RL for base prices
  const latestRL=S.rl.length?S.rl[S.rl.length-1]:null;
  
  let totalVol=0,totalVal=0,totalBaseVal=0;
  ['8','10','12','14','16','18','20'].forEach(len=>{
    const vol=parseFloat(document.getElementById(`tally-vol-${len}`)?.value)||0;
    const price=parseFloat(document.getElementById(`tally-price-${len}`)?.value)||0;
    const val=vol*price;
    document.getElementById(`tally-val-${len}`).textContent=val>0?fmt(Math.round(val)):'‚Äî';
    totalVol+=vol;
    totalVal+=val;
    
    // For MSR, show base #1 price for each length
    if(isMSR&&latestRL){
      let basePrice=null;
      // Try #1 first
      if(latestRL.specified_lengths?.[region]?.[baseSize+'#1']?.[len]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#1'][len];
      }
      // Fall back to #2
      else if(latestRL.specified_lengths?.[region]?.[baseSize+'#2']?.[len]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#2'][len];
      }
      
      const baseEl=document.getElementById(`tally-base-${len}`);
      const premEl=document.getElementById(`tally-prem-${len}`);
      if(baseEl&&basePrice){
        baseEl.textContent='$'+basePrice;
        if(premEl&&price>0){
          const prem=price-basePrice;
          premEl.textContent=(prem>=0?'+':'')+fmt(prem);
          premEl.style.color=prem>=0?'var(--accent)':'var(--negative)';
        }else if(premEl){
          premEl.textContent='‚Äî';
        }
        totalBaseVal+=basePrice*vol;
      }else if(baseEl){
        baseEl.textContent='‚Äî';
        if(premEl)premEl.textContent='‚Äî';
      }
    }
  });
  
  document.getElementById('tally-total-vol').textContent=totalVol>0?totalVol.toFixed(1):'‚Äî';
  document.getElementById('tally-avg-price').textContent=totalVol>0?fmt(Math.round(totalVal/totalVol)):'‚Äî';
  document.getElementById('tally-total-val').textContent=totalVal>0?fmt(Math.round(totalVal)):'‚Äî';
  
  // MSR averages
  if(isMSR){
    const avgBaseEl=document.getElementById('tally-avg-base');
    const avgPremEl=document.getElementById('tally-avg-prem');
    if(avgBaseEl&&totalVol>0&&totalBaseVal>0){
      const avgBase=totalBaseVal/totalVol;
      avgBaseEl.textContent=fmt(Math.round(avgBase));
      if(avgPremEl){
        const avgPrem=(totalVal/totalVol)-avgBase;
        avgPremEl.textContent=(avgPrem>=0?'+':'')+fmt(Math.round(avgPrem));
      }
    }
  }
  
  // Update main volume and price fields
  if(totalVol>0){
    document.getElementById('m-volume').value=totalVol.toFixed(1);
    document.getElementById('m-price-std').value=Math.round(totalVal/totalVol);
    // For MSR RL, also update the hidden price field
    if(isMSR){
      document.getElementById('m-price').value=Math.round(totalVal/totalVol);
      // Store weighted avg base price
      if(totalBaseVal>0){
        document.getElementById('m-basePrice').value=Math.round(totalBaseVal/totalVol);
        calcMSRPremium();
      }
    }
  }
}

// SELL MODAL FUNCTIONS (mirror of buy functions)
function toggleSellOptions(){
  const product=document.getElementById('m-product')?.value||'';
  const length=document.getElementById('m-length')?.value||'';
  const region=document.getElementById('m-region')?.value||'west';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const isRL=length==='RL';
  
  // Show/hide sections based on product type and length
  const msrSection=document.getElementById('msr-section-sell');
  const stdPrice=document.getElementById('standard-price-sell');
  const rlTally=document.getElementById('rl-tally-section-sell');
  
  if(msrSection)msrSection.style.display=(isMSR&&!isRL)?'block':'none';
  if(stdPrice)stdPrice.style.display=(isMSR||isRL)?'none':'block';
  if(rlTally)rlTally.style.display=isRL?'block':'none';
  
  // Update tally header for MSR
  if(isRL){
    const priceHeader=document.getElementById('tally-price-header-sell');
    const baseHeader=document.getElementById('tally-base-header-sell');
    const premHeader=document.getElementById('tally-prem-header-sell');
    const avgBase=document.getElementById('tally-avg-base');
    const avgPrem=document.getElementById('tally-avg-prem');
    
    if(priceHeader)priceHeader.textContent=isMSR?'Your $/MBF':'$/MBF DLVD';
    ['8','10','12','14','16','18','20'].forEach(len=>{
      const baseEl=document.getElementById(`tally-base-${len}`);
      const premEl=document.getElementById(`tally-prem-${len}`);
      if(baseEl)baseEl.style.display=isMSR?'table-cell':'none';
      if(premEl)premEl.style.display=isMSR?'table-cell':'none';
    });
    if(baseHeader)baseHeader.style.display=isMSR?'table-cell':'none';
    if(premHeader)premHeader.style.display=isMSR?'table-cell':'none';
    if(avgBase)avgBase.style.display=isMSR?'table-cell':'none';
    if(avgPrem)avgPrem.style.display=isMSR?'table-cell':'none';
    
    // Recalculate tally to show base prices
    if(isMSR)calcSellTallyTotal();
  }
  
  // Auto-fill #1 base price for single-length MSR products
  if(isMSR&&!isRL&&S.rl.length>0){
    const latestRL=S.rl[S.rl.length-1];
    const baseMatch=product.match(/(\d+x\d+)/i);
    if(baseMatch){
      const baseSize=baseMatch[1].toLowerCase();
      const normLen=length.replace(/[^0-9]/g,'');
      let basePrice=null;
      let source='';
      
      // Try specified lengths first with #1
      if(normLen&&latestRL.specified_lengths?.[region]?.[baseSize+'#1']?.[normLen]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#1'][normLen];
        source=`${baseSize}#1 @ ${normLen}'`;
      }
      // Try specified lengths with #2 as fallback
      else if(normLen&&latestRL.specified_lengths?.[region]?.[baseSize+'#2']?.[normLen]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#2'][normLen];
        source=`${baseSize}#2 @ ${normLen}'`;
      }
      // Try composite #1
      else if(latestRL[region]?.[baseSize+'#1']){
        basePrice=latestRL[region][baseSize+'#1'];
        source=`${baseSize}#1 composite`;
      }
      // Try composite #2
      else if(latestRL[region]?.[baseSize+'#2']){
        basePrice=latestRL[region][baseSize+'#2'];
        source=`${baseSize}#2 composite`;
      }
      
      if(basePrice){
        document.getElementById('m-basePrice').value=basePrice;
        calcSellMSRPremium();
        const srcInfo=document.getElementById('msr-source-sell');
        if(srcInfo)srcInfo.textContent=`RL ${latestRL.date} | ${region} | ${source} = $${basePrice}`;
      }
    }
  }
  
  updateSellCalc();
}

function calcSellMSRPremium(){
  const base=parseFloat(document.getElementById('m-basePrice')?.value)||0;
  const price=parseFloat(document.getElementById('m-price')?.value)||0;
  const freight=parseFloat(document.getElementById('m-freight')?.value)||0;
  const volume=parseFloat(document.getElementById('m-volume')?.value)||0;
  const freightPerMBF=volume>0?freight/volume:0;
  // Premium is DLVD price minus freight minus base
  const fob=price-freightPerMBF;
  const premium=fob-base;
  document.getElementById('m-msrPremium').value=Math.round(premium);
}

function toggleSellTally(){
  const useTally=document.getElementById('m-useTally')?.checked;
  const tallyGrid=document.getElementById('tally-grid-sell');
  if(tallyGrid)tallyGrid.style.display=useTally?'block':'none';
}

function calcSellTallyTotal(){
  const product=document.getElementById('m-product')?.value||'';
  const region=document.getElementById('m-region')?.value||'west';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const baseMatch=product.match(/(\d+x\d+)/i);
  const baseSize=baseMatch?baseMatch[1].toLowerCase():'2x4';
  
  // Get latest RL for base prices
  const latestRL=S.rl.length?S.rl[S.rl.length-1]:null;
  
  let totalVol=0,totalVal=0,totalBaseVal=0;
  ['8','10','12','14','16','18','20'].forEach(len=>{
    const vol=parseFloat(document.getElementById(`tally-vol-${len}`)?.value)||0;
    const price=parseFloat(document.getElementById(`tally-price-${len}`)?.value)||0;
    const val=vol*price;
    document.getElementById(`tally-val-${len}`).textContent=val>0?fmt(Math.round(val)):'‚Äî';
    totalVol+=vol;
    totalVal+=val;
    
    // For MSR, show base #1 price for each length
    if(isMSR&&latestRL){
      let basePrice=null;
      // Try #1 first
      if(latestRL.specified_lengths?.[region]?.[baseSize+'#1']?.[len]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#1'][len];
      }
      // Fall back to #2
      else if(latestRL.specified_lengths?.[region]?.[baseSize+'#2']?.[len]){
        basePrice=latestRL.specified_lengths[region][baseSize+'#2'][len];
      }
      
      const baseEl=document.getElementById(`tally-base-${len}`);
      const premEl=document.getElementById(`tally-prem-${len}`);
      if(baseEl&&basePrice){
        baseEl.textContent='$'+basePrice;
        if(premEl&&price>0){
          const prem=price-basePrice;
          premEl.textContent=(prem>=0?'+':'')+fmt(prem);
          premEl.style.color=prem>=0?'var(--accent)':'var(--negative)';
        }else if(premEl){
          premEl.textContent='‚Äî';
        }
        totalBaseVal+=basePrice*vol;
      }else if(baseEl){
        baseEl.textContent='‚Äî';
        if(premEl)premEl.textContent='‚Äî';
      }
    }
  });
  
  document.getElementById('tally-total-vol').textContent=totalVol>0?totalVol.toFixed(1):'‚Äî';
  document.getElementById('tally-avg-price').textContent=totalVol>0?fmt(Math.round(totalVal/totalVol)):'‚Äî';
  document.getElementById('tally-total-val').textContent=totalVal>0?fmt(Math.round(totalVal)):'‚Äî';
  
  // MSR averages
  if(isMSR){
    const avgBaseEl=document.getElementById('tally-avg-base');
    const avgPremEl=document.getElementById('tally-avg-prem');
    if(avgBaseEl&&totalVol>0&&totalBaseVal>0){
      const avgBase=totalBaseVal/totalVol;
      avgBaseEl.textContent=fmt(Math.round(avgBase));
      if(avgPremEl){
        const avgPrem=(totalVal/totalVol)-avgBase;
        avgPremEl.textContent=(avgPrem>=0?'+':'')+fmt(Math.round(avgPrem));
      }
    }
  }
  
  // Update main volume and price fields
  if(totalVol>0){
    document.getElementById('m-volume').value=totalVol.toFixed(1);
    const avgPrice=Math.round(totalVal/totalVol);
    const stdPriceEl=document.getElementById('m-price-std');
    if(stdPriceEl)stdPriceEl.value=avgPrice;
    // For MSR RL, also update the main price field
    if(isMSR){
      document.getElementById('m-price').value=avgPrice;
      // Store weighted avg base price
      if(totalBaseVal>0){
        document.getElementById('m-basePrice').value=Math.round(totalBaseVal/totalVol);
        calcSellMSRPremium();
      }
    }
  }
  
  updateSellCalc();
}

function showSellModal(s=null){
  // Build product list from RL data + defaults
  const rlProducts=new Set(PRODUCTS);
  S.rl.forEach(r=>{
    ['west','central','east'].forEach(reg=>{
      if(r[reg])Object.keys(r[reg]).forEach(p=>rlProducts.add(p));
      if(r.specified_lengths?.[reg])Object.keys(r.specified_lengths[reg]).forEach(p=>rlProducts.add(p));
      if(r.timbers?.[reg])Object.keys(r.timbers[reg]).forEach(p=>rlProducts.add(p));
    });
  });
  ['2x4#1','2x4#2','2x4#3','2x6#1','2x6#2','2x6#3','2x8#2','2x8#3','2x10#2','2x10#3','2x12#2','2x12#3','4x4#2','4x6','6x6','2x4 MSR','2x6 MSR','2x8 MSR','2x10 MSR','2x12 MSR','2x4 2400f','2x6 2400f','2x8 2400f','2x10 2400f'].forEach(p=>rlProducts.add(p));
  const prodList=[...rlProducts].sort();
  
  // Build destination list from CRM and previous sells
  const dests=[...new Set([...S.customers.flatMap(c=>c.locations||[c.destination]).filter(Boolean),...S.sells.map(x=>x.destination).filter(Boolean)])].sort();
  
  // Customer list from CRM
  const custList=[...new Set([...S.customers.map(c=>c.name),...S.sells.map(x=>x.customer).filter(Boolean)])].sort();
  
  // Get available buys (with volume remaining) - using orderNum, normalized to strings
  const orderSold={};
  S.sells.filter(x=>x.id!==s?.id).forEach(x=>{
    const ord=String(x.orderNum||x.linkedPO||x.oc||'').trim();
    if(ord)orderSold[ord]=(orderSold[ord]||0)+(x.volume||0);
  });
  const availBuys=S.buys.map(b=>{
    const ord=String(b.orderNum||b.po||'').trim();
    const sold=orderSold[ord]||0;
    const avail=(b.volume||0)-sold;
    return{...b,ord,sold,avail};
  }).filter(b=>b.ord&&b.avail>0);
  
  // Check if editing MSR or RL product
  const isMSR=s?.product?.toUpperCase().includes('MSR')||s?.product?.toUpperCase().includes('2400');
  const isRL=s?.length==='RL'||s?.tally;
  
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title">${s?'EDIT':'NEW'} SELL</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">Order #</label>
          <input type="text" id="m-orderNum" value="${s?.orderNum||s?.linkedPO||s?.oc||''}" placeholder="e.g. 70123" list="order-list-sell" onchange="onSellOrderChange();updateSellCalc()">
          <datalist id="order-list-sell">${availBuys.map(b=>`<option value="${b.ord}">${b.ord} - ${b.product} ${b.length||'RL'} from ${b.mill} | ${b.avail} MBF avail</option>`).join('')}</datalist>
        </div>
        <div class="form-group"><label class="form-label">Date</label><input type="date" id="m-date" value="${s?.date||today()}"></div>
        <div class="form-group"><label class="form-label">Customer</label><input type="text" id="m-cust" value="${s?.customer||''}" list="cust-list" placeholder="Type or select..." onchange="autoFillDest()"><datalist id="cust-list">${custList.map(c=>`<option value="${c}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">Destination (City, ST)</label><input type="text" id="m-dest" value="${s?.destination||''}" list="dest-list" placeholder="e.g. Cincinnati, OH"><datalist id="dest-list">${dests.map(d=>`<option value="${d}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">Region</label><select id="m-region" onchange="toggleSellOptions()">${REGIONS.map(r=>`<option value="${r}" ${s?.region===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}</select></div>
        <div class="form-group"><label class="form-label">Product</label><input type="text" id="m-product" value="${s?.product||''}" list="prod-list" placeholder="e.g. 2x4#2, 2x6 MSR" onchange="toggleSellOptions()"><datalist id="prod-list">${prodList.map(p=>`<option value="${p}">`).join('')}</datalist></div>
        <div class="form-group"><label class="form-label">Length</label><select id="m-length" onchange="toggleSellOptions()"><option value="">Select...</option><option value="8" ${s?.length==='8'?'selected':''}>8'</option><option value="10" ${s?.length==='10'?'selected':''}>10'</option><option value="12" ${s?.length==='12'?'selected':''}>12'</option><option value="14" ${s?.length==='14'?'selected':''}>14'</option><option value="16" ${s?.length==='16'?'selected':''}>16'</option><option value="18" ${s?.length==='18'?'selected':''}>18'</option><option value="20" ${s?.length==='20'?'selected':''}>20'</option><option value="RL" ${s?.length==='RL'?'selected':''}>RL (Random)</option></select></div>
        <div class="form-group"><label class="form-label">Volume (MBF)</label><input type="number" id="m-volume" value="${s?.volume||''}" onchange="updateSellCalc();calcFlatFreight()"></div>
      </div>
      
      <div id="msr-section-sell" style="margin-top:16px;padding:16px;background:var(--panel-alt);border:1px solid var(--accent);display:${isMSR&&!isRL?'block':'none'}">
        <div style="font-weight:600;color:var(--accent);margin-bottom:12px">MSR/2400 PRICING (Premium over #1)</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Base #1 (from RL)</label><input type="number" id="m-basePrice" value="${s?.basePrice||''}" readonly style="opacity:0.7"></div>
          <div class="form-group"><label class="form-label">Your DLVD Price</label><input type="number" id="m-price" value="${s?.price||''}" placeholder="$/MBF DLVD" onchange="calcSellMSRPremium();updateSellCalc()" onkeyup="calcSellMSRPremium();updateSellCalc()"></div>
          <div class="form-group"><label class="form-label">= Premium (pre-freight)</label><input type="number" id="m-msrPremium" value="${s?.msrPremium||''}" readonly style="font-weight:bold;color:var(--accent)"></div>
        </div>
        <div id="msr-source-sell" style="font-size:10px;color:var(--muted);margin-top:8px"></div>
      </div>
      
      <div id="standard-price-sell" style="margin-top:16px;display:${isMSR||isRL?'none':'block'}">
        <div class="form-group"><label class="form-label">DLVD Price ($/MBF)</label><input type="number" id="m-price-std" value="${s?.price||''}" onchange="updateSellCalc()" onkeyup="updateSellCalc()"></div>
      </div>
      
      <div id="rl-tally-section-sell" style="margin-top:16px;padding:16px;background:var(--panel-alt);border:1px solid var(--warn);display:${isRL?'block':'none'}">
        <div style="font-weight:600;color:var(--warn);margin-bottom:12px">${isMSR?'MSR/2400 RL TALLY (Per-Length with #1 Base)':'RL TALLY (Per-Length Pricing)'}</div>
        <div style="margin-bottom:8px"><label><input type="checkbox" id="m-useTally" ${s?.tally?'checked':''} onchange="toggleSellTally()"> Use per-length tally</label></div>
        <div id="tally-grid-sell" style="display:${s?.tally?'block':'none'}">
          <table style="width:100%;font-size:11px"><thead><tr><th>Length</th><th>MBF</th><th id="tally-price-header-sell">${isMSR?'Your $/MBF':'$/MBF DLVD'}</th><th id="tally-base-header-sell" style="display:${isMSR?'table-cell':'none'}">Base #1</th><th id="tally-prem-header-sell" style="display:${isMSR?'table-cell':'none'}">Premium</th><th>Value</th></tr></thead><tbody>
            ${['8','10','12','14','16','18','20'].map(len=>`<tr>
              <td>${len}'</td>
              <td><input type="number" id="tally-vol-${len}" value="${s?.tally?.[len]?.vol||''}" style="width:60px" onchange="calcSellTallyTotal()"></td>
              <td><input type="number" id="tally-price-${len}" value="${s?.tally?.[len]?.price||''}" style="width:70px" onchange="calcSellTallyTotal()"></td>
              <td id="tally-base-${len}" class="right" style="display:${isMSR?'table-cell':'none'};color:var(--muted)">‚Äî</td>
              <td id="tally-prem-${len}" class="right" style="display:${isMSR?'table-cell':'none'};color:var(--accent)">‚Äî</td>
              <td id="tally-val-${len}" class="right">‚Äî</td>
            </tr>`).join('')}
          </tbody><tfoot><tr style="font-weight:bold;border-top:2px solid var(--border)"><td>Total</td><td id="tally-total-vol">‚Äî</td><td id="tally-avg-price">‚Äî</td><td id="tally-avg-base" style="display:${isMSR?'table-cell':'none'}">‚Äî</td><td id="tally-avg-prem" style="display:${isMSR?'table-cell':'none'}">‚Äî</td><td id="tally-total-val">‚Äî</td></tr></tfoot></table>
        </div>
      </div>
      
      <div style="margin-top:16px;padding:16px;background:var(--panel-alt);border:1px solid var(--border)">
        <div style="font-weight:600;color:var(--warn);margin-bottom:12px">FREIGHT (FLAT RATE PER LOAD)</div>
        <div class="form-grid">
          <div class="form-group"><label class="form-label">Miles</label><div style="display:flex;gap:4px"><input type="number" id="m-miles" value="${s?.miles||''}" style="flex:1" onchange="calcFlatFreight()"><button class="btn btn-default btn-sm" onclick="calcMileage()">üîç</button></div></div>
          <div class="form-group"><label class="form-label">Rate ($/mile)</label><input type="number" id="m-rate" value="${s?.rate||S.flatRate||3.50}" step="0.01" onchange="calcFlatFreight()"></div>
          <div class="form-group"><label class="form-label">Freight ($/load)</label><input type="number" id="m-freight" value="${s?.freight||''}" onchange="updateSellCalc()"></div>
          <div class="form-group"><label class="form-label">$/MBF</label><input type="text" id="m-freightMBF" value="" readonly style="opacity:0.7"></div>
        </div>
        <div id="mileage-status" style="font-size:10px;color:var(--muted);margin-top:8px"></div>
      </div>
      
      <div id="sell-calc" style="margin-top:16px;padding:16px;background:var(--bg);border:1px solid var(--border)"></div>
      <div class="form-group" style="margin-top:12px"><label class="form-label">Notes</label><textarea id="m-notes">${s?.notes||''}</textarea></div>
      <div style="margin-top:12px"><label><input type="checkbox" id="m-delivered" ${s?.delivered?'checked':''}> Delivered</label></div>
    </div>
    <div class="modal-footer"><button class="btn btn-default" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveSell(${s?.id||'null'})">Save</button></div>
  </div></div>`;
  
  toggleSellOptions();
  updateSellCalc();
  calcFlatFreight();
}

function onPOChange(){
  const poNum=document.getElementById('m-linkedPO')?.value;
  if(poNum){
    const buy=S.buys.find(b=>b.po===poNum);
    if(buy){
      if(!document.getElementById('m-product').value)document.getElementById('m-product').value=buy.product||'';
      const lenEl=document.getElementById('m-length');
      if(lenEl&&!lenEl.value)lenEl.value=buy.length||'';
      if(!document.getElementById('m-region')?.value)document.getElementById('m-region').value=buy.region||'west';
      toggleSellOptions();
    }
  }
  updateSellCalc();
}

// Create PO from OC modal - saves the current OC first, then opens buy modal
function createPOFromOC(){
  // First save the current sell
  const product=document.getElementById('m-product')?.value||'';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const useTally=document.getElementById('m-useTally')?.checked;
  
  let price=0;
  if(isMSR||useTally){
    price=parseFloat(document.getElementById('m-price')?.value)||0;
  }else{
    price=parseFloat(document.getElementById('m-price-std')?.value)||0;
  }
  
  let tally=null;
  if(useTally){
    tally={};
    ['8','10','12','14','16','18','20'].forEach(len=>{
      const vol=parseFloat(document.getElementById(`tally-vol-${len}`)?.value)||0;
      const tallyPrice=parseFloat(document.getElementById(`tally-price-${len}`)?.value)||0;
      if(vol>0)tally[len]={vol,price:tallyPrice};
    });
  }
  
  const customer=document.getElementById('m-cust')?.value||'';
  const destination=document.getElementById('m-dest')?.value||'';
  const oc=document.getElementById('m-oc')?.value||'';
  
  if(!oc){alert('Enter OC # first');return}
  if(!product||!price){alert('Enter product and price first');return}
  
  // Save customer to CRM if new
  if(customer&&!S.customers.find(c=>c.name===customer)){
    S.customers.push({name:customer,destination:destination,addedDate:today()});
  }
  
  const s={
    id:genId(),
    oc:oc,
    linkedPO:'', // Will be linked when PO is created
    date:document.getElementById('m-date')?.value||today(),
    customer:customer,
    destination:destination,
    region:document.getElementById('m-region')?.value||'west',
    miles:parseFloat(document.getElementById('m-miles')?.value)||0,
    rate:parseFloat(document.getElementById('m-rate')?.value)||S.flatRate||3.50,
    product:product,
    length:document.getElementById('m-length')?.value||'',
    price:price,
    freight:parseFloat(document.getElementById('m-freight')?.value)||0,
    volume:parseFloat(document.getElementById('m-volume')?.value)||0,
    notes:document.getElementById('m-notes')?.value||'',
    delivered:document.getElementById('m-delivered')?.checked||false,
    basePrice:isMSR?parseFloat(document.getElementById('m-basePrice')?.value)||0:null,
    msrPremium:isMSR?parseFloat(document.getElementById('m-msrPremium')?.value)||0:null,
    tally:tally
  };
  
  S.sells.unshift(s);
  S.pendingOCId=s.id; // Store the sell ID so we can link it when PO is saved
  saveAllLocal();
  
  // Now open buy modal with pre-filled data
  showBuyModal({
    product:s.product,
    length:s.length,
    volume:s.volume,
    region:s.region,
    date:s.date
  });
}

// Create OC from PO modal - saves the current PO first, then opens sell modal linked to it
function createOCFromPO(){
  // First save the current buy
  const product=document.getElementById('m-product')?.value||'';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const useTally=document.getElementById('m-useTally')?.checked;
  
  let price=0;
  if(isMSR){
    price=parseFloat(document.getElementById('m-price')?.value)||0;
  }else{
    price=parseFloat(document.getElementById('m-price-std')?.value)||0;
  }
  
  let tally=null;
  if(useTally){
    tally={};
    ['8','10','12','14','16','18','20'].forEach(len=>{
      const vol=parseFloat(document.getElementById(`tally-vol-${len}`)?.value)||0;
      const tallyPrice=parseFloat(document.getElementById(`tally-price-${len}`)?.value)||0;
      if(vol>0)tally[len]={vol,price:tallyPrice};
    });
  }
  
  const mill=document.getElementById('m-mill')?.value||'';
  const origin=document.getElementById('m-origin')?.value||'';
  const po=document.getElementById('m-po')?.value||'';
  
  if(!po){alert('Enter PO # first');return}
  if(!product||!price){alert('Enter product and price first');return}
  
  // Save mill to CRM if new
  if(mill&&!S.mills.find(m=>m.name===mill)){
    S.mills.push({name:mill,origin:origin,addedDate:today()});
  }
  
  const b={
    id:genId(),
    po:po,
    date:document.getElementById('m-date')?.value||today(),
    mill:mill,
    origin:origin,
    region:document.getElementById('m-region')?.value||'west',
    product:product,
    length:document.getElementById('m-length')?.value||'',
    price:price,
    volume:parseFloat(document.getElementById('m-volume')?.value)||0,
    notes:document.getElementById('m-notes')?.value||'',
    basePrice:isMSR?parseFloat(document.getElementById('m-basePrice')?.value)||0:null,
    msrPremium:isMSR?parseFloat(document.getElementById('m-msrPremium')?.value)||0:null,
    tally:tally
  };
  
  S.buys.unshift(b);
  saveAllLocal();
  
  // Now open sell modal with pre-filled data linked to this PO
  showSellModal({
    linkedPO:po,
    product:b.product,
    length:b.length,
    volume:b.volume,
    region:b.region,
    date:b.date
  });
}

// Common city coordinates for lumber trading (lat, lon)
const CITY_COORDS={
  // Arkansas
  'warren, ar':[33.6126,-92.0646],'monticello, ar':[33.6290,-91.7910],'leola, ar':[34.1723,-92.5879],'dierks, ar':[34.1193,-94.0166],'huttig, ar':[33.0451,-92.1810],
  // Louisiana
  'dequincy, la':[30.4502,-93.4332],'urbana, ar':[33.1404,-92.7596],'leland, ms':[33.4054,-90.8976],
  // Texas
  'dallas, tx':[32.7767,-96.7970],'houston, tx':[29.7604,-95.3698],'austin, tx':[30.2672,-97.7431],
  // Georgia
  'atlanta, ga':[33.7490,-84.3880],'savannah, ga':[32.0809,-81.0912],'macon, ga':[32.8407,-83.6324],
  // Florida
  'jacksonville, fl':[30.3322,-81.6557],'tampa, fl':[27.9506,-82.4572],'orlando, fl':[28.5383,-81.3792],'graceville, fl':[30.9566,-85.5163],'bristol, fl':[30.4313,-84.9755],
  // Tennessee
  'nashville, tn':[36.1627,-86.7816],'memphis, tn':[35.1495,-90.0490],'knoxville, tn':[35.9606,-83.9207],'chattanooga, tn':[35.0456,-85.3097],
  // North Carolina
  'charlotte, nc':[35.2271,-80.8431],'raleigh, nc':[35.7796,-78.6382],
  // South Carolina
  'charleston, sc':[32.7765,-79.9311],'columbia, sc':[34.0007,-81.0348],'georgetown, sc':[33.3768,-79.2945],
  // Alabama
  'birmingham, al':[33.5207,-86.8025],'montgomery, al':[32.3792,-86.3077],'mobile, al':[30.6954,-88.0399],
  // Mississippi
  'jackson, ms':[32.2988,-90.1848],'gulfport, ms':[30.3674,-89.0928],'clarendon, ar':[34.6931,-91.3137],'camden, ar':[33.5843,-92.8343],
  // Ohio
  'cincinnati, oh':[39.1031,-84.5120],'columbus, oh':[39.9612,-82.9988],'cleveland, oh':[41.4993,-81.6944],'dayton, oh':[39.7589,-84.1916],
  // Indiana
  'indianapolis, in':[39.7684,-86.1581],'fort wayne, in':[41.0793,-85.1394],
  // Illinois
  'chicago, il':[41.8781,-87.6298],'springfield, il':[39.7817,-89.6501],
  // Kentucky
  'louisville, ky':[38.2527,-85.7585],'lexington, ky':[38.0406,-84.5037],
  // Missouri
  'st louis, mo':[38.6270,-90.1994],'kansas city, mo':[39.0997,-94.5786],
  // Virginia
  'richmond, va':[37.5407,-77.4360],'norfolk, va':[36.8508,-76.2859],
  // Oklahoma
  'oklahoma city, ok':[35.4676,-97.5164],'tulsa, ok':[36.1540,-95.9928]
};

function calcMileage(){
  const poNum=document.getElementById('m-linkedPO')?.value;
  const buy=poNum?S.buys.find(b=>b.po===poNum):null;
  const origin=(buy?.origin||'').toLowerCase().trim();
  const dest=(document.getElementById('m-dest')?.value||'').toLowerCase().trim();
  const statusEl=document.getElementById('mileage-status');
  
  if(!origin||!dest){
    if(statusEl)statusEl.innerHTML='<span style="color:var(--muted)">Select PO (origin) and enter destination to lookup miles</span>';
    return;
  }
  
  // Try to find coordinates
  const findCoords=(place)=>{
    // Exact match
    if(CITY_COORDS[place])return CITY_COORDS[place];
    // Partial match
    for(const[key,coords] of Object.entries(CITY_COORDS)){
      if(place.includes(key.split(',')[0])||key.includes(place.split(',')[0])){
        return coords;
      }
    }
    return null;
  };
  
  const originCoords=findCoords(origin);
  const destCoords=findCoords(dest);
  
  if(!originCoords||!destCoords){
    if(statusEl)statusEl.innerHTML=`<span style="color:var(--warn)">Location not in database. Enter miles manually or add to CRM.</span>`;
    return;
  }
  
  // Haversine formula
  const R=3959;
  const dLat=(destCoords[0]-originCoords[0])*Math.PI/180;
  const dLon=(destCoords[1]-originCoords[1])*Math.PI/180;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(originCoords[0]*Math.PI/180)*Math.cos(destCoords[0]*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const straightLine=R*c;
  const roadMiles=Math.round(straightLine*1.25); // Road factor ~1.25x straight line
  
  document.getElementById('m-miles').value=roadMiles;
  if(statusEl)statusEl.innerHTML=`<span style="color:var(--positive)">‚úì ${buy?.origin} ‚Üí ${document.getElementById('m-dest')?.value} ‚âà ${roadMiles} mi</span>`;
  calcFlatFreight();
}

function calcFlatFreight(){
  const miles=parseFloat(document.getElementById('m-miles')?.value)||0;
  const rate=parseFloat(document.getElementById('m-rate')?.value)||0;
  const volume=parseFloat(document.getElementById('m-volume')?.value)||0;
  
  if(miles>0&&rate>0){
    const flatFreight=Math.round(miles*rate);
    document.getElementById('m-freight').value=flatFreight;
  }
  
  const freight=parseFloat(document.getElementById('m-freight')?.value)||0;
  if(freight>0&&volume>0){
    document.getElementById('m-freightMBF').value='$'+Math.round(freight/volume)+'/MBF';
  }else{
    document.getElementById('m-freightMBF').value='';
  }
  updateSellCalc();
}

// Buy freight functions (for DLVD buys / covering shorts)
function calcBuyFreight(){
  const miles=parseFloat(document.getElementById('m-miles')?.value)||0;
  const rate=parseFloat(document.getElementById('m-rate')?.value)||S.flatRate||3.50;
  const volume=parseFloat(document.getElementById('m-volume')?.value)||0;
  
  if(miles>0&&rate>0){
    const flatFreight=Math.round(miles*rate);
    document.getElementById('m-freight').value=flatFreight;
  }
  
  const freight=parseFloat(document.getElementById('m-freight')?.value)||0;
  const freightMBFEl=document.getElementById('m-freightMBF');
  if(freightMBFEl){
    if(freight>0&&volume>0){
      freightMBFEl.value='$'+Math.round(freight/volume)+'/MBF';
    }else{
      freightMBFEl.value='';
    }
  }
}

function calcBuyMileage(){
  const origin=document.getElementById('m-origin')?.value?.toLowerCase().trim();
  // For buy mileage, we'd need a destination - for now just show a message
  const statusEl=document.getElementById('buy-mileage-status');
  if(statusEl){
    statusEl.innerHTML='<span style="color:var(--muted)">Enter miles manually or use flat rate √ó miles</span>';
  }
}

function updateSellCalc(){
  const orderNum=document.getElementById('m-orderNum')?.value;
  const product=document.getElementById('m-product')?.value||'';
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const useTally=document.getElementById('m-useTally')?.checked;
  
  // Get price from appropriate field
  let sellPrice;
  if(isMSR||useTally){
    sellPrice=parseFloat(document.getElementById('m-price')?.value)||0;
  }else{
    sellPrice=parseFloat(document.getElementById('m-price-std')?.value)||parseFloat(document.getElementById('m-price')?.value)||0;
  }
  
  const sellFreight=parseFloat(document.getElementById('m-freight')?.value)||0; // flat rate per load
  const volume=parseFloat(document.getElementById('m-volume')?.value)||0;
  const sellFrtPerMBF=volume>0?sellFreight/volume:0;
  const fob=sellPrice-sellFrtPerMBF;
  
  // Find matching buy by orderNum - normalize to string for comparison
  const orderNumStr=String(orderNum||'').trim();
  const buy=orderNumStr?S.buys.find(b=>String(b.orderNum||b.po||'').trim()===orderNumStr):null;
  
  const buyPrice=buy?.price||0;
  const buyFrtPerMBF=buy?.volume>0?(buy?.freight||0)/buy.volume:0;
  const totalCost=buyPrice+buyFrtPerMBF;
  
  const margin=fob-totalCost;
  const totalProfit=margin*volume;
  const marginPct=totalCost>0?(margin/totalCost)*100:0;
  
  const calcDiv=document.getElementById('sell-calc');
  if(!calcDiv)return;
  
  // Also update freight/MBF display
  const freightMBFEl=document.getElementById('m-freightMBF');
  if(freightMBFEl&&volume>0&&sellFreight>0){
    freightMBFEl.value='$'+Math.round(sellFrtPerMBF)+'/MBF';
  }
  
  if(!buy){
    // Short position - no matching buy
    calcDiv.innerHTML=`
      <div style="font-weight:600;color:var(--negative);margin-bottom:12px">‚ö†Ô∏è SHORT POSITION (No matching Buy)</div>
      <table style="width:100%;font-size:11px">
        <tr><td style="color:var(--muted)">Sell Price (DLVD)</td><td class="right accent">${fmt(sellPrice)}/MBF</td></tr>
        <tr><td style="color:var(--muted)">- Freight (${fmt(sellFreight)} √∑ ${volume||'?'} MBF)</td><td class="right warn">${volume>0?fmt(Math.round(sellFrtPerMBF)):'‚Äî'}/MBF</td></tr>
        <tr style="border-top:1px solid var(--border)"><td style="font-weight:600">FOB Price</td><td class="right bold">${volume>0?fmt(Math.round(fob)):'‚Äî'}/MBF</td></tr>
        <tr><td style="font-weight:600">Total Value</td><td class="right bold">${volume>0?fmt(Math.round(fob*volume)):'‚Äî'}</td></tr>
      </table>
      <div style="margin-top:12px;padding:8px;background:rgba(239,68,68,0.1);border:1px solid var(--negative);font-size:10px;color:var(--negative)">
        This is a short sale - create a Buy with the same Order # to match.
      </div>
    `;
    return;
  }
  
  calcDiv.innerHTML=`
    <div style="font-weight:600;color:var(--accent);margin-bottom:12px">PROFIT CALCULATION</div>
    <table style="width:100%;font-size:11px">
      <tr><td style="color:var(--muted)">Buy Price (FOB)</td><td class="right">${fmt(buyPrice)}/MBF</td></tr>
      ${buyFrtPerMBF?`<tr><td style="color:var(--muted)">+ Buy Freight</td><td class="right warn">${fmt(Math.round(buyFrtPerMBF))}/MBF</td></tr>`:''}
      <tr style="border-top:1px solid var(--border)"><td style="font-weight:600">Total Cost</td><td class="right bold">${fmt(Math.round(totalCost))}/MBF</td></tr>
      <tr><td colspan="2" style="height:8px"></td></tr>
      <tr><td style="color:var(--muted)">Sell Price (DLVD)</td><td class="right accent">${fmt(sellPrice)}/MBF</td></tr>
      <tr><td style="color:var(--muted)">- Sell Freight (${fmt(sellFreight)} √∑ ${volume||'?'} MBF)</td><td class="right warn">${volume>0?fmt(Math.round(sellFrtPerMBF)):'‚Äî'}/MBF</td></tr>
      <tr style="border-top:1px solid var(--border)"><td style="font-weight:600">FOB Price</td><td class="right bold">${volume>0?fmt(Math.round(fob)):'‚Äî'}/MBF</td></tr>
      <tr><td colspan="2" style="height:8px"></td></tr>
      <tr style="background:var(--panel)"><td style="font-weight:600">MARGIN</td><td class="right ${margin>=0?'positive':'negative'} bold">${volume>0?fmt(Math.round(margin)):'‚Äî'}/MBF (${marginPct.toFixed(1)}%)</td></tr>
      <tr style="background:var(--panel)"><td style="font-weight:600">TOTAL PROFIT</td><td class="right ${totalProfit>=0?'positive':'negative'} bold">${volume>0?fmt(Math.round(totalProfit)):'‚Äî'}</td></tr>
    </table>
  `;
}

function showRLModal(){
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title">ADD RL DATA</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:20px;max-width:200px"><label class="form-label">Report Date</label><input type="date" id="rl-date"></div>
      ${REGIONS.map(r=>`<div style="margin-bottom:20px"><div style="color:var(--${r==='west'?'accent':r==='central'?'warn':'info'});font-weight:600;margin-bottom:8px;text-transform:uppercase">${r}</div><div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">${['2x4','2x6','2x8','2x10','2x12'].map(s=>`<div class="form-group"><label class="form-label">${s}#2</label><input type="number" id="rl-${r}-${s}"></div>`).join('')}</div></div>`).join('')}
    </div>
    <div class="modal-footer"><button class="btn btn-default" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveRL()">Save</button></div>
  </div></div>`;
}

let parsedRL=null;
function showParseModal(){
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal wide" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title warn">üìÑ IMPORT RANDOM LENGTHS PDF</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <p style="color:var(--muted);margin-bottom:16px">Upload your Random Lengths PDF. Claude will read it directly and extract all SYP prices.</p>
      ${!S.apiKey?'<div style="background:rgba(239,68,68,0.2);border:1px solid var(--negative);padding:12px;margin-bottom:16px;color:var(--negative)">‚ö†Ô∏è Add your Claude API key in Settings first.</div>':''}
      <div style="display:flex;gap:12px;margin-bottom:16px">
        <button class="btn btn-warn" onclick="document.getElementById('pdf-file').click()" ${!S.apiKey?'disabled':''}>üìÅ Choose PDF File</button>
        <input type="file" id="pdf-file" accept=".pdf" style="display:none" onchange="loadPDFDirect(event)">
        <span id="pdf-filename" style="color:var(--muted);align-self:center"></span>
      </div>
      <div id="ai-loading" style="display:none;color:var(--accent);margin-bottom:12px">ü§ñ Claude is reading the PDF and extracting prices... (this may take 10-20 seconds)</div>
      <div id="parse-result"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-default" onclick="closeModal()">Cancel</button><button class="btn btn-primary" id="save-parse-btn" onclick="saveParsedRL()" disabled>Save to Database</button></div>
  </div></div>`;
}

async function loadPDFDirect(event){
  const file=event.target.files[0];
  if(!file)return;
  if(!S.apiKey){alert('Add API key in Settings first');return}
  
  document.getElementById('pdf-filename').textContent=file.name;
  document.getElementById('ai-loading').style.display='block';
  document.getElementById('parse-result').innerHTML='';
  
  try{
    // Convert PDF to base64
    const arrayBuffer=await file.arrayBuffer();
    const base64=btoa(new Uint8Array(arrayBuffer).reduce((data,byte)=>data+String.fromCharCode(byte),''));
    
    const prompt=`This is a Random Lengths lumber price report PDF. Extract ALL Southern Yellow Pine (SYP) prices from these sections:

**PAGE 6 - FRAMING LUMBER, Specified Lengths:**
For EACH region (West, Central, East), extract prices for BOTH grades:
- #1 grade: 2x4#1, 2x6#1, 2x8#1, 2x10#1, 2x12#1 (sometimes labeled as "2x4 #1" or just the first row of each size)
- #2 grade: 2x4#2, 2x6#2, 2x8#2, 2x10#2, 2x12#2 (sometimes labeled as "2x4 #2" or second row)

Extract by length: 8', 10', 12', 14', 16', 18', 20' (and 22', 24' for Central/East if available)

**PAGE 7 - FRAMING LUMBER Composite:**
- Southern Pine column: West, Cent, East prices for 2x4, 2x6, 2x8, 2x10, 2x12
- Also #3 grades if shown: 2x4#3, 2x6#3, etc.

**PAGE 9 - SOUTHERN PINE, KILN DRIED Regional:**
- Timbers: 4x4#2, 4x6, 6x6 by lengths for West and East

Return a JSON object with this structure:
{
  "date": "2026-01-17",
  "specified_lengths": {
    "west": {
      "2x4#1": {"8": 430, "10": 395, "12": 395, "14": 400, "16": 465, "18": 445, "20": 450},
      "2x6#1": {"8": 405, "10": 420, "12": 450, "14": 445, "16": 460, "18": 410, "20": 420},
      "2x8#1": {"8": 360, "10": 365, "12": 375, "14": 350, "16": 390, "18": 345, "20": 355},
      "2x10#1": {"8": 350, "10": 370, "12": 380, "14": 355, "16": 365, "18": 325, "20": 400},
      "2x12#1": {"8": 460, "10": 450, "12": 435, "14": 415, "16": 360, "18": 550, "20": null},
      "2x4#2": {"8": 415, "10": 385, "12": 385, "14": 395, "16": 425, "18": 405, "20": 415},
      "2x6#2": {"8": 390, "10": 415, "12": 430, "14": 430, "16": 440, "18": 395, "20": 385},
      "2x8#2": {"8": 310, "10": 290, "12": 330, "14": 340, "16": 365, "18": 315, "20": 340},
      "2x10#2": {"8": 295, "10": 300, "12": 305, "14": 300, "16": 320, "18": 265, "20": 285},
      "2x12#2": {"8": 370, "10": 410, "12": 430, "14": 375, "16": 395, "18": 315, "20": 375}
    },
    "central": {
      "2x4#1": {"8": 445, "10": 425, "12": 430, "14": 475, "16": 480, "18": 475, "20": 475},
      "2x6#1": {"8": 435, "10": 435, "12": 450, "14": 450, "16": 475, "18": 430, "20": 475},
      "2x8#1": {"8": 405, "10": 400, "12": 425, "14": 390, "16": 400, "18": 405, "20": 415},
      "2x10#1": {"8": 425, "10": 465, "12": 465, "14": 430, "16": 445, "18": 405, "20": 435},
      "2x12#1": {"8": 320, "10": 385, "12": 385, "14": 400, "16": 405, "18": null, "20": null},
      "2x4#2": {"8": 430, "10": 390, "12": 405, "14": 420, "16": 445, "18": 415, "20": 420},
      "2x6#2": {"8": 400, "10": 410, "12": 410, "14": 415, "16": 425, "18": 395, "20": 400},
      "2x8#2": {"8": 320, "10": 385, "12": 385, "14": 385, "16": 400, "18": 405, "20": 415},
      "2x10#2": {"8": 310, "10": 325, "12": 315, "14": 320, "16": 325, "18": 300, "20": 300},
      "2x12#2": {"8": 300, "10": 350, "12": 420, "14": 360, "16": 365, "18": 290, "20": 305}
    },
    "east": {
      "2x4#1": {"8": 490, "10": 455, "12": 445, "14": 525, "16": 550, "18": 460, "20": 500},
      "2x6#1": {"8": 455, "10": 455, "12": 470, "14": 455, "16": 495, "18": 475, "20": 480},
      "2x8#1": {"8": 460, "10": 440, "12": 450, "14": 395, "16": 455, "18": 440, "20": 480},
      "2x10#1": {"8": 520, "10": 505, "12": 480, "14": 375, "16": 480, "18": 485, "20": 575},
      "2x12#1": {"8": 470, "10": 425, "12": 430, "14": 475, "16": 535, "18": 450, "20": null},
      "2x4#2": {"8": 475, "10": 440, "12": 450, "14": 395, "16": 455, "18": 475, "20": null},
      "2x6#2": {"8": 460, "10": 440, "12": 450, "14": 395, "16": 455, "18": 475, "20": 480},
      "2x8#2": {"8": 435, "10": 490, "12": 460, "14": 375, "16": 480, "18": 485, "20": 575},
      "2x10#2": {"8": 520, "10": 505, "12": 480, "14": 375, "16": 480, "18": 485, "20": 575},
      "2x12#2": {"8": 355, "10": 375, "12": 360, "14": 360, "16": 385, "18": 325, "20": 375}
    }
  },
  "composite": {
    "west": {"2x4": 404, "2x6": 428, "2x8": 339, "2x10": 295, "2x12": 389, "2x4#3": 370, "2x6#3": 315},
    "central": {"2x4": 417, "2x6": 410, "2x8": 315, "2x10": 315, "2x12": 350, "2x4#3": 345, "2x6#3": 355},
    "east": {"2x4": 470, "2x6": 458, "2x8": 355, "2x10": 380, "2x12": 400, "2x4#3": 395, "2x6#3": 353}
  },
  "timbers": {
    "west": {
      "4x4#2": {"8": 495, "10": 470, "12": 450, "14": 420, "16": 500},
      "4x6": {"8": 465, "10": null, "12": 495, "14": 445, "16": 465},
      "6x6": {"8": 595, "10": 580, "12": 575, "14": 515, "16": 605}
    },
    "east": {
      "4x4#2": {"8": 490, "10": 475, "12": 435, "14": 410, "16": 495},
      "4x6": {"8": 470, "10": 450, "12": 490, "14": 450, "16": 465},
      "6x6": {"8": 550, "10": 600, "12": 540, "14": 475, "16": 585}
    }
  }
}

IMPORTANT: 
- Extract BOTH #1 AND #2 grades for 2x4, 2x6, 2x8, 2x10, 2x12 in specified_lengths
- In the PDF, #1 is typically the FIRST row for each size, #2 is the SECOND row
- Look carefully at the table headers - they show "#1" and "#2" or "& Btr" for grade 1
- Use null for any missing/blank cells
- Prices shown as ranges like "380-390" should use the midpoint (385)
- The date should be the publication date from the report header
- Return ONLY the JSON object, no other text`;


    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':S.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:4096,
        messages:[{
          role:'user',
          content:[
            {type:'document',source:{type:'base64',media_type:'application/pdf',data:base64}},
            {type:'text',text:prompt}
          ]
        }]
      })
    });
    
    const data=await res.json();
    document.getElementById('ai-loading').style.display='none';
    
    if(data.error){
      document.getElementById('parse-result').innerHTML=`<div class="parsed-preview" style="color:var(--negative)">API Error: ${data.error.message}</div>`;
      return;
    }
    
    const reply=data.content?.[0]?.text||'';
    console.log('AI Response:',reply);
    
    // Extract JSON from response
    const jsonMatch=reply.match(/\{[\s\S]*\}/);
    if(!jsonMatch){
      document.getElementById('parse-result').innerHTML=`<div class="parsed-preview" style="color:var(--negative)">Could not parse AI response:<br><pre style="font-size:10px;margin-top:8px;white-space:pre-wrap">${reply}</pre></div>`;
      return;
    }
    
    parsedRL=JSON.parse(jsonMatch[0]);
    
    // Count prices
    let specCount=0,compCount=0,timbCount=0;
    if(parsedRL.specified_lengths){
      ['west','central','east'].forEach(r=>{
        if(parsedRL.specified_lengths[r]){
          Object.values(parsedRL.specified_lengths[r]).forEach(prod=>{
            specCount+=Object.values(prod).filter(v=>v!==null).length;
          });
        }
      });
    }
    if(parsedRL.composite){
      ['west','central','east'].forEach(r=>{
        if(parsedRL.composite[r])compCount+=Object.values(parsedRL.composite[r]).filter(v=>v!==null).length;
      });
    }
    if(parsedRL.timbers){
      ['west','east'].forEach(r=>{
        if(parsedRL.timbers[r]){
          Object.values(parsedRL.timbers[r]).forEach(prod=>{
            timbCount+=Object.values(prod).filter(v=>v!==null).length;
          });
        }
      });
    }
    
    const totalCount=specCount+compCount+timbCount;
    
    if(totalCount===0){
      document.getElementById('parse-result').innerHTML=`<div class="parsed-preview" style="color:var(--negative)">AI could not find SYP prices.<br><br>Raw response:<pre style="font-size:10px;margin-top:8px;white-space:pre-wrap">${reply}</pre></div>`;
      document.getElementById('save-parse-btn').disabled=true;
      return;
    }
    
    // Build preview
    let preview=`<div class="parsed-preview" style="max-height:400px;overflow:auto">
      <div style="color:var(--positive);margin-bottom:12px">‚úì Found ${totalCount} prices (Specified: ${specCount}, Composite: ${compCount}, Timbers: ${timbCount})</div>
      <div style="margin-bottom:16px"><label class="form-label">Report Date</label><input type="date" id="parsed-date" value="${parsedRL.date||today()}" style="margin-left:8px"></div>`;
    
    // Composite preview
    if(compCount>0){
      preview+=`<div style="font-weight:600;color:var(--accent);margin:12px 0 8px">COMPOSITE PRICES</div>
        <table style="width:100%;font-size:10px;margin-bottom:16px">
        <tr><th>Product</th><th class="right">West</th><th class="right">Central</th><th class="right">East</th></tr>
        ${['2x4','2x6','2x8','2x10','2x12','2x4#3','2x6#3'].map(p=>`<tr><td>${p}</td><td class="right">${parsedRL.composite?.west?.[p]?'$'+parsedRL.composite.west[p]:'‚Äî'}</td><td class="right">${parsedRL.composite?.central?.[p]?'$'+parsedRL.composite.central[p]:'‚Äî'}</td><td class="right">${parsedRL.composite?.east?.[p]?'$'+parsedRL.composite.east[p]:'‚Äî'}</td></tr>`).join('')}
        </table>`;
    }
    
    // Specified lengths preview (abbreviated)
    if(specCount>0){
      preview+=`<div style="font-weight:600;color:var(--warn);margin:12px 0 8px">SPECIFIED LENGTHS (sample - West 2x4#2)</div>`;
      const sample=parsedRL.specified_lengths?.west?.['2x4#2']||parsedRL.specified_lengths?.west?.['2x4']||{};
      preview+=`<table style="width:100%;font-size:10px;margin-bottom:16px">
        <tr>${Object.keys(sample).map(l=>`<th class="right">${l}'</th>`).join('')}</tr>
        <tr>${Object.values(sample).map(v=>`<td class="right">${v?'$'+v:'‚Äî'}</td>`).join('')}</tr>
      </table>`;
    }
    
    // Timbers preview
    if(timbCount>0){
      preview+=`<div style="font-weight:600;color:var(--info);margin:12px 0 8px">TIMBERS (4x4, 4x6, 6x6)</div>
        <div style="color:var(--muted);font-size:10px">West: ${Object.keys(parsedRL.timbers?.west||{}).join(', ')||'None'}</div>
        <div style="color:var(--muted);font-size:10px">East: ${Object.keys(parsedRL.timbers?.east||{}).join(', ')||'None'}</div>`;
    }
    
    preview+=`</div>`;
    
    document.getElementById('parse-result').innerHTML=preview;
    document.getElementById('save-parse-btn').disabled=false;
    
  }catch(err){
    document.getElementById('ai-loading').style.display='none';
    document.getElementById('parse-result').innerHTML=`<div class="parsed-preview" style="color:var(--negative)">Error: ${err.message}<br><br>Try again or check your API key.</div>`;
  }
}

function parseText(){aiParsePDF(document.getElementById('pdf-text')?.value||'')}
async function aiParsePDF(text){if(text)alert('Please use the PDF upload button instead.')}

function saveParsedRL(){
  if(!parsedRL)return;
  parsedRL.date=document.getElementById('parsed-date').value;
  if(!parsedRL.date){alert('Enter a date');return}
  
  // Convert new format to also include simple west/central/east for backward compatibility
  if(parsedRL.composite){
    if(!parsedRL.west)parsedRL.west={};
    if(!parsedRL.central)parsedRL.central={};
    if(!parsedRL.east)parsedRL.east={};
    ['west','central','east'].forEach(r=>{
      if(parsedRL.composite[r]){
        Object.entries(parsedRL.composite[r]).forEach(([k,v])=>{
          if(v!==null){
            // Normalize key format: 2x4 -> 2x4#2, 2x4#3 stays as is
            const key=k.includes('#')?k:k+'#2';
            parsedRL[r][key]=v;
          }
        });
      }
    });
  }
  
  const i=S.rl.findIndex(r=>r.date===parsedRL.date);
  if(i>=0)S.rl[i]=parsedRL;else{S.rl.push(parsedRL);S.rl.sort((a,b)=>new Date(a.date)-new Date(b.date))}
  saveAllLocal();closeModal();render();
}

function showCustModal(c=null){
  const locs=c?.locations||[c?.destination].filter(Boolean);
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title">${c?'EDIT':'NEW'} CUSTOMER</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group full"><label class="form-label">Company Name</label><input type="text" id="m-name" value="${c?.name||''}"></div>
        <div class="form-group"><label class="form-label">Contact</label><input type="text" id="m-contact" value="${c?.contact||''}"></div>
        <div class="form-group"><label class="form-label">Phone</label><input type="text" id="m-phone" value="${c?.phone||''}"></div>
        <div class="form-group"><label class="form-label">Email</label><input type="text" id="m-email" value="${c?.email||''}"></div>
        <div class="form-group full"><label class="form-label">Terms</label><input type="text" id="m-terms" value="${c?.terms||''}"></div>
        <div class="form-group full">
          <label class="form-label">Delivery Locations (City, ST)</label>
          <div id="cust-locations">
            ${locs.length?locs.map((loc,i)=>`<div style="display:flex;gap:4px;margin-bottom:4px"><input type="text" class="cust-loc" value="${loc}" placeholder="e.g. Cincinnati, OH" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button></div>`).join(''):'<div style="display:flex;gap:4px;margin-bottom:4px"><input type="text" class="cust-loc" placeholder="e.g. Cincinnati, OH" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button></div>'}
          </div>
          <button class="btn btn-default btn-sm" onclick="addCustLocation()" style="margin-top:4px">+ Add Location</button>
        </div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-default" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveCust('${c?.name||''}')">Save</button></div>
  </div></div>`;
}

function addCustLocation(){
  const container=document.getElementById('cust-locations');
  const div=document.createElement('div');
  div.style='display:flex;gap:4px;margin-bottom:4px';
  div.innerHTML=`<input type="text" class="cust-loc" placeholder="e.g. Cincinnati, OH" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button>`;
  container.appendChild(div);
}

// CRUD
function saveBuy(id){
  const product=document.getElementById('m-product').value;
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const lengthVal=document.getElementById('m-length').value;
  const isRL=lengthVal==='RL';
  const useTallyCheckbox=document.getElementById('m-useTally')?.checked;
  
  // Build tally and calculate totals
  let tally=null;
  let tallyTotalVol=0;
  let tallyTotalVal=0;
  
  // Check for tally data (if checkbox is checked OR if RL is selected and tally fields have data)
  if(useTallyCheckbox||isRL){
    const tempTally={};
    ['8','10','12','14','16','18','20'].forEach(len=>{
      const vol=parseFloat(document.getElementById(`tally-vol-${len}`)?.value)||0;
      const tallyPrice=parseFloat(document.getElementById(`tally-price-${len}`)?.value)||0;
      if(vol>0&&tallyPrice>0){
        tempTally[len]={vol,price:tallyPrice};
        tallyTotalVol+=vol;
        tallyTotalVal+=vol*tallyPrice;
      }
    });
    if(Object.keys(tempTally).length>0){
      tally=tempTally;
    }
  }
  
  // Get price/volume from appropriate field, or calculate from tally
  let price, volume;
  if(tally&&tallyTotalVol>0){
    // Use tally totals - this takes priority
    price=Math.round(tallyTotalVal/tallyTotalVol);
    volume=tallyTotalVol;
  }else if(isMSR){
    price=parseFloat(document.getElementById('m-price').value)||0;
    volume=parseFloat(document.getElementById('m-volume').value)||0;
  }else{
    price=parseFloat(document.getElementById('m-price-std').value)||0;
    volume=parseFloat(document.getElementById('m-volume').value)||0;
  }
  
  const mill=document.getElementById('m-mill').value;
  const origin=document.getElementById('m-origin').value;
  const orderNum=document.getElementById('m-orderNum').value;
  
  // Save mill to CRM if new
  if(mill&&!S.mills.find(m=>m.name===mill)){
    S.mills.push({name:mill,origin:origin,addedDate:today()});
  }else if(mill&&origin){
    // Update origin if mill exists
    const existingMill=S.mills.find(m=>m.name===mill);
    if(existingMill&&!existingMill.origin){existingMill.origin=origin}
  }
  
  const b={
    orderNum:orderNum,
    po:orderNum, // Keep for backward compatibility
    date:document.getElementById('m-date').value,
    mill:mill,
    origin:origin,
    region:document.getElementById('m-region').value,
    product:product,
    length:document.getElementById('m-length').value,
    price:price,
    volume:volume, // Use calculated volume
    notes:document.getElementById('m-notes').value,
    // Freight fields (for DLVD buys)
    miles:parseFloat(document.getElementById('m-miles')?.value)||0,
    rate:parseFloat(document.getElementById('m-rate')?.value)||S.flatRate||3.50,
    freight:parseFloat(document.getElementById('m-freight')?.value)||0,
    // MSR fields
    basePrice:isMSR?parseFloat(document.getElementById('m-basePrice').value)||0:null,
    msrPremium:isMSR?parseFloat(document.getElementById('m-msrPremium').value)||0:null,
    // Tally
    tally:tally
  };
  
  if(!b.product||!b.price||!b.volume){alert('Fill required fields (product, price, volume)');return}
  if(id){const i=S.buys.findIndex(x=>x.id===id);if(i>=0)S.buys[i]={...b,id}}else{b.id=genId();S.buys.unshift(b)}
  
  saveAllLocal();closeModal();render();
}

function saveSell(id){
  const customer=document.getElementById('m-cust').value;
  const destination=document.getElementById('m-dest').value;
  
  // Save customer to CRM if new
  if(customer&&!S.customers.find(c=>c.name===customer)){
    S.customers.push({name:customer,destination:destination,addedDate:today()});
  }else if(customer&&destination){
    // Update destination if customer exists
    const existing=S.customers.find(c=>c.name===customer);
    if(existing&&!existing.destination){existing.destination=destination}
  }
  
  const product=document.getElementById('m-product').value;
  const isMSR=product.toUpperCase().includes('MSR')||product.toUpperCase().includes('2400');
  const lengthVal=document.getElementById('m-length').value;
  const isRL=lengthVal==='RL';
  const useTallyCheckbox=document.getElementById('m-useTally')?.checked;
  
  // Build tally and calculate totals
  let tally=null;
  let tallyTotalVol=0;
  let tallyTotalVal=0;
  
  // Check for tally data (if checkbox is checked OR if RL is selected and tally fields have data)
  if(useTallyCheckbox||isRL){
    const tempTally={};
    ['8','10','12','14','16','18','20'].forEach(len=>{
      const vol=parseFloat(document.getElementById(`tally-vol-${len}`)?.value)||0;
      const tallyPrice=parseFloat(document.getElementById(`tally-price-${len}`)?.value)||0;
      if(vol>0&&tallyPrice>0){
        tempTally[len]={vol,price:tallyPrice};
        tallyTotalVol+=vol;
        tallyTotalVal+=vol*tallyPrice;
      }
    });
    if(Object.keys(tempTally).length>0){
      tally=tempTally;
    }
  }
  
  // Get price from appropriate field, or calculate from tally
  let price;
  let volume;
  if(tally&&tallyTotalVol>0){
    // Use tally totals - this takes priority
    price=Math.round(tallyTotalVal/tallyTotalVol);
    volume=tallyTotalVol;
  }else if(isMSR){
    price=parseFloat(document.getElementById('m-price').value)||0;
    volume=parseFloat(document.getElementById('m-volume').value)||0;
  }else{
    price=parseFloat(document.getElementById('m-price-std').value)||0;
    volume=parseFloat(document.getElementById('m-volume').value)||0;
  }
  
  const orderNum=document.getElementById('m-orderNum').value;
  
  const s={
    orderNum:orderNum,
    linkedPO:orderNum, // Keep for backward compatibility
    oc:orderNum, // Keep for backward compatibility
    date:document.getElementById('m-date').value,
    customer:customer,
    destination:destination,
    region:document.getElementById('m-region').value,
    miles:parseFloat(document.getElementById('m-miles').value)||0,
    rate:parseFloat(document.getElementById('m-rate').value)||S.flatRate||3.50,
    product:product,
    length:document.getElementById('m-length').value,
    price:price,
    freight:parseFloat(document.getElementById('m-freight').value)||0,
    volume:volume, // Use calculated volume (from tally or field)
    notes:document.getElementById('m-notes').value,
    delivered:document.getElementById('m-delivered')?.checked||false,
    // MSR fields
    basePrice:isMSR?parseFloat(document.getElementById('m-basePrice').value)||0:null,
    msrPremium:isMSR?parseFloat(document.getElementById('m-msrPremium').value)||0:null,
    // Tally
    tally:tally
  };
  
  if(!s.product||!s.price||!s.volume){alert('Fill required fields (product, price, volume)');return}
  // Save rate as default
  S.flatRate=s.rate;
  if(id){const i=S.sells.findIndex(x=>x.id===id);if(i>=0)S.sells[i]={...s,id}}else{s.id=genId();S.sells.unshift(s)}
  saveAllLocal();closeModal();render();
}

function saveRL(){
  const date=document.getElementById('rl-date').value;
  if(!date){alert('Enter date');return}
  const rl={date,west:{},central:{},east:{}};
  REGIONS.forEach(r=>{['2x4','2x6','2x8','2x10','2x12'].forEach(s=>{const v=parseFloat(document.getElementById(`rl-${r}-${s}`).value);if(v)rl[r][`${s}#2`]=v})});
  const i=S.rl.findIndex(r=>r.date===date);
  if(i>=0)S.rl[i]=rl;else{S.rl.push(rl);S.rl.sort((a,b)=>new Date(a.date)-new Date(b.date))}
  saveAllLocal();closeModal();render();
}

function saveCust(name){
  const locations=[...document.querySelectorAll('.cust-loc')].map(el=>el.value.trim()).filter(Boolean);
  const c={name:document.getElementById('m-name').value,contact:document.getElementById('m-contact')?.value||'',phone:document.getElementById('m-phone')?.value||'',email:document.getElementById('m-email')?.value||'',locations:locations,destination:locations[0]||'',terms:document.getElementById('m-terms')?.value||''};
  if(!c.name){alert('Enter name');return}
  const existing=S.customers.findIndex(x=>x.name===name);
  if(existing>=0){S.customers[existing]={...S.customers[existing],...c}}else{S.customers.push(c)}
  saveAllLocal();closeModal();render();
}

function showMillModal(m=null){
  const mill=m?S.mills.find(x=>x.name===m):null;
  const locs=mill?.locations||[mill?.origin].filter(Boolean);
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title positive">${mill?'EDIT':'NEW'} MILL</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Mill Name</label><input type="text" id="m-name" value="${mill?.name||''}"></div>
      <div class="form-group">
        <label class="form-label">Locations (City, ST)</label>
        <div id="mill-locations">
          ${locs.length?locs.map((loc,i)=>`<div style="display:flex;gap:4px;margin-bottom:4px"><input type="text" class="mill-loc" value="${loc}" placeholder="e.g. Warren, AR" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button></div>`).join(''):'<div style="display:flex;gap:4px;margin-bottom:4px"><input type="text" class="mill-loc" placeholder="e.g. Warren, AR" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button></div>'}
        </div>
        <button class="btn btn-default btn-sm" onclick="addMillLocation()" style="margin-top:4px">+ Add Location</button>
      </div>
      <div class="form-group"><label class="form-label">Region</label><select id="m-region"><option value="">Select...</option>${REGIONS.map(r=>`<option value="${r}" ${mill?.region===r?'selected':''}>${r.charAt(0).toUpperCase()+r.slice(1)}</option>`).join('')}</select></div>
      <div class="form-group"><label class="form-label">Contact</label><input type="text" id="m-contact" value="${mill?.contact||''}"></div>
      <div class="form-group"><label class="form-label">Phone</label><input type="text" id="m-phone" value="${mill?.phone||''}"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea id="m-notes">${mill?.notes||''}</textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-default" onclick="closeModal()">Cancel</button><button class="btn btn-success" onclick="saveMill('${mill?.name||''}')">Save</button></div>
  </div></div>`;
}

function addMillLocation(){
  const container=document.getElementById('mill-locations');
  const div=document.createElement('div');
  div.style='display:flex;gap:4px;margin-bottom:4px';
  div.innerHTML=`<input type="text" class="mill-loc" placeholder="e.g. Warren, AR" style="flex:1"><button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">√ó</button>`;
  container.appendChild(div);
}

function saveMill(oldName){
  const locations=[...document.querySelectorAll('.mill-loc')].map(el=>el.value.trim()).filter(Boolean);
  const m={name:document.getElementById('m-name').value,locations:locations,origin:locations[0]||'',region:document.getElementById('m-region').value,contact:document.getElementById('m-contact').value,phone:document.getElementById('m-phone').value,notes:document.getElementById('m-notes').value};
  if(!m.name){alert('Enter name');return}
  const existing=S.mills.findIndex(x=>x.name===oldName);
  if(existing>=0){S.mills[existing]={...S.mills[existing],...m}}else{S.mills.push(m)}
  saveAllLocal();closeModal();render();
}

function editMill(name){showMillModal(name)}
function editCust(name){
  const c=S.customers.find(x=>x.name===name);
  showCustModal(c);
}

function deleteCust(name){
  if(!confirm(`Delete customer "${name}"? This won't delete their trades.`))return;
  S.customers=S.customers.filter(c=>c.name!==name);
  saveAllLocal();render();
}

function deleteMill(name){
  if(!confirm(`Delete mill "${name}"? This won't delete their trades.`))return;
  S.mills=S.mills.filter(m=>m.name!==name);
  saveAllLocal();render();
}

function editBuy(id){showBuyModal(S.buys.find(b=>b.id===id))}
function editSell(id){showSellModal(S.sells.find(s=>s.id===id))}
function dupBuy(id){const b=S.buys.find(x=>x.id===id);if(b)showBuyModal({...b,id:null,date:today()})}
function dupSell(id){const s=S.sells.find(x=>x.id===id);if(s)showSellModal({...s,id:null,date:today()})}
function delBuy(id){if(!confirm('Delete?'))return;S.buys=S.buys.filter(b=>b.id!==id);saveAllLocal();render()}
function delSell(id){if(!confirm('Delete?'))return;S.sells=S.sells.filter(s=>s.id!==id);saveAllLocal();render()}
function delRL(d){if(!confirm('Delete?'))return;S.rl=S.rl.filter(r=>r.date!==d);saveAllLocal();render()}

// Blotter sorting and filtering
function setBlotterFilter(key,val){
  if(!S.blotterFilter)S.blotterFilter={};
  S.blotterFilter[key]=val;
  render();
}
function clearBlotterFilters(){
  S.blotterFilter={};
  render();
}
function toggleSort(col){
  if(!S.blotterSort)S.blotterSort={col:'date',dir:'desc'};
  if(S.blotterSort.col===col){
    S.blotterSort.dir=S.blotterSort.dir==='asc'?'desc':'asc';
  }else{
    S.blotterSort.col=col;
    S.blotterSort.dir='desc';
  }
  render();
}

// Link short OC to PO
function linkShortToPO(sellId){
  const sell=S.sells.find(s=>s.id===sellId);
  if(!sell)return;
  
  // Get available POs that match product
  const availPOs=S.buys.map(b=>{
    const soldVol=S.sells.filter(x=>x.linkedPO===b.po&&x.id!==sellId).reduce((sum,x)=>sum+(x.volume||0),0);
    const avail=(b.volume||0)-soldVol;
    return{...b,soldVol,avail};
  }).filter(b=>b.po&&b.avail>0);
  
  document.getElementById('modal').innerHTML=`<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header"><span class="modal-title warn">LINK SHORT TO PO</span><button class="modal-close" onclick="closeModal()">√ó</button></div>
    <div class="modal-body">
      <div style="margin-bottom:16px;padding:12px;background:var(--panel-alt);border:1px solid var(--border)">
        <div style="font-weight:600;margin-bottom:8px">Short Position:</div>
        <div style="font-size:12px">
          <div><span style="color:var(--muted)">OC:</span> ${sell.oc||'‚Äî'}</div>
          <div><span style="color:var(--muted)">Customer:</span> ${sell.customer||'‚Äî'}</div>
          <div><span style="color:var(--muted)">Product:</span> ${sell.product} ${sell.length||'RL'}</div>
          <div><span style="color:var(--muted)">Volume:</span> ${sell.volume} MBF</div>
          <div><span style="color:var(--muted)">Price:</span> ${fmt(sell.price)} DLVD</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Select PO to Cover</label>
        <select id="link-po" style="width:100%">
          <option value="">‚Äî Select PO ‚Äî</option>
          ${availPOs.map(b=>`<option value="${b.po}">${b.po} | ${b.product} ${b.length||'RL'} | ${b.mill} | ${fmt(b.price)} | ${b.avail} MBF avail</option>`).join('')}
        </select>
      </div>
      ${availPOs.length===0?'<div style="color:var(--negative);font-size:11px;margin-top:8px">No POs with available volume. Create a buy first.</div>':''}
    </div>
    <div class="modal-footer">
      <button class="btn btn-default" onclick="closeModal()">Cancel</button>
      <button class="btn btn-success" onclick="confirmLinkShort(${sellId})" ${availPOs.length===0?'disabled':''}>Link PO</button>
    </div>
  </div></div>`;
}

function confirmLinkShort(sellId){
  const po=document.getElementById('link-po').value;
  if(!po){alert('Select a PO');return}
  const idx=S.sells.findIndex(s=>s.id===sellId);
  if(idx>=0){
    S.sells[idx].linkedPO=po;
    saveAllLocal();
    closeModal();
    render();
  }
}

// AI AGENT with Tool Capabilities
const AI_TOOLS=[
  {name:'create_buy',desc:'Create a buy order',params:['mill','product','price','volume','region','length','shipWeek','notes']},
  {name:'create_sell',desc:'Create a sell order',params:['customer','destination','product','price','freight','volume','length','shipWeek','notes']},
  {name:'add_quote_item',desc:'Add item to quote engine',params:['product','origin','fob','tls','shipWeek']},
  {name:'clear_quote_items',desc:'Clear all items from quote engine',params:[]},
  {name:'generate_quote',desc:'Generate quote for a customer',params:['customerName']},
  {name:'get_inventory',desc:'Get current inventory/position by product',params:[]},
  {name:'get_rl_prices',desc:'Get current Random Lengths prices',params:['region']},
  {name:'get_customers',desc:'List all customers',params:[]},
  {name:'get_mills',desc:'List all mills',params:[]},
  {name:'add_customer',desc:'Add a new customer',params:['name','destination','email']},
  {name:'add_mill',desc:'Add a new mill',params:['name','location','region']},
  {name:'search_trades',desc:'Search buy/sell trades',params:['type','product','customer','mill']},
  {name:'get_lanes',desc:'Get freight lanes and mileage',params:[]},
  {name:'add_lane',desc:'Add a freight lane',params:['origin','dest','miles']},
  {name:'get_analytics',desc:'Get trading analytics summary',params:[]},
  {name:'set_freight_settings',desc:'Set freight calculator settings',params:['freightBase','stateRates','shortHaulFloor']}
];

function executeAITool(name,params){
  console.log('Executing tool:',name,params);
  try{
    switch(name){
      case 'create_buy':{
        const buy={
          id:genId(),
          date:today(),
          mill:params.mill||'',
          product:params.product||'2x4#2',
          price:parseFloat(params.price)||0,
          volume:parseFloat(params.volume)||0,
          region:params.region||'west',
          length:params.length||'RL',
          shipWeek:params.shipWeek||'',
          notes:params.notes||'Created by AI',
          shipped:false
        };
        S.buys.unshift(buy);
        save('buys',S.buys);
        return{success:true,message:`Created buy: ${buy.volume} MBF ${buy.product} from ${buy.mill} @ $${buy.price}`,data:buy};
      }
      case 'create_sell':{
        const sell={
          id:genId(),
          date:today(),
          customer:params.customer||'',
          destination:params.destination||'',
          product:params.product||'2x4#2',
          price:parseFloat(params.price)||0,
          freight:parseFloat(params.freight)||0,
          volume:parseFloat(params.volume)||0,
          length:params.length||'RL',
          shipWeek:params.shipWeek||'',
          notes:params.notes||'Created by AI',
          delivered:false
        };
        S.sells.unshift(sell);
        save('sells',S.sells);
        return{success:true,message:`Created sell: ${sell.volume} MBF ${sell.product} to ${sell.customer} @ $${sell.price} DLVD`,data:sell};
      }
      case 'add_quote_item':{
        const item={
          id:Date.now(),
          product:params.product||'2x4#2',
          origin:params.origin||'',
          fob:parseFloat(params.fob)||0,
          tls:parseInt(params.tls)||1,
          shipWeek:params.shipWeek||'Prompt',
          selected:true
        };
        S.quoteItems.push(item);
        save('quoteItems',S.quoteItems);
        return{success:true,message:`Added to quote: ${item.tls} TL ${item.product} from ${item.origin} @ $${item.fob} FOB`,data:item};
      }
      case 'clear_quote_items':{
        S.quoteItems=[];
        save('quoteItems',S.quoteItems);
        return{success:true,message:'Cleared all quote items'};
      }
      case 'generate_quote':{
        const cust=S.customers.find(c=>c.name.toLowerCase().includes((params.customerName||'').toLowerCase()));
        if(!cust)return{success:false,message:`Customer "${params.customerName}" not found`};
        const items=S.quoteItems.filter(i=>i.selected!==false);
        if(!items.length)return{success:false,message:'No items in quote engine'};
        const dest=(cust.locations||[cust.destination].filter(Boolean))[0]||'TBD';
        const quotes=items.map(item=>{
          const miles=getLaneMiles(item.origin,dest);
          const frt=calcFreightPerMBF(miles,item.origin,item.product?.includes('MSR'));
          return{product:item.product,tls:item.tls,fob:item.fob,freight:frt,dlvd:item.fob+frt,ship:item.shipWeek};
        });
        return{success:true,message:`Quote for ${cust.name} (DLVD ${dest})`,data:quotes};
      }
      case 'get_inventory':{
        const inv={};
        S.buys.forEach(b=>{
          const k=b.product;
          if(!inv[k])inv[k]={bought:0,sold:0};
          inv[k].bought+=b.volume||0;
        });
        S.sells.forEach(s=>{
          const k=s.product;
          if(!inv[k])inv[k]={bought:0,sold:0};
          inv[k].sold+=s.volume||0;
        });
        const positions=Object.entries(inv).map(([p,v])=>({product:p,bought:v.bought,sold:v.sold,net:v.bought-v.sold,position:v.bought-v.sold>0?'LONG':v.bought-v.sold<0?'SHORT':'FLAT'}));
        return{success:true,data:positions};
      }
      case 'get_rl_prices':{
        const rl=S.rl.length?S.rl[S.rl.length-1]:null;
        if(!rl)return{success:false,message:'No RL data available'};
        const region=params.region||'west';
        return{success:true,data:{date:rl.date,region,composites:rl[region],specified_lengths:rl.specified_lengths?.[region]}};
      }
      case 'get_customers':{
        const custs=S.customers.filter(c=>c.type!=='mill').map(c=>({name:c.name,destination:c.destination,locations:c.locations,email:c.email}));
        return{success:true,data:custs};
      }
      case 'get_mills':{
        const mills=S.customers.filter(c=>c.type==='mill').concat(S.mills||[]).map(m=>({name:m.name,location:m.location||m.destination,region:m.region}));
        return{success:true,data:mills};
      }
      case 'add_customer':{
        const cust={id:genId(),name:params.name,destination:params.destination,email:params.email||'',type:'customer',quoteSelected:true,locations:[params.destination].filter(Boolean)};
        S.customers.push(cust);
        save('customers',S.customers);
        return{success:true,message:`Added customer: ${cust.name}`,data:cust};
      }
      case 'add_mill':{
        const mill={id:genId(),name:params.name,location:params.location,region:params.region||'west',type:'mill'};
        S.customers.push(mill);
        save('customers',S.customers);
        return{success:true,message:`Added mill: ${mill.name} (${mill.location})`,data:mill};
      }
      case 'search_trades':{
        let results=[];
        if(params.type==='buy'||!params.type){
          results=results.concat(S.buys.filter(b=>{
            if(params.product&&!b.product?.toLowerCase().includes(params.product.toLowerCase()))return false;
            if(params.mill&&!b.mill?.toLowerCase().includes(params.mill.toLowerCase()))return false;
            return true;
          }).map(b=>({type:'buy',...b})));
        }
        if(params.type==='sell'||!params.type){
          results=results.concat(S.sells.filter(s=>{
            if(params.product&&!s.product?.toLowerCase().includes(params.product.toLowerCase()))return false;
            if(params.customer&&!s.customer?.toLowerCase().includes(params.customer.toLowerCase()))return false;
            return true;
          }).map(s=>({type:'sell',...s})));
        }
        return{success:true,data:results.slice(0,20)};
      }
      case 'get_lanes':{
        return{success:true,data:S.lanes};
      }
      case 'add_lane':{
        const lane={origin:params.origin,dest:params.dest,miles:parseInt(params.miles)||0};
        const existing=S.lanes.findIndex(l=>l.origin===lane.origin&&l.dest===lane.dest);
        if(existing>=0)S.lanes[existing]=lane;
        else S.lanes.push(lane);
        save('lanes',S.lanes);
        return{success:true,message:`Added lane: ${lane.origin} ‚Üí ${lane.dest} (${lane.miles} mi)`,data:lane};
      }
      case 'get_analytics':{
        const a=analytics();
        return{success:true,data:{buyVolume:a.bVol,sellVolume:a.sVol,inventory:a.inv,margin:a.margin,marginPct:a.marginPct,profit:a.profit,avgBuy:a.avgB,avgSell:a.avgS,avgFreight:a.avgFr}};
      }
      case 'set_freight_settings':{
        if(params.freightBase!==undefined){S.freightBase=parseFloat(params.freightBase);save('freightBase',S.freightBase)}
        if(params.shortHaulFloor!==undefined){S.shortHaulFloor=parseFloat(params.shortHaulFloor);save('shortHaulFloor',S.shortHaulFloor)}
        if(params.stateRates){
          Object.entries(params.stateRates).forEach(([st,rate])=>{
            S.stateRates[st]=parseFloat(rate);
          });
          save('stateRates',S.stateRates);
        }
        return{success:true,message:'Freight settings updated',data:{freightBase:S.freightBase,shortHaulFloor:S.shortHaulFloor,stateRates:S.stateRates}};
      }
      default:
        return{success:false,message:`Unknown tool: ${name}`};
    }
  }catch(e){
    return{success:false,message:`Error: ${e.message}`};
  }
}

async function sendAI(){
  if(!S.apiKey){alert('Add API key in Settings');return}
  const inp=document.getElementById('ai-in');
  const msg=inp.value.trim();if(!msg)return;
  S.aiMsgs.push({role:'user',content:msg});inp.value='';render();
  
  const a=analytics();
  const latestRL=S.rl.length?S.rl[S.rl.length-1]:null;
  
  // Build context
  let rlSummary='No RL data available.';
  if(latestRL){
    const prices=[];
    ['west','central','east'].forEach(r=>{
      ['2x4#2','2x6#2','2x8#2'].forEach(p=>{
        if(latestRL[r]?.[p])prices.push(`${r} ${p}: $${latestRL[r][p]}`);
      });
    });
    rlSummary=`Latest RL (${latestRL.date}): ${prices.slice(0,6).join(', ')}`;
  }
  
  // Position summary
  const positions={};
  S.buys.forEach(b=>{const k=b.product;if(!positions[k])positions[k]={b:0,s:0};positions[k].b+=b.volume||0});
  S.sells.forEach(s=>{const k=s.product;if(!positions[k])positions[k]={b:0,s:0};positions[k].s+=s.volume||0});
  const posSummary=Object.entries(positions).filter(([k,v])=>v.b!==v.s).map(([k,v])=>`${k}: ${v.b-v.s>0?'LONG':'SHORT'} ${Math.abs(v.b-v.s)} MBF`).join(', ')||'Flat';
  
  // Customer list
  const custList=S.customers.filter(c=>c.type!=='mill').map(c=>c.name).slice(0,10).join(', ');
  
  // Quote items
  const quoteItems=S.quoteItems.map(i=>`${i.product} from ${i.origin} @ $${i.fob}`).join(', ')||'Empty';

  const toolDefs=AI_TOOLS.map(t=>`- ${t.name}(${t.params.join(', ')}): ${t.desc}`).join('\n');
  
  const ctx=`You are an AI trading assistant for SYP (Southern Yellow Pine) lumber trading at Buckeye Pacific. You can EXECUTE ACTIONS in the app using tools.

AVAILABLE TOOLS:
${toolDefs}

TO USE A TOOL, respond with a JSON block like this:
\`\`\`tool
{"tool":"tool_name","params":{"param1":"value1","param2":"value2"}}
\`\`\`

You can use multiple tools in one response. After each tool block, I'll show you the result.

CURRENT STATE:
- ${rlSummary}
- Positions: ${posSummary}
- Inventory: ${a.inv} MBF, Margin: ${fmt(a.margin)}, Profit: ${fmt(a.profit)}
- Customers: ${custList}
- Quote Engine Items: ${quoteItems}
- Freight: Base $${S.freightBase}/load, Floor $${S.shortHaulFloor}/MBF

When asked to create orders, quotes, or do anything - USE THE TOOLS. Don't just describe what you would do.
Be proactive and actually execute the requested actions.`;

  await runAIWithTools(ctx,msg);
}

async function runAIWithTools(systemCtx,userMsg,depth=0){
  if(depth>5){S.aiMsgs.push({role:'assistant',content:'Max tool depth reached.'});render();return}
  
  const messages=S.aiMsgs.slice(-10).map(m=>({role:m.role,content:m.content}));
  
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':S.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2048,system:systemCtx,messages})
    });
    const data=await res.json();
    let reply=data.content?.[0]?.text||data.error?.message||'Error';
    
    // Check for tool calls
    const toolRegex=/```tool\s*\n?([\s\S]*?)\n?```/g;
    const toolCalls=[];
    let match;
    while((match=toolRegex.exec(reply))!==null){
      try{
        const toolData=JSON.parse(match[1]);
        toolCalls.push(toolData);
      }catch(e){console.error('Tool parse error:',e)}
    }
    
    if(toolCalls.length>0){
      // Execute tools and show results
      const results=[];
      for(const tc of toolCalls){
        const result=executeAITool(tc.tool,tc.params||{});
        results.push({tool:tc.tool,result});
        // Show tool execution in chat
        reply=reply.replace(/```tool[\s\S]*?```/,'');
      }
      
      // Clean up reply and add tool results
      reply=reply.trim();
      const toolResultsText=results.map(r=>`‚úÖ ${r.tool}: ${r.result.message||JSON.stringify(r.result.data).slice(0,200)}`).join('\n');
      
      if(reply)S.aiMsgs.push({role:'assistant',content:reply});
      S.aiMsgs.push({role:'assistant',content:toolResultsText});
      
      // Re-render to show updates
      render();
      
      // Continue conversation if AI might want to do more
      // (commented out to avoid loops - enable if needed)
      // await runAIWithTools(systemCtx,'Tool results: '+JSON.stringify(results),depth+1);
    }else{
      S.aiMsgs.push({role:'assistant',content:reply});
    }
  }catch(e){
    S.aiMsgs.push({role:'assistant',content:'Error: '+e.message});
  }
  
  SS('aiMsgs',S.aiMsgs);
  render();
}

// SETTINGS
function saveKey(){S.apiKey=document.getElementById('api-key').value.trim();SS('apiKey',S.apiKey);alert('Saved!')}
function saveFlatRate(){S.flatRate=parseFloat(document.getElementById('flat-rate').value)||3.50;SS('flatRate',S.flatRate);alert('Flat rate saved: $'+S.flatRate+'/mile')}

// Supabase functions
function saveSupabaseConfig(){
  const url=document.getElementById('sb-url').value.trim();
  const key=document.getElementById('sb-key').value.trim();
  const user=document.getElementById('sb-user').value.trim()||'default';
  
  SS('supabaseUrl',url);
  SS('supabaseKey',key);
  SS('supabaseUserId',user);
  
  if(url&&key){
    initSupabase(url,key);
    alert('Supabase configured! You can now sync to cloud.');
  }else{
    alert('Supabase disabled (URL or key missing)');
  }
  render();
}

async function doCloudSync(action){
  const statusEl=document.getElementById('sync-status');
  if(statusEl)statusEl.innerHTML=`<span style="color:var(--accent)">‚è≥ ${action==='push'?'Pushing':'Pulling'}...</span>`;
  
  const result=await cloudSync(action);
  
  if(result.success){
    if(statusEl)statusEl.innerHTML=`<span style="color:var(--positive)">‚úì ${result.action==='pushed'?'Pushed to cloud':'Pulled from cloud'} at ${new Date().toLocaleTimeString()}</span>`;
    if(action==='pull')render();
  }else{
    if(statusEl)statusEl.innerHTML=`<span style="color:var(--negative)">‚úó Error: ${result.error}</span>`;
  }
}

function toggleAutoSync(){
  S.autoSync=document.getElementById('auto-sync').checked;
  SS('autoSync',S.autoSync);
}

function expCSV(t){
  const d=t==='buys'?S.buys:S.sells;if(!d.length){alert('No data');return}
  const h=t==='buys'?['Date','Mill','Region','Product','Price','Volume','Shipped','Notes']:['Date','Customer','Dest','Product','DLVD','Freight','FOB','Volume','Delivered','Notes'];
  const rows=d.map(x=>t==='buys'?[x.date,x.mill,x.region,x.product,x.price,x.volume,x.shipped?'Y':'N',x.notes]:[x.date,x.customer,x.destination,x.product,x.price,x.freight,x.price-x.freight,x.volume,x.delivered?'Y':'N',x.notes]);
  const csv=[h,...rows].map(r=>r.map(c=>`"${c||''}"`).join(',')).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download=`syp-${t}-${today()}.csv`;a.click();
}
function expAll(){
  const d={
    buys:S.buys,
    sells:S.sells,
    rl:S.rl,
    customers:S.customers,
    mills:S.mills,
    nextId:S.nextId,
    flatRate:S.flatRate,
    // Quote engine data
    lanes:S.lanes,
    quoteItems:S.quoteItems,
    quoteProfiles:S.quoteProfiles,
    quoteProfile:S.quoteProfile,
    marketBlurb:S.marketBlurb,
    stateRates:S.stateRates,
    freightBase:S.freightBase,
    shortHaulFloor:S.shortHaulFloor,
    exportedAt:new Date().toISOString()
  };
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(d,null,2)],{type:'application/json'}));a.download=`syp-backup-${today()}.json`;a.click();
}
async function impData(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=async ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      if(d.buys){S.buys=d.buys}
      if(d.sells){S.sells=d.sells}
      if(d.rl){S.rl=d.rl}
      if(d.customers){S.customers=d.customers}
      if(d.mills){S.mills=d.mills}
      if(d.nextId){S.nextId=d.nextId}
      if(d.flatRate){S.flatRate=d.flatRate}
      // Quote engine data
      if(d.lanes){S.lanes=d.lanes}
      if(d.quoteItems){S.quoteItems=d.quoteItems}
      if(d.quoteProfiles){S.quoteProfiles=d.quoteProfiles}
      if(d.quoteProfile){S.quoteProfile=d.quoteProfile}
      if(d.marketBlurb!==undefined){S.marketBlurb=d.marketBlurb}
      if(d.stateRates){S.stateRates=d.stateRates}
      if(d.freightBase!==undefined){S.freightBase=d.freightBase}
      if(d.shortHaulFloor!==undefined){S.shortHaulFloor=d.shortHaulFloor}
      await saveAllLocal();
      alert('Imported! All data including quote engine settings restored.');
      render();
    }catch(err){alert('Error: '+err.message)}
  };
  r.readAsText(f);e.target.value='';
}
async function clearAll(){
  if(!confirm('Delete ALL data?'))return;
  if(!confirm('Really?'))return;
  S.buys=[];S.sells=[];S.rl=[];S.customers=[];S.mills=[];S.aiMsgs=[];
  S.lanes=[];S.quoteItems=[];S.quoteProfiles={default:{name:'Default',customers:[]}};
  await saveAllLocal();
  SS('aiMsgs',[]);
  render();
}

// INIT
async function init(){
  // Check for password protection
  const appPassword=LS('appPassword','');
  const isLoggedIn=sessionStorage.getItem('syp_logged_in')==='true';
  
  if(appPassword&&!isLoggedIn){
    showLoginScreen();
    return;
  }
  
  await initDB();
  await loadAllLocal();
  
  // Init Supabase if configured
  const sbUrl=LS('supabaseUrl','');
  const sbKey=LS('supabaseKey','');
  if(sbUrl&&sbKey){
    initSupabase(sbUrl,sbKey);
    // Auto-pull on load
    try{
      const result=await cloudSync('pull');
      if(result.success){
        await loadAllLocal(); // Reload with cloud data
        console.log('Cloud sync: pulled latest data');
      }
    }catch(e){
      console.log('Cloud sync failed:',e);
    }
  }
  
  document.getElementById('f-date').onchange=e=>{S.filters.date=e.target.value;render()};
  document.getElementById('f-prod').onchange=e=>{S.filters.prod=e.target.value;render()};
  document.getElementById('f-reg').onchange=e=>{S.filters.reg=e.target.value;render()};
  document.getElementById('f-prod').innerHTML='<option value="all">All Products</option>'+PRODUCTS.map(p=>`<option value="${p}">${p}</option>`).join('');
  render();
  
  // Show sync status
  if(sbUrl&&sbKey){
    showToast('‚òÅÔ∏è Cloud sync active','info');
  }
}

function showLoginScreen(){
  document.getElementById('app').innerHTML=`
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg)">
      <div style="background:var(--panel);border:1px solid var(--border);padding:40px;width:320px;text-align:center">
        <div style="background:linear-gradient(135deg,var(--accent),#00a080);padding:12px;font-weight:700;font-size:16px;color:var(--bg);margin-bottom:24px">SYP ANALYTICS</div>
        <div style="color:var(--muted);font-size:11px;margin-bottom:20px">Buckeye Pacific</div>
        <input type="password" id="login-password" placeholder="Enter password" style="width:100%;padding:12px;margin-bottom:16px;text-align:center" onkeydown="if(event.key==='Enter')doLogin()">
        <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Login</button>
        <div id="login-error" style="color:var(--negative);font-size:11px;margin-top:12px"></div>
      </div>
    </div>`;
  setTimeout(()=>document.getElementById('login-password')?.focus(),100);
}

function doLogin(){
  const input=document.getElementById('login-password')?.value||'';
  const stored=LS('appPassword','');
  
  // Simple hash comparison
  const hash=btoa(input.split('').reverse().join('')+input.length);
  
  if(hash===stored){
    sessionStorage.setItem('syp_logged_in','true');
    location.reload();
  }else{
    document.getElementById('login-error').textContent='Incorrect password';
  }
}

function setAppPassword(pwd){
  if(!pwd){
    SS('appPassword','');
    showToast('Password removed','warn');
  }else{
    const hash=btoa(pwd.split('').reverse().join('')+pwd.length);
    SS('appPassword',hash);
    showToast('Password set! Remember it.','positive');
  }
}

// Mobile navigation functions
function toggleMobileSidebar(){
  const sidebar=document.getElementById('sidebar');
  const overlay=document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('open');
}

function closeMobileSidebar(){
  const sidebar=document.getElementById('sidebar');
  const overlay=document.getElementById('sidebar-overlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('open');
}

function updateMobileNav(){
  // Update active state on mobile nav
  const views=['dashboard','buys','sells','quotes','crm'];
  views.forEach(v=>{
    const el=document.getElementById('mnav-'+v);
    if(el){
      el.classList.toggle('active',S.view===v||(v==='quotes'&&S.view==='quotes'));
    }
  });
}

function showToast(msg,type='info'){
  const toast=document.createElement('div');
  toast.style.cssText=`position:fixed;top:70px;right:20px;padding:12px 20px;background:var(--${type==='positive'?'positive':type==='warn'?'warn':'info'});color:${type==='warn'?'var(--bg)':'#fff'};font-size:11px;z-index:9999;border-radius:4px;animation:fadeIn 0.3s`;
  toast.textContent=msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(),3000);
}

init();
</script>
</body>
</html>